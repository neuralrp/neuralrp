<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeuralRP</title>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' fill='%231e293b'/><text x='50' y='65' font-size='40' text-anchor='middle' fill='%2394a3b8'>*-*</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        [x-cloak] {
            display: none !important;
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        /* Undo Toast Styles */
        .undo-toast {
            animation: slideIn 0.3s ease-out;
            z-index: 9999;
        }

        @keyframes slideIn {
            from {
                transform: translateY(100px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .undo-toast-content {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .undo-icon {
            font-size: 20px;
            font-weight: bold;
        }

        .undo-text {
            font-size: 14px;
            font-weight: 500;
        }

        ::-webkit-scrollbar-track {
            background: #1e293b;
        }

        ::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .character-section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #333;
            border-radius: 8px;
        }

        .character-card.inactive {
            opacity: 0.5;
        }

        .badge {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.8em;
            margin-left: 8px;
        }

        .badge-global {
            background: #4CAF50;
            color: white;
        }

        .badge-npc {
            background: #2196F3;
            color: white;
        }

        .badge-inactive {
            background: #999;
            color: white;
        }

        .badge-promoted {
            background: #FF9800;
            color: white;
        }

        /* Mobile/Touch Optimizations */
        @media (max-width: 768px) {
            .group-hover\:flex {
                display: none;
            }

            button {
                min-height: 44px;
                min-width: 44px;
                padding: 12px 16px;
            }

            .w-80 {
                width: 100%;
                max-width: 320px;
            }

            .rounded-\[24px\] {
                border-radius: 16px;
            }

            .sticky\.bottom-0 {
                position: relative;
                bottom: auto;
            }

            .flex\.gap-1\.mt-2 {
                margin-top: 8px;
                gap: 8px;
            }

            .space-y-8>* {
                margin-bottom: 16px;
            }

            .h-14 {
                height: 56px;
            }

            .p-4 {
                padding: 16px;
            }
        }

        /* Tablet optimizations */
        @media (min-width: 769px) and (max-width: 1024px) {
            .grid-cols-1\.md\:grid-cols-2 {
                grid-template-columns: 1fr;
            }

            .grid-cols-1\.md\:grid-cols-2\.lg\:grid-cols-3 {
                grid-template-columns: 1fr 1fr;
            }
        }

        /* Snapshot Action Buttons */
        .snapshot-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            padding: 8px 12px;
            background: #1e293b;
            border-radius: 6px;
        }

        .snapshot-actions button {
            padding: 8px 12px;
            border: 1px solid #475569;
            background: #334155;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.2s ease;
            min-width: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .snapshot-actions button:hover {
            background: #475569;
            border-color: #64748b;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .snapshot-actions button:active {
            transform: translateY(0);
            box-shadow: none;
        }

        .favorite-btn.active {
            background: #7f1d1d;
            border-color: #ef4444;
            color: #ef4444;
        }

        .favorite-btn.active:hover {
            background: #991b1b;
        }

        .favorite-btn:disabled,
        .regenerate-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Favorite Dropdown Menu */
        .favorite-dropdown {
            position: relative;
            display: inline-block;
        }

        .favorite-menu {
            position: absolute;
            top: 100%;
            left: 0;
            background: #1e293b;
            border: 1px solid #475569;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            min-width: 150px;
            z-index: 1000;
            display: none;
        }

        .favorite-menu:not(.hidden) {
            display: block;
        }

        .favorite-menu.hidden {
            display: none;
        }

        .menu-item {
            padding: 8px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #e2e8f0;
            font-size: 13px;
        }

        .menu-item:hover {
            background: #334155;
        }

        /* Loading State */
        .regenerating {
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Message highlight animation for jump-to-favorite */
        .highlight-message {
            animation: highlight-pulse 3s ease-out;
        }

        @keyframes highlight-pulse {
            0% {
                box-shadow: 0 0 0 4px rgba(236, 72, 153, 0.8), 0 0 20px rgba(236, 72, 153, 0.4);
                transform: scale(1.02);
            }
            50% {
                box-shadow: 0 0 0 2px rgba(236, 72, 153, 0.4), 0 0 10px rgba(236, 72, 153, 0.2);
                transform: scale(1.01);
            }
            100% {
                box-shadow: 0 0 0 0px rgba(236, 72, 153, 0);
                transform: scale(1);
            }
        }
    </style>
</head>

<body class="bg-slate-900 text-slate-100 h-screen overflow-hidden font-sans" x-data="chatUI()" x-init="init()">

    <div class="flex h-full">
        <!-- Sidebar -->
        <div class="w-80 bg-slate-800 border-r border-slate-700 flex flex-col transition-all duration-300"
            :class="showSidebar === 'none' ? '-ml-80' : ''">
            <div class="p-4 border-b border-slate-700 font-bold flex justify-between items-center bg-slate-900/50">
                <span class="text-xs tracking-widest text-slate-400" x-text="showSidebar.toUpperCase()"></span>
                <button @click="showSidebar = 'none'" class="text-slate-400 hover:text-white">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>

            <div class="flex-1 overflow-y-auto p-4 space-y-4">
                <!-- Chats Sidebar -->
                <template x-if="showSidebar === 'chats'">
                    <div class="space-y-4">
                        <div class="flex gap-2">
                            <button @click="saveNewChat()"
                                class="flex-1 bg-green-600 hover:bg-green-500 py-2 rounded-lg text-xs font-bold shadow-lg shadow-green-900/20 transition-all uppercase tracking-widest">Save
                                Session</button>
                            <button @click="fetchChats()"
                                class="bg-slate-700 hover:bg-slate-600 px-3 rounded-lg text-slate-300"
                                title="Refresh List">
                                <i class="fa-solid fa-rotate"></i>
                            </button>
                        </div>

                        <!-- Main Chats -->
                        <div class="space-y-2">
                            <div
                                class="text-[9px] font-black uppercase tracking-widest text-slate-500 border-b border-slate-700 pb-1">
                                Main Timelines</div>
                            <template x-for="chat in savedChats" :key="chat.id">
                                <div class="group flex items-center gap-2 p-3 bg-slate-700/30 hover:bg-slate-700/60 rounded-xl cursor-pointer border border-transparent transition-all"
                                    :class="isBranch(chat.id) ? 'opacity-75' : ''">
                                    <div @click="loadChat(chat.id)" class="flex-1 min-w-0">
                                        <div class="font-bold text-sm truncate"
                                            x-text="chat.branch_name || getDisplayName(chat.id)"></div>
                                        <template x-if="isBranch(chat.id)">
                                            <div class="text-[9px] text-slate-500 truncate"
                                                x-text="'Branch of ' + getBranchOrigin(chat.id)"></div>
                                        </template>
                                    </div>
                                    <div class="flex gap-1">
                                        <button @click="deleteChat(chat.id)"
                                            class="hidden group-hover:flex w-6 h-6 rounded-lg bg-slate-800 hover:bg-red-600 text-white items-center justify-center transition-all">
                                            <i class="fa-solid fa-trash text-[10px]"></i>
                                        </button>
                                    </div>
                                </div>
                            </template>
                        </div>

                        <!-- Branches Section -->
                        <template x-if="currentChatBranches.length > 0">
                            <div class="space-y-2">
                                <div
                                    class="text-[9px] font-black uppercase tracking-widest text-slate-500 border-b border-slate-700 pb-1">
                                    Active Branches</div>
                                <template x-for="branch in currentChatBranches" :key="branch.name">
                                    <div
                                        class="group flex items-center gap-2 p-3 bg-slate-700/30 hover:bg-slate-700/60 rounded-xl cursor-pointer border border-transparent transition-all">
                                        <div @click="loadChat(branch.name)" class="flex-1 min-w-0">
                                            <div class="font-bold text-sm truncate"
                                                x-text="branch.branch_name || branch.name"></div>
                                            <div class="text-[9px] text-slate-500 truncate"
                                                x-text="'Created ' + formatTime(branch.createdat)"></div>
                                        </div>
                                        <div class="flex gap-1">
                                            <button @click="renameBranchDialog(branch)"
                                                class="hidden group-hover:flex w-6 h-6 rounded-lg bg-slate-800 hover:bg-yellow-600 text-white items-center justify-center transition-all"
                                                title="Rename Branch">
                                                <i class="fa-solid fa-pen text-[10px]"></i>
                                            </button>
                                            <button @click="deleteChat(branch.name)"
                                                class="hidden group-hover:flex w-6 h-6 rounded-lg bg-slate-800 hover:bg-red-600 text-white items-center justify-center transition-all">
                                                <i class="fa-solid fa-trash text-[10px]"></i>
                                            </button>
                        </div>
                    </div>
                </template>
            </div>
        </template>
    </div>
</template>

                <!-- Favorites Viewer Sidebar -->
                <template x-if="showSidebar === 'favorites'">
                    <div class="space-y-4">
                        <!-- Source Type Filter -->
                        <div class="flex gap-2">
                            <button @click="setFavoritesSourceType(null)"
                                class="flex-1 px-3 py-2 rounded-lg text-[9px] font-black uppercase tracking-widest transition-all border"
                                :class="favoritesSourceType === null ? 'bg-pink-600 border-pink-500 text-white' : 'bg-slate-900 border-slate-700 text-slate-400 hover:border-pink-500/50'">
                                All
                            </button>
                            <button @click="setFavoritesSourceType('snapshot')"
                                class="flex-1 px-3 py-2 rounded-lg text-[9px] font-black uppercase tracking-widest transition-all border"
                                :class="favoritesSourceType === 'snapshot' ? 'bg-purple-600 border-purple-500 text-white' : 'bg-slate-900 border-slate-700 text-slate-400 hover:border-purple-500/50'">
                                Snapshots
                            </button>
                            <button @click="setFavoritesSourceType('manual')"
                                class="flex-1 px-3 py-2 rounded-lg text-[9px] font-black uppercase tracking-widest transition-all border"
                                :class="favoritesSourceType === 'manual' ? 'bg-blue-600 border-blue-500 text-white' : 'bg-slate-900 border-slate-700 text-slate-400 hover:border-blue-500/50'">
                                Manual
                            </button>
                        </div>

                        <!-- Quick Tag Chips -->
                        <div class="space-y-2">
                            <div class="flex items-center gap-2 flex-wrap">
                                <button @click="clearFavoritesTags()"
                                    class="px-2 py-1 rounded text-[8px] font-black uppercase tracking-widest bg-slate-700 text-slate-400 hover:bg-slate-600 transition-all">
                                    All
                                </button>
                                <template x-for="tag in popularFavoritesTags" :key="tag.tag">
                                    <button @click="toggleFavoritesTag(tag.tag)"
                                        class="px-2 py-1 rounded text-[8px] font-black uppercase tracking-widest transition-all"
                                        :class="favoritesFilterTags.includes(tag.tag) ? 'bg-pink-600 text-white' : 'bg-slate-700 text-slate-400 hover:bg-slate-600'">
                                        <span x-text="tag.tag"></span>
                                        <span class="ml-1 text-slate-300" x-text="'(' + tag.count + ')'"></span>
                                    </button>
                                </template>
                            </div>
                        </div>

                        <!-- Search Bar with Autocomplete -->
                        <div class="relative">
                            <input type="text" x-model="favoritesTagInput" @input="updateFavoritesTagSuggestions()"
                                @keydown.enter="if(favoritesTagSuggestions[0]) applyFavoriteTagFromInput(favoritesTagSuggestions[0])"
                                @keydown.tab.prevent="if(favoritesTagSuggestions[0]) applyFavoriteTagFromInput(favoritesTagSuggestions[0])"
                                class="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-xs outline-none focus:ring-2 focus:ring-pink-500/30"
                                placeholder="Search tags (e.g., blonde, armor, explicit)">
                            <div x-show="favoritesTagSuggestions.length > 0 && favoritesTagInput.length > 0"
                                class="absolute z-10 w-full mt-1 bg-slate-800 border border-slate-700 rounded-lg shadow-xl max-h-60 overflow-y-auto"
                                x-cloak>
                                <template x-for="suggestion in favoritesTagSuggestions.slice(0, 50)" :key="suggestion">
                                    <button @click="applyFavoriteTagFromInput(suggestion)"
                                        class="w-full px-3 py-2 text-left text-xs hover:bg-slate-700 transition-all border-b border-slate-700 last:border-0">
                                        <span x-text="suggestion"></span>
                                    </button>
                                </template>
                                <div x-show="favoritesTagSuggestions.length > 50"
                                    class="px-3 py-1 text-[8px] text-slate-500 text-center border-b border-slate-700">
                                    Showing first 50 of <span x-text="favoritesTagSuggestions.length"></span> matches
                                </div>
                            </div>
                        </div>

                        <!-- Active Filters Display -->
                        <div x-show="favoritesFilterTags.length > 0" class="space-y-2" x-cloak>
                            <div class="text-[8px] text-slate-500 uppercase font-bold">Active filters:</div>
                            <div class="flex flex-wrap gap-1.5">
                                <template x-for="tag in favoritesFilterTags" :key="tag">
                                    <div class="flex items-center gap-1 px-2 py-1 rounded bg-pink-900/30 border border-pink-500/30">
                                        <span class="text-[9px] text-pink-300" x-text="tag"></span>
                                        <button @click="toggleFavoritesTag(tag)" class="text-pink-400 hover:text-pink-300">
                                            <i class="fa-solid fa-xmark text-[8px]"></i>
                                        </button>
                                    </div>
                                </template>
                                <button @click="clearFavoritesTags()" class="text-[9px] text-slate-400 hover:text-pink-400 underline">
                                    Clear all
                                </button>
                            </div>
                        </div>

                        <!-- Favorites Grid -->
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
                            <template x-for="fav in favorites" :key="fav.id">
                                <div class="group relative bg-slate-900/50 rounded-lg overflow-hidden border border-slate-700/50 hover:border-pink-500/50 transition-all">
                                    <!-- Image -->
                                    <div class="aspect-square bg-slate-900/50 relative cursor-pointer"
                                        @dblclick="jumpToFavoriteSource(fav)"
                                        title="Double-click to view in chat">
                                        <img :src="'/images/' + fav.image_filename" loading="lazy"
                                            class="w-full h-full object-cover pointer-events-none">
                                        <!-- Double-click hint overlay -->
                                        <div class="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition-all flex items-center justify-center pointer-events-none">
                                            <div class="text-center">
                                                <i class="fa-solid fa-comments text-2xl text-white mb-2"></i>
                                                <div class="text-[10px] text-white font-bold uppercase tracking-widest">Double-click to view</div>
                                            </div>
                                        </div>
                                        <!-- Source Badge -->
                                        <div class="absolute top-2 left-2 px-2 py-0.5 rounded text-[8px] font-black uppercase tracking-widest"
                                            :class="fav.source_type === 'snapshot' ? 'bg-purple-600 text-white' : 'bg-blue-600 text-white'"
                                            x-text="fav.source_type === 'snapshot' ? 'Snapshot' : 'Manual'">
                                        </div>
                                        <!-- Delete Button -->
                                        <button @click="deleteFavorite(fav.id)"
                                            class="absolute top-2 right-2 w-6 h-6 bg-red-600 rounded flex items-center justify-center text-white text-xs opacity-0 group-hover:opacity-100 transition-all hover:bg-red-500">
                                            <i class="fa-solid fa-trash"></i>
                                        </button>
                                    </div>
                                    <!-- Tags Display -->
                                    <div class="p-2" :class="favoritesFilterTags.length > 0 ? 'opacity-50' : ''">
                                        <div class="flex flex-wrap gap-1">
                                            <template x-for="(tag, index) in parseFavoriteTags(fav.tags).slice(0, 4)" :key="index">
                                                <span class="px-1.5 py-0.5 rounded bg-slate-700 text-[8px] text-slate-300"
                                                    x-text="tag"></span>
                                            </template>
                                            <span x-show="parseFavoriteTags(fav.tags).length > 4"
                                                class="px-1.5 py-0.5 rounded bg-slate-700 text-[8px] text-slate-400"
                                                x-text="'+' + (parseFavoriteTags(fav.tags).length - 4)">
                                            </span>
                                        </div>
                                    </div>
                                    <!-- Metadata Row -->
                                    <div class="px-2 pb-2 flex items-center justify-between">
                                        <span class="text-[8px] text-slate-500"
                                            x-text="new Date(fav.created_at * 1000).toLocaleDateString()"></span>
                                        <span x-show="fav.note" class="text-[8px] text-slate-400 truncate max-w-[120px]"
                                            x-text="fav.note"></span>
                                    </div>
                                </div>
                            </template>
                        </div>

                        <!-- Empty State -->
                        <div x-show="favorites.length === 0 && !isLoadingFavorites" class="text-center py-12 space-y-3" x-cloak>
                            <div class="text-6xl text-slate-600 opacity-50">
                                <i class="fa-solid fa-heart"></i>
                            </div>
                            <div class="text-sm text-slate-500 font-medium">No favorites yet</div>
                            <div class="text-xs text-slate-600">
                                Click heart icon on images to add to favorites
                            </div>
                        </div>

                        <!-- Loading State -->
                        <div x-show="isLoadingFavorites" class="text-center py-12 space-y-3" x-cloak>
                            <div class="text-4xl text-pink-500">
                                <i class="fa-solid fa-circle-notch fa-spin"></i>
                            </div>
                            <div class="text-sm text-slate-500">Loading favorites...</div>
                        </div>

                        <!-- Load More Button -->
                        <button x-show="favorites.length >= favoritesLimit && favorites.length % favoritesLimit === 0"
                            @click="loadMoreFavorites()" :disabled="isLoadingFavorites"
                            class="w-full py-3 rounded-lg text-xs font-black uppercase tracking-widest transition-all border"
                            :class="isLoadingFavorites ? 'bg-slate-700 border-slate-600 text-slate-500 cursor-not-allowed' : 'bg-pink-600 border-pink-500 text-white hover:bg-pink-500'"
                            x-cloak>
                            <template x-if="!isLoadingFavorites">
                                <span>Load More</span>
                            </template>
                            <template x-if="isLoadingFavorites">
                                <span class="flex items-center justify-center gap-2">
                                    <i class="fa-solid fa-circle-notch fa-spin"></i>
                                    Loading...
                                </span>
                            </template>
                        </button>
                    </div>
                </template>

                <!-- Character Sidebar -->
                <template x-if="showSidebar === 'characters'">
                    <div class="space-y-4">
                        <div class="flex gap-2">
                            <button @click="openCardGen()"
                                class="flex-1 bg-blue-600 hover:bg-blue-500 py-2 rounded-lg text-xs font-black uppercase tracking-widest transition-all">New
                                Character</button>
                            <button @click="reimportAndRefreshCharacters()"
                                class="bg-slate-700 hover:bg-slate-600 px-3 rounded-lg text-slate-300"
                                :class="isReimporting ? 'animate-spin' : ''"
                                title="Refresh List (imports new JSON files)">
                                <i class="fa-solid fa-rotate"></i>
                            </button>
                        </div>

                        <!-- Character Editing Interface -->
                        <template x-if="editingChar">
                            <div class="bg-slate-900 p-3 rounded-xl border border-slate-700 space-y-3 shadow-xl">
                                <!-- Character Header -->
                                <div class="flex justify-between items-center">
                                    <div class="flex items-center gap-3">
                                        <input x-model="editingChar.data.name"
                                            class="bg-slate-800 border border-slate-700 rounded-lg px-2 py-1.5 text-sm outline-none focus:ring-1 focus:ring-blue-500"
                                            placeholder="Name">
                                        <span class="text-[10px] text-slate-500">Editing: <span
                                                x-text="editingChar._filename || 'New Character'"></span></span>
                                    </div>
                                </div>

                                <!-- Basic Fields -->
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                    <div>
                                        <label class="text-[9px] text-slate-500 font-black uppercase">Label
                                            Description</label>
                                        <textarea x-model="editingChar.data.extensions.label_description"
                                            class="w-full bg-slate-800 border border-slate-700 rounded-lg px-2 py-1.5 text-[10px] h-12 outline-none focus:ring-1 focus:ring-blue-500"
                                            placeholder="Personal notes..."></textarea>
                                    </div>
                                    <div>
                                        <label class="text-[9px] text-slate-500 font-black uppercase">Danbooru
                                            Tag</label>
                                        <input x-model="editingChar.data.extensions.danbooru_tag"
                                            class="w-full bg-slate-800 border border-slate-700 rounded-lg px-2 py-1.5 text-[10px] outline-none focus:ring-1 focus:ring-blue-500"
                                            placeholder="e.g. 1girl, blond hair...">
                                    </div>
                                </div>

                                <!-- Gender Toggle -->
                                <div class="mt-3">
                                    <label class="text-[9px] text-slate-500 font-black uppercase">Gender</label>
                                    <div class="flex gap-2 mt-1">
                                        <button @click="editingChar.data.extensions.gender = 'female'"
                                            :class="editingChar.data.extensions.gender === 'female' ? 'bg-pink-600 border-pink-500 text-white' : 'bg-slate-800 border-slate-700 text-slate-400 hover:bg-slate-700'"
                                            class="flex-1 py-1.5 px-2 rounded-lg text-[10px] font-bold uppercase border transition-all">
                                            Female
                                        </button>
                                        <button @click="editingChar.data.extensions.gender = 'male'"
                                            :class="editingChar.data.extensions.gender === 'male' ? 'bg-blue-600 border-blue-500 text-white' : 'bg-slate-800 border-slate-700 text-slate-400 hover:bg-slate-700'"
                                            class="flex-1 py-1.5 px-2 rounded-lg text-[10px] font-bold uppercase border transition-all">
                                            Male
                                        </button>
                                        <button @click="editingChar.data.extensions.gender = 'other'"
                                            :class="editingChar.data.extensions.gender === 'other' ? 'bg-purple-600 border-purple-500 text-white' : 'bg-slate-800 border-slate-700 text-slate-400 hover:bg-slate-700'"
                                            class="flex-1 py-1.5 px-2 rounded-lg text-[10px] font-bold uppercase border transition-all">
                                            Other
                                        </button>
                                    </div>
                                </div>

                                <!-- Danbooru Tag Generator -->
                                <div class="mt-3" x-show="editingChar.data.extensions.gender">
                                    <div class="flex items-center justify-between">
                                        <button 
                                            @click="generateDanbooruTags()"
                                            :disabled="isGeneratingDanbooruTags"
                                            class="text-[9px] text-cyan-400 hover:text-cyan-300 font-bold uppercase tracking-wide transition-colors disabled:opacity-50"
                                        >
                                            <span x-show="!isGeneratingDanbooruTags">
                                                <i class="fa-solid fa-wand-magic-sparkles mr-1"></i>
                                                Generate Danbooru Character (Visual Canon)
                                            </span>
                                            <span x-show="isGeneratingDanbooruTags">
                                                <i class="fa-solid fa-circle-notch fa-spin mr-1"></i>
                                                Searching...
                                            </span>
                                        </button>
                                        <span x-show="editingChar.data.extensions.danbooru_tag" 
                                              x-text="'✓ Generated'"
                                              class="text-[8px] text-green-400"></span>
                                    </div>
                                    <div class="text-[8px] text-slate-500 mt-1">
                                        Tip: Include hair color, eye color, hair style, and body type for Danbooru tag matching.
                                    </div>
                                </div>

                                <!-- Character Fields -->
                                <div class="border-t border-slate-700 pt-3 space-y-3">
                                    <!-- Personality -->
                                    <div class="space-y-1.5">
                                        <div class="flex justify-between items-center">
                                            <label
                                                class="text-[9px] text-slate-500 uppercase font-black tracking-widest">Personality
                                                (PList)</label>
                                            <button @click="editFieldAI('personality')"
                                                class="text-[8px] text-blue-400 hover:text-blue-300 font-bold uppercase"
                                                :disabled="isEditingField">
                                                <i class="fa-solid mr-1"
                                                    :class="isEditingField && isEditingField.personality ? 'fa-circle-notch fa-spin' : 'fa-wand-magic-sparkles'"></i>Gen
                                            </button>
                                        </div>
                                        <textarea x-model="editingChar.data.personality"
                                            class="w-full bg-slate-950 border border-slate-700 rounded-xl p-3 text-xs h-20 outline-none focus:ring-1 focus:ring-blue-500/50 resize-none font-mono"
                                            placeholder="Personality traits in PList format..."></textarea>
                                    </div>

                                    <!-- Body -->
                                    <div class="space-y-1.5">
                                        <div class="flex justify-between items-center">
                                            <label
                                                class="text-[9px] text-slate-500 uppercase font-black tracking-widest">Physical
                                                Body (PList)</label>
                                            <button @click="editFieldAI('body')"
                                                class="text-[8px] text-blue-400 hover:text-blue-300 font-bold uppercase"
                                                :disabled="isEditingField">
                                                <i class="fa-solid mr-1"
                                                    :class="isEditingField && isEditingField.body ? 'fa-circle-notch fa-spin' : 'fa-wand-magic-sparkles'"></i>Gen
                                            </button>
                                        </div>
                                        <textarea x-model="editingChar.data.description"
                                            class="w-full bg-slate-950 border border-slate-700 rounded-xl p-3 text-xs h-20 outline-none focus:ring-1 focus:ring-blue-500/50 resize-none font-mono"
                                            placeholder="Physical appearance..."></textarea>
                                    </div>

                                    <!-- Genre & Tags -->
                                    <div class="space-y-1.5">
                                        <div class="flex justify-between items-center">
                                            <label
                                                class="text-[9px] text-slate-500 uppercase font-black tracking-widest">Genre
                                                & Tags</label>
                                            <button @click="editFieldAI('genre'); editFieldAI('tags')"
                                                class="text-[8px] text-blue-400 hover:text-blue-300 font-bold uppercase"
                                                :disabled="isEditingField">
                                                <i class="fa-solid mr-1"
                                                    :class="isEditingField && (isEditingField.genre || isEditingField.tags) ? 'fa-circle-notch fa-spin' : 'fa-wand-magic-sparkles'"></i>Gen
                                            </button>
                                        </div>
                                         <div class="flex gap-2">
                                            <input x-model="editingChar.data.extensions.genre"
                                                class="w-1/3 bg-slate-950 border border-slate-700 rounded-xl px-3 py-2 text-xs outline-none focus:ring-1 focus:ring-blue-500/50"
                                                placeholder="Genre">
                                            
                                            <!-- Tag Editor (chips + input with autocomplete) -->
                                            <div class="w-2/3 space-y-2">
                                                <label class="text-[9px] text-slate-500 font-black uppercase">Tags</label>
                                                
                                                <!-- Current tags as chips -->
                                                <div class="flex flex-wrap gap-2 mb-2">
                                                    <template x-for="tag in editingTags" :key="tag">
                                                        <span class="px-2 py-1 bg-purple-600/30 border border-purple-600/50 rounded text-[10px] text-purple-300 flex items-center gap-1">
                                                            <span x-text="tag"></span>
                                                            <button @click="removeEditTag(tag)" class="text-purple-400 hover:text-purple-200">×</button>
                                                        </span>
                                                    </template>
                                                </div>
                                                
                                                <!-- Input with autocomplete -->
                                                <div class="relative">
                                                    <input x-model="tagInput"
                                                           @keydown.enter="addEditTag()"
                                                           @keydown.tab.prevent="addEditTag()"
                                                           class="w-full bg-slate-950 border border-slate-700 rounded-xl px-3 py-2 text-xs outline-none focus:ring-1 focus:ring-purple-500"
                                                           placeholder="Type tag and press Enter">
                                                    
                                                    <!-- Autocomplete suggestions -->
                                                    <div x-show="tagSuggestions.length > 0 && tagInput.length > 0"
                                                         class="absolute top-full left-0 right-0 mt-1 bg-slate-800 border border-slate-700 rounded-lg shadow-xl max-h-40 overflow-y-auto z-50">
                                                        <template x-for="suggestion in tagSuggestions" :key="suggestion">
                                                            <button @click="tagInput = suggestion; addEditTag()"
                                                                    class="w-full text-left px-3 py-1 text-xs hover:bg-slate-700"
                                                                    x-text="suggestion">
                                                            </button>
                                                        </template>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Scenario -->
                                    <div class="space-y-1.5">
                                        <div class="flex justify-between items-center">
                                            <label
                                                class="text-[9px] text-slate-500 uppercase font-black tracking-widest">Scenario</label>
                                            <button @click="editFieldAI('scenario')"
                                                class="text-[8px] text-blue-400 hover:text-blue-300 font-bold uppercase"
                                                :disabled="isEditingField">
                                                <i class="fa-solid mr-1"
                                                    :class="isEditingField && isEditingField.scenario ? 'fa-circle-notch fa-spin' : 'fa-wand-magic-sparkles'"></i>Gen
                                            </button>
                                        </div>
                                        <input x-model="editingChar.data.scenario"
                                            class="w-full bg-slate-950 border border-slate-700 rounded-xl px-3 py-2 text-xs outline-none focus:ring-1 focus:ring-blue-500/50"
                                            placeholder="One sentence situation">
                                    </div>

                                    <!-- First Message -->
                                    <div class="space-y-1.5">
                                        <div class="flex justify-between items-center">
                                            <label
                                                class="text-[9px] text-slate-500 uppercase font-black tracking-widest">First
                                                Message</label>
                                            <button @click="editFieldAI('first_message')"
                                                class="text-[8px] text-blue-400 hover:text-blue-300 font-bold uppercase"
                                                :disabled="isEditingField">
                                                <i class="fa-solid mr-1"
                                                    :class="isEditingField && isEditingField.first_message ? 'fa-circle-notch fa-spin' : 'fa-wand-magic-sparkles'"></i>Gen
                                            </button>
                                        </div>
                                        <textarea x-model="editingChar.data.first_mes"
                                            class="w-full bg-slate-950 border border-slate-700 rounded-xl p-3 text-xs h-24 outline-none focus:ring-1 focus:ring-blue-500/50 resize-none font-medium"
                                            placeholder="Character's opening line..."></textarea>
                                    </div>
                                </div>

                                <!-- Example Dialog -->
                                <div class="space-y-1.5">
                                    <div class="flex justify-between items-center">
                                        <label class="text-[9px] text-slate-500 uppercase font-black tracking-widest">Example Dialog</label>
                                        <button @click="editFieldAI('mes_example')"
                                            class="text-[8px] text-blue-400 hover:text-blue-300 font-bold uppercase"
                                            :disabled="isEditingField">
                                            <i class="fa-solid mr-1"
                                                :class="isEditingField && isEditingField.mes_example ? 'fa-circle-notch fa-spin' : 'fa-wand-magic-sparkles'"></i>Gen
                                        </button>
                                    </div>
                                    <textarea x-model="editingChar.data.mes_example"
                                        class="w-full bg-slate-950 border border-slate-700 rounded-xl p-3 text-xs h-32 outline-none focus:ring-1 focus:ring-blue-500/50 font-mono"
                                        placeholder="Example dialogue showing character's voice..."></textarea>
                                </div>

                                <!-- Fixed Save/Cancel Buttons -->
                                <div
                                    class="sticky bottom-0 bg-slate-900 border-t border-slate-700 p-3 -mx-3 -mb-3 rounded-b-xl">
                                    <div class="flex gap-2 justify-end">
                                        <button @click="saveCharacter()"
                                            class="bg-green-600 hover:bg-green-500 text-white px-4 py-2 rounded-lg text-xs font-black uppercase shadow-lg shadow-green-900/20 transition-all">Save</button>
                                        <button @click="editingChar = null"
                                            class="bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded-lg text-xs font-black uppercase transition-all">Cancel</button>
                                    </div>
                                </div>
                            </div>
                        </template>
 
                        <!-- Tag Filter Bar -->
                        <div x-show="showSidebar === 'characters'" class="space-y-3">
                            <div class="flex gap-2 overflow-x-auto pb-2">
                                <button @click="filterTags = []; fetchCharacters()"
                                        :class="filterTags.length === 0 ? 'bg-blue-600' : 'bg-slate-700'"
                                        class="px-3 py-1 rounded-full text-xs whitespace-nowrap hover:opacity-90 transition-all">
                                    All
                                </button>
                                <template x-for="tag in popularCharacterTags" :key="tag.tag">
                                    <button @click="toggleFilterTag(tag.tag)"
                                            :class="filterTags.includes(tag.tag) ? 'bg-orange-600' : 'bg-slate-700'"
                                            class="px-3 py-1 rounded-full text-xs whitespace-nowrap hover:opacity-90 transition-all"
                                            x-text="tag.tag + ' (' + tag.count + ')'">
                                    </button>
                                </template>
                                <select @change="addFilterTag($event.target.value)"
                                        class="bg-slate-700 border border-slate-600 rounded px-2 py-1 text-xs outline-none focus:ring-1 focus:ring-blue-500">
                                    <option value="">More tags...</option>
                                    <template x-for="tag in allCharacterTags" :key="tag">
                                        <option :value="tag" x-text="tag"></option>
                                    </template>
                                </select>
                            </div>
                        </div>
 
                        <!-- Unified Character List -->
                        <div class="space-y-2">
                            <template x-for="item in allCharacters()"
                                :key="item.type + '_' + (item.type === 'global' ? (item.char?._filename || 'unknown') : (item.npc?.entity_id || 'unknown'))"
                                x-cloak>
                                <!-- Character Card -->
                                <div class="p-3 bg-slate-700/30 hover:bg-slate-700/60 rounded-xl cursor-pointer border border-transparent hover:border-slate-600 group flex justify-between items-center transition-all character-card"
                                    :class="{ 
                                     'inactive': item.type === 'npc' && !(item.npc?.isactive), 
                                     'border-blue-500/50 bg-blue-500/10': item.type === 'global' && isCharacterActive(item.char) 
                                 }"
                                    @click="item.type === 'global'
                                    ? toggleCharacter(item.char)
                                    : toggleNPCActive(currentChatId, item.npc.entityid)"


                                    <div class="flex flex-col flex-1 min-w-0">
                                        <div class="flex items-center gap-2 mb-1">
                                            <!-- Active indicator for global characters -->
                                            <div x-show="item.type === 'global' && isCharacterActive(item.char)"
                                                class="w-1.5 h-1.5 rounded-full bg-blue-500 shadow-[0_0_5px_rgba(59,130,246,0.8)]">
                                            </div>
                                            <!-- Active indicator for NPCs -->
                                            <div x-show="item.type === 'npc' && activeCharacters.includes(item.npc?.entity_id)"
                                                class="w-1.5 h-1.5 rounded-full bg-green-500 shadow-[0_0_5px_rgba(34,197,94,0.8)]">
                                            </div>

                                            <span class="font-bold text-sm"
                                                x-text="item.type === 'global' ? (item.char?.data?.name || 'Unknown') : (item.npc?.name || item.npc?.data?.name || 'Unknown')"></span>

                                            <!-- Badges -->
                                            <div class="flex gap-1 flex-wrap">
                                                <span x-show="item.type === 'global'"
                                                    class="badge badge-global bg-green-600 text-white px-2 py-0.5 rounded text-[10px] font-bold">Global</span>
                                                <span x-show="item.type === 'npc'"
                                                    class="badge badge-npc bg-gray-600 text-white px-2 py-0.5 rounded text-[10px] font-bold">NPC</span>
                                                <span x-show="item.type === 'npc' && item.npc?.isactive === false"
                                                    class="badge badge-inactive bg-gray-500 text-white px-2 py-0.5 rounded text-[10px] font-bold">Inactive</span>
                                                <span x-show="item.type === 'npc' && item.npc?.promoted"
                                                    class="badge badge-promoted bg-orange-600 text-white px-2 py-0.5 rounded text-[10px] font-bold">Promoted</span>
                                                <span
                                                    x-show="item.type === 'global' && item.char?.data?.extensions?.promotion_history"
                                                    class="badge badge-promoted bg-orange-600 text-white px-2 py-0.5 rounded text-[10px] font-bold">Promoted</span>
                                            </div>
                                        </div>

                                        <!-- Description -->
                                        <span class="text-[10px] text-slate-500 truncate"
                                            x-text="item.type === 'global' ? (item.char?.data?.extensions?.label_description || item.char?.data?.description || 'No description') : (item.npc?.data?.description || item.npc?.description || 'No description')"></span>

                                        <!-- Promotion history details -->
                                        <div x-show="item.type === 'global' && item.char?.data?.extensions?.promotion_history"
                                            class="promotion-info mt-2 bg-orange-900/20 border border-orange-600/50 rounded-lg p-3">
                                            <div class="meta text-xs text-slate-300 mb-1">
                                                <strong class="text-orange-400">Origin Chat:</strong>
                                                <span class="font-mono text-[10px]"
                                                    x-text="item.char?.data?.extensions?.promotion_history?.origin_chat || 'Unknown'"></span>
                                            </div>
                                            <div class="meta text-xs text-slate-300">
                                                <strong class="text-orange-400">Promoted:</strong>
                                                <span class="text-[10px]"
                                                    x-text="formatDate((item.char?.data?.extensions?.promotion_history?.promoted_at || 0) * 1000)"></span>
                                            </div>
                                            <button
                                                @click.stop="jumpToOriginChat(item.char?.data?.extensions?.promotion_history?.origin_chat)"
                                                x-show="item.char?.data?.extensions?.promotion_history?.origin_chat"
                                                class="mt-2 px-3 py-1.5 bg-orange-600 hover:bg-orange-500 text-white text-[10px] font-bold uppercase tracking-widest rounded transition-all flex items-center gap-1 shadow-lg shadow-orange-900/20">
                                                <i class="fa-solid fa-arrow-right text-[8px]"></i>
                                                <span>View Origin Chat</span>
                                            </button>
                                        </div>

                                        <!-- Action Buttons -->
                                        <div class="hidden group-hover:flex gap-1 mt-2"
                                            x-show="item && (item.char || item.npc)">
                                            <!-- Global character actions -->
                                            <template x-if="item.type === 'global' && item.char">
                                                <div class="flex gap-1">
                                                    <button @click.stop="startEditCharacter(item.char)"
                                                        class="flex items-center justify-center w-7 h-7 rounded-lg bg-slate-800 hover:bg-blue-600 text-white transition-all"
                                                        title="Edit Character">
                                                        <i class="fa-solid fa-pen text-xs"></i>
                                                    </button>
                                                    <button @click.stop="deleteCharacter(item.char)"
                                                        class="flex items-center justify-center w-7 h-7 rounded-lg bg-slate-800 hover:bg-red-600 text-white transition-all"
                                                        title="Delete Character">
                                                        <i class="fa-solid fa-trash text-xs"></i>
                                                    </button>
                                                </div>
                                            </template>

                                            <!-- NPC actions -->
                                            <template x-if="item.type === 'npc' && item.npc">
                                                <div class="flex gap-1">
                                                    <button @click.stop="startEditNPC(item.npc)"
                                                        class="flex items-center justify-center w-7 h-7 rounded-lg bg-slate-800 hover:bg-blue-600 text-white transition-all"
                                                        title="Edit NPC">
                                                        <i class="fa-solid fa-pen text-xs"></i>
                                                    </button>
                                                    <button
                                                        @click.stop="toggleNPCActive(currentChatId, item.npc.entityid)"
                                                        :disabled="item.npc.promoted"
                                                        class="flex items-center justify-center w-7 h-7 rounded-lg transition-all text-xs"
                                                        :class="item.npc.promoted ? 'bg-slate-800 text-slate-500 cursor-not-allowed' : 'bg-slate-800 hover:bg-blue-600 text-white'"
                                                        :title="item.npc.promoted ? 'Cannot deactivate promoted NPC' : (item.npc.isactive ? 'Deactivate' : 'Activate')">
                                                        <i
                                                            :class="item.npc.isactive ? 'fa-solid fa-toggle-on' : 'fa-solid fa-toggle-off'"></i>
                                                    </button>
                                                    <button x-show="!item.npc.promoted"
                                                        @click.stop="promoteNPC(currentChatId, item.npc.entityid)"
                                                        class="flex items-center justify-center w-7 h-7 rounded-lg bg-green-600 hover:bg-green-500 text-white transition-all shadow-lg shadow-green-900/20"
                                                        title="Promote to Global Character">
                                                        <i class="fa-solid fa-arrow-up text-xs"></i>
                                                    </button>
                                                    <button @click.stop="deleteNPC(currentChatId, item.npc.entityid)"
                                                        class="flex items-center justify-center w-7 h-7 rounded-lg bg-slate-800 hover:bg-red-600 text-white transition-all"
                                                        title="Delete NPC">
                                                        <i class="fa-solid fa-trash text-xs"></i>
                                                    </button>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                </div>
                            </template>

                            <!-- Empty state -->
                            <div x-show="allCharacters().length === 0" class="text-center py-8 text-slate-500 text-sm">
                                <p class="mb-2">No characters yet.</p>
                                <p class="text-xs">Global characters appear here. NPCs appear when you create them in a
                                    chat.</p>
                            </div>
                        </div>
                    </div>
                </template>

                <!-- World Info Sidebar -->
                <template x-if="showSidebar === 'world-info'">
                    <div class="space-y-4">
                        <div class="flex gap-2">
                            <button @click="startAddWorldEntry()"
                                class="flex-1 bg-green-600 hover:bg-green-500 py-2 rounded-lg text-xs font-black uppercase tracking-widest transition-all"
                                :disabled="!activeWI">Add Entry</button>
                            <button @click="reimportAndRefreshWorldInfo()"
                                class="bg-slate-700 hover:bg-slate-600 px-3 py-1.5 rounded-lg text-slate-300"
                                :class="isReimporting ? 'animate-spin' : ''"
                                title="Refresh World Info (imports new JSON files)">
                                <i class="fa-solid fa-rotate"></i>
                            </button>
                        </div>
 
                        <!-- Tag Filter Bar -->
                        <div x-show="showSidebar === 'world-info'" class="space-y-3">
                            <div class="flex gap-2 overflow-x-auto pb-2">
                                <button @click="worldFilterTags = []; fetchWorldInfo()"
                                        :class="worldFilterTags.length === 0 ? 'bg-green-600' : 'bg-slate-700'"
                                        class="px-3 py-1 rounded-full text-xs whitespace-nowrap hover:opacity-90 transition-all">
                                    All
                                </button>
                                <template x-for="tag in popularWorldTags" :key="tag.tag">
                                    <button @click="toggleWorldFilterTag(tag.tag)"
                                            :class="worldFilterTags.includes(tag.tag) ? 'bg-orange-600' : 'bg-slate-700'"
                                            class="px-3 py-1 rounded-full text-xs whitespace-nowrap hover:opacity-90 transition-all"
                                            x-text="tag.tag + ' (' + tag.count + ')'">
                                    </button>
                                </template>
                                <select @change="addWorldFilterTag($event.target.value)"
                                        class="bg-slate-700 border border-slate-600 rounded px-2 py-1 text-xs outline-none focus:ring-1 focus:ring-green-500">
                                    <option value="">More tags...</option>
                                    <template x-for="tag in allWorldTags" :key="tag">
                                        <option :value="tag" x-text="tag"></option>
                                    </template>
                                </select>
                            </div>
                        </div>
 
                        <!-- World Info Editing Interface -->
                        <template x-if="editingWorldEntry">
                            <div class="bg-slate-900 p-3 rounded-xl border border-slate-700 space-y-3 shadow-xl">
                                <div class="flex justify-between items-center">
                                    <div class="flex items-center gap-3">
                                        <span class="font-bold text-sm" x-text="editingWorldEntry.world_name"></span>
                                        <span class="text-[10px] text-slate-500"
                                            x-text="editingWorldEntry.entry_uid ? 'Editing: ' + editingWorldEntry.entry_uid : 'Creating New Entry'"></span>
                                    </div>
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                    <div>
                                        <label class="text-[9px] text-slate-500 font-black uppercase">Keys
                                            (comma-separated)</label>
                                        <p class="text-[10px] text-slate-400 mb-1">Use quotes around phrase for exact match</p>
                                        <input x-model="editingWorldEntry.entry.key"
                                            class="w-full bg-slate-800 border border-slate-700 rounded-lg px-2 py-1.5 text-[10px] outline-none focus:ring-1 focus:ring-blue-500"
                                            placeholder="e.g. magic, spells, arcane">
                                    </div>
                                    <div>
                                        <label class="text-[9px] text-slate-500 font-black uppercase">Comment</label>
                                        <input x-model="editingWorldEntry.entry.comment"
                                            class="w-full bg-slate-800 border border-slate-700 rounded-lg px-2 py-1.5 text-[10px] outline-none focus:ring-1 focus:ring-blue-500"
                                            placeholder="Optional comment">
                                    </div>
                                </div>

                                <div>
                                    <label class="text-[9px] text-slate-500 font-black uppercase">Content</label>
                                    <textarea x-model="editingWorldEntry.entry.content"
                                        class="w-full bg-slate-800 border border-slate-700 rounded-lg px-2 py-1.5 text-xs h-24 outline-none focus:ring-1 focus:ring-blue-500"
                                        placeholder="World lore entry content..."></textarea>
                                </div>

                                <div class="flex items-center gap-2">
                                    <input type="checkbox" x-model="editingWorldEntry.entry.is_canon_law"
                                        class="w-4 h-4 text-red-600 bg-slate-900 border-slate-700 rounded focus:ring-red-500">
                                    <label class="text-[9px] text-slate-500 font-black uppercase">Canon Law</label>
                                </div>

                                <!-- AI-Assisted Editing Section -->
                                <div class="border-t border-slate-700 pt-3">
                                    <div class="flex justify-between items-center mb-2">
                                        <label class="text-[9px] text-blue-400 font-black uppercase">AI-Assisted
                                            Editing</label>
                                        <div class="flex gap-2">
                                            <select x-model="worldEditContextMode"
                                                class="bg-slate-800 border border-slate-700 rounded-lg px-2 py-1 text-[10px] text-slate-300">
                                                <option value="chat">Use Current Chat</option>
                                                <option value="manual">Manual Input</option>
                                            </select>
                                        </div>
                                    </div>

                                    <template x-if="worldEditContextMode === 'manual'">
                                        <div class="space-y-2 mb-3">
                                            <label class="text-[9px] text-slate-500 font-black uppercase">Context for
                                                AI</label>
                                            <textarea x-model="worldEditContextText"
                                                class="w-full bg-slate-800 border border-slate-700 rounded-lg px-2 py-1.5 text-[10px] h-16 outline-none focus:ring-1 focus:ring-blue-500"
                                                placeholder="Provide context for AI generation..."></textarea>
                                        </div>
                                    </template>

                                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2">
                                        <button @click="editWorldEntryAI('history')"
                                            class="bg-blue-600 hover:bg-blue-500 text-white text-[10px] font-black uppercase px-2 py-1 rounded-lg shadow-lg shadow-blue-900/20"
                                            :disabled="isEditingWorldEntry">
                                            <i class="fa-solid mr-1"
                                                :class="isEditingWorldEntry ? 'fa-circle-notch fa-spin' : 'fa-wand-magic-sparkles'"></i>History
                                        </button>
                                        <button @click="editWorldEntryAI('locations')"
                                            class="bg-blue-600 hover:bg-blue-500 text-white text-[10px] font-black uppercase px-2 py-1 rounded-lg shadow-lg shadow-blue-900/20"
                                            :disabled="isEditingWorldEntry">
                                            <i class="fa-solid mr-1"
                                                :class="isEditingWorldEntry ? 'fa-circle-notch fa-spin' : 'fa-wand-magic-sparkles'"></i>Locations
                                        </button>
                                        <button @click="editWorldEntryAI('creatures')"
                                            class="bg-blue-600 hover:bg-blue-500 text-white text-[10px] font-black uppercase px-2 py-1 rounded-lg shadow-lg shadow-blue-900/20"
                                            :disabled="isEditingWorldEntry">
                                            <i class="fa-solid mr-1"
                                                :class="isEditingWorldEntry ? 'fa-circle-notch fa-spin' : 'fa-wand-magic-sparkles'"></i>Creatures
                                        </button>
                                        <button @click="editWorldEntryAI('factions')"
                                            class="bg-blue-600 hover:bg-blue-500 text-white text-[10px] font-black uppercase px-2 py-1 rounded-lg shadow-lg shadow-blue-900/20"
                                            :disabled="isEditingWorldEntry">
                                            <i class="fa-solid mr-1"
                                                :class="isEditingWorldEntry ? 'fa-circle-notch fa-spin' : 'fa-wand-magic-sparkles'"></i>Factions
                                        </button>
                                        <button @click="addWorldEntry()"
                                            class="bg-green-600 hover:bg-green-500 text-white text-[10px] font-black uppercase px-2 py-1 rounded-lg shadow-lg shadow-green-900/20"
                                            :disabled="isAddingWorldEntry">
                                            <i class="fa-solid mr-1"
                                                :class="isAddingWorldEntry ? 'fa-circle-notch fa-spin' : 'fa-plus'"></i>Add
                                            Entry
                                        </button>
                                        <button
                                            @click="deleteWorldEntry(editingWorldEntry.world_name, editingWorldEntry.entry_uid)"
                                            class="bg-red-600 hover:bg-red-500 text-white text-[10px] font-black uppercase px-2 py-1 rounded-lg shadow-lg shadow-red-900/20"
                                            :disabled="!editingWorldEntry.entry_uid">
                                            <i class="fa-solid mr-1"
                                                :class="isDeletingWorldEntry ? 'fa-circle-notch fa-spin' : 'fa-trash'"></i>Delete
                                             </button>
                                     </div>
                                 </div>
 
                                  <!-- Tag Editor for World Entry -->
                                  <div class="space-y-2 border-t border-slate-700 pt-3">
                                      <label class="text-[9px] text-slate-500 font-black uppercase">World-Level Tags</label>
                                      <p class="text-[9px] text-amber-500/80">⚠️ These tags apply to ALL entries in this world</p>
                                     
                                     <!-- Current tags as chips -->
                                     <div class="flex flex-wrap gap-2 mb-2">
                                         <template x-for="tag in editingWorldTags" :key="tag">
                                             <span class="px-2 py-1 bg-purple-600/30 border border-purple-600/50 rounded text-[10px] text-purple-300 flex items-center gap-1">
                                                 <span x-text="tag"></span>
                                                 <button @click="removeEditWorldTag(tag)" class="text-purple-400 hover:text-purple-200">×</button>
                                             </span>
                                         </template>
                                     </div>
                                     
                                     <!-- Input with autocomplete -->
                                     <div class="relative">
                                         <input x-model="worldTagInput"
                                                @keydown.enter="addEditWorldTag()"
                                                @keydown.tab.prevent="addEditWorldTag()"
                                                class="w-full bg-slate-950 border border-slate-700 rounded-xl px-3 py-2 text-xs outline-none focus:ring-1 focus:ring-purple-500"
                                                placeholder="Type tag and press Enter">
                                 
                                         <!-- Autocomplete suggestions -->
                                         <div x-show="worldTagSuggestions.length > 0 && worldTagInput.length > 0"
                                              class="absolute top-full left-0 right-0 mt-1 bg-slate-800 border border-slate-700 rounded-lg shadow-xl max-h-40 overflow-y-auto z-50">
                                             <template x-for="suggestion in worldTagSuggestions" :key="suggestion">
                                                 <button @click="worldTagInput = suggestion; addEditWorldTag()"
                                                         class="w-full text-left px-3 py-1 text-xs hover:bg-slate-700"
                                                         x-text="suggestion">
                                                 </button>
                                             </template>
                                         </div>
                                     </div>
                                 </div>
 
                                 <div
                                     class="sticky bottom-0 bg-slate-900 border-t border-slate-700 p-3 -mx-3 -mb-3 rounded-b-xl">
                                    <div class="flex gap-2 justify-end">
                                        <button @click="saveWorldEntry()"
                                            class="bg-green-600 hover:bg-green-500 text-white px-4 py-2 rounded-lg text-xs font-black uppercase shadow-lg shadow-green-900/20 transition-all">Save</button>
                                        <button @click="editingWorldEntry = null"
                                            class="bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded-lg text-xs font-black uppercase transition-all">Cancel</button>
                                    </div>
                                </div>
                            </div>
                        </template>

                        <!-- World Info List -->
                        <div class="space-y-2">
                            <template x-for="wi in worldInfos" :key="wi.name">
                                <div
                                    class="group bg-slate-900/50 rounded-xl overflow-hidden border border-slate-700/50">
                                    <div class="flex items-center">
                                        <button @click.stop="deleteWorld(wi)"
                                            class="hidden group-hover:flex w-6 h-6 rounded-lg bg-slate-800 hover:bg-red-600 text-white items-center justify-center transition-all ml-3 mr-2"
                                            title="Delete World">
                                            <i class="fa-solid fa-trash text-[10px]"></i>
                                        </button>
                                        <button @click="toggleWorldExpansion(wi.name)"
                                            class="flex-1 text-left font-black text-[10px] tracking-widest uppercase p-3 transition-all hover:bg-slate-700/30 flex justify-between items-center"
                                            :class="expandedWorlds.has(wi.name) ? 'text-green-400 bg-green-500/10' : 'text-slate-500'">
                                            <span x-text="wi.name"></span>
                                            <i class="fa-solid"
                                                :class="expandedWorlds.has(wi.name) ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
                                        </button>
                                    </div>

                                    <div x-show="expandedWorlds.has(wi.name)" class="p-3 pt-0 space-y-3">
                                        <template x-for="(entry, uid) in wi.entries" :key="uid">
                                            <div
                                                class="p-2 bg-slate-800 rounded-lg border border-slate-700 transition-all hover:border-slate-600">
                                                <div class="flex justify-between items-start mb-1">
                                                    <div @click="toggleCanonLaw(wi, uid)"
                                                        class="font-black text-[9px] uppercase tracking-widest cursor-pointer hover:opacity-80 transition-all"
                                                        :class="entry.is_canon_law ? 'text-red-500' : 'text-green-500'"
                                                        x-text="entry.key.join(' • ')"></div>
                                                    <div class="flex gap-1 items-center">
                                                        <div x-show="entry.is_canon_law"
                                                            class="text-[7px] bg-red-500/20 text-red-500 px-1 rounded uppercase font-black">
                                                            Canon Law</div>
                                                        <div x-show="entry.constant"
                                                            class="text-[8px] bg-green-500/20 text-green-400 px-1 rounded uppercase font-black">
                                                            Constant</div>
                                                        <div class="flex gap-1 mt-2">
                                                            <button @click="startEditWorldEntry(wi, uid)"
                                                                class="text-[8px] text-blue-400 hover:text-blue-300 font-bold uppercase px-2 py-1 rounded-lg border border-blue-500/30 hover:border-blue-400/50 transition-all"
                                                                title="Edit Entry">
                                                                <i class="fa-solid fa-pen mr-1"></i>Edit
                                                            </button>
                                                            <button @click="deleteWorldEntry(wi.name, uid)"
                                                                class="text-[8px] text-red-400 hover:text-red-300 font-bold uppercase px-2 py-1 rounded-lg border border-red-500/30 hover:border-red-400/50 transition-all"
                                                                title="Delete Entry">
                                                                <i class="fa-solid fa-trash mr-1"></i>Delete
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="text-[10px] text-slate-400 leading-tight line-clamp-3 font-medium"
                                                    x-text="entry.content"></div>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </template>

                <!-- Settings Sidebar -->
                <template x-if="showSidebar === 'settings'">
                    <div class="space-y-6">
                        <div class="space-y-4 pt-2">
                            <h3 class="text-[10px] font-black uppercase tracking-widest text-slate-500">Neural
                                Connection</h3>

                            <!-- Connection Status Indicators -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <div class="bg-slate-900/50 rounded-xl p-3 border border-slate-700/50">
                                    <div class="flex justify-between items-center mb-2">
                                        <div class="flex items-center gap-2">
                                            <div class="w-2 h-2 rounded-full" :class="getServiceStatusClass('kobold')">
                                            </div>
                                            <span
                                                class="text-[9px] font-black uppercase text-slate-400">KoboldCpp</span>
                                        </div>
                                        <button @click="testConnection('kobold')"
                                            class="text-[8px] text-slate-500 hover:text-slate-300 font-bold uppercase"
                                            :disabled="isCheckingConnections">
                                            <i class="fa-solid mr-1"
                                                :class="isCheckingConnections ? 'fa-circle-notch fa-spin' : 'fa-refresh'"></i>Test
                                        </button>
                                    </div>
                                    <div class="text-[8px] text-slate-500 leading-tight"
                                        x-text="getServiceStatusText('kobold')"></div>
                                    <div class="mt-1 text-[7px] text-slate-600" x-text="config.kobold_url"></div>
                                </div>

                                <div class="bg-slate-900/50 rounded-xl p-3 border border-slate-700/50">
                                    <div class="flex justify-between items-center mb-2">
                                        <div class="flex items-center gap-2">
                                            <div class="w-2 h-2 rounded-full" :class="getServiceStatusClass('sd')">
                                            </div>
                                            <span class="text-[9px] font-black uppercase text-slate-400">Stable
                                                Diffusion</span>
                                        </div>
                                        <button @click="testConnection('sd')"
                                            class="text-[8px] text-slate-500 hover:text-slate-300 font-bold uppercase"
                                            :disabled="isCheckingConnections">
                                            <i class="fa-solid mr-1"
                                                :class="isCheckingConnections ? 'fa-circle-notch fa-spin' : 'fa-refresh'"></i>Test
                                        </button>
                                    </div>
                                    <div class="text-[8px] text-slate-500 leading-tight"
                                        x-text="getServiceStatusText('sd')"></div>
                                    <div class="mt-1 text-[7px] text-slate-600" x-text="config.sd_url"></div>
                                </div>
                            </div>

                            <div class="space-y-3">
                                <div class="space-y-1">
                                    <label class="text-[10px] text-slate-450 uppercase font-bold">System Prompt</label>
                                    <textarea x-model="settings.system_prompt"
                                        class="w-full bg-slate-900 border border-slate-700 rounded-lg p-2 text-xs h-24 outline-none focus:ring-1 focus:ring-blue-500"></textarea>
                                </div>
                                <div class="space-y-1">
                                    <label class="text-[10px] text-slate-450 uppercase font-bold">Your Name</label>
                                    <input x-model="settings.userName"
                                        class="w-full bg-slate-900 border border-slate-700 rounded-lg p-2 text-sm outline-none focus:ring-1 focus:ring-blue-500"
                                        placeholder="Enter your name for the story...">
                                </div>
                                <div class="space-y-1">
                                    <label class="text-[10px] text-slate-450 uppercase font-bold">Your Persona
                                        (You)</label>
                                    <textarea x-model="settings.user_persona"
                                        class="w-full bg-slate-900 border border-slate-700 rounded-lg p-2 text-xs h-24 outline-none focus:ring-1 focus:ring-blue-500"
                                        placeholder="Describe your character..."></textarea>
                                </div>
                                <div class="space-y-1">
                                    <label class="text-[10px] text-slate-450 uppercase font-bold">Reinforce Character
                                        Info Every X Turns</label>
                                    <input type="number" x-model.number="settings.reinforce_freq"
                                        class="w-full bg-slate-900 border border-slate-700 rounded-lg p-2 text-sm outline-none focus:ring-1 focus:ring-blue-500">
                                </div>
                                <div class="space-y-1">
                                    <label class="text-[10px] text-slate-450 uppercase font-bold">Reinforce World Canon
                                        Every X Turns</label>
                                    <input type="number" x-model.number="settings.world_info_reinforce_freq"
                                        class="w-full bg-slate-900 border border-slate-700 rounded-lg p-2 text-sm outline-none focus:ring-1 focus:ring-blue-500"
                                        placeholder="3">
                                    <p class="text-[8px] text-slate-500 leading-tight">Frequency for reinforcing world
                                        canon law entries (1-100, 0 to disable)</p>
                                </div>
                                <div class="space-y-1">
                                    <label class="text-[10px] text-slate-450 uppercase font-bold">Enable World
                                        Info</label>
                                    <div class="flex items-center gap-3">
                                        <input type="checkbox" x-model="settings.world_info_enabled"
                                            class="w-4 h-4 text-blue-600 bg-slate-900 border-slate-700 rounded focus:ring-blue-500">
                                        <span class="text-[9px] text-slate-500">Include world lore in prompts</span>
                                    </div>
                                </div>
                                <div class="space-y-1">
                                    <label class="text-[10px] text-slate-450 uppercase font-bold">Max World Info
                                        Entries</label>
                                    <div class="flex items-center gap-3">
                                        <input type="number" x-model.number="settings.max_world_info_entries"
                                            class="w-24 bg-slate-900 border border-slate-700 rounded-lg p-1 text-xs outline-none focus:ring-1 focus:ring-blue-500"
                                            placeholder="10">
                                        <span class="text-[9px] text-slate-500">0 = unlimited</span>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-3">
                                    <div class="space-y-1">
                                        <label
                                            class="text-[10px] text-slate-450 uppercase font-bold">Temperature</label>
                                        <input type="number" step="0.1" x-model.number="settings.temperature"
                                            class="w-full bg-slate-900 border border-slate-700 rounded-lg p-2 text-sm outline-none focus:ring-1 focus:ring-blue-500">
                                    </div>
                                    <div class="space-y-1">
                                        <label class="text-[10px] text-slate-450 uppercase font-bold">Max Resp
                                            Tokens</label>
                                        <input type="number" x-model.number="settings.max_length"
                                            class="w-full bg-slate-900 border border-slate-700 rounded-lg p-2 text-sm outline-none focus:ring-1 focus:ring-blue-500">
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-3">
                                    <div class="space-y-1">
                                        <label class="text-[10px] text-slate-450 uppercase font-bold">Max
                                            Context</label>
                                        <input type="number" x-model.number="settings.max_context"
                                            class="w-full bg-slate-900 border border-slate-700 rounded-lg p-2 text-sm outline-none focus:ring-1 focus:ring-blue-500">
                                    </div>
                                    <div class="space-y-1">
                                        <label class="text-[10px] text-slate-450 uppercase font-bold">Summ
                                            Threshold</label>
                                        <input type="number" step="0.01" x-model.number="settings.summarize_threshold"
                                            class="w-full bg-slate-900 border border-slate-700 rounded-lg p-2 text-sm outline-none focus:ring-1 focus:ring-blue-500">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Current Summary View -->
                        <div x-show="summary" class="space-y-2 pt-4 border-t border-slate-700">
                            <h3 class="text-[10px] font-black uppercase tracking-widest text-slate-500">Long-Term Memory
                            </h3>
                            <textarea x-model="summary"
                                class="w-full bg-slate-950/50 border border-slate-700 rounded-lg p-2 text-[10px] h-32 text-slate-400 outline-none focus:ring-1 focus:ring-blue-500/30"
                                readonly></textarea>
                            <button @click="if(confirm('Clear long-term memory?')) summary = ''"
                                class="text-[8px] text-red-400 uppercase font-bold tracking-widest hover:text-red-300 transition-colors">Clear
                                Memory</button>
                        </div>

                        <div class="space-y-4 pt-4 border-t border-slate-700">
                            <h3 class="text-[10px] font-black uppercase tracking-widest text-slate-500">Performance
                                Optimization</h3>
                            <div class="space-y-3">
                                <div class="space-y-1">
                                    <div class="flex items-center justify-between">
                                        <label class="text-[10px] text-slate-450 uppercase font-bold">Smart Performance
                                            Mode</label>
                                        <input type="checkbox" x-model="settings.performance_mode_enabled"
                                            @change="togglePerformanceMode()"
                                            class="w-4 h-4 text-green-600 bg-slate-900 border-slate-700 rounded focus:ring-green-500">
                                    </div>
                                    <p class="text-[8px] text-slate-500 leading-tight">Intelligently queues LLM/SD
                                        operations and optimizes image generation based on context size</p>
                                </div>
                            </div>
                        </div>

                        <!-- World Info Cache Management -->
                        <div class="space-y-4 pt-4 border-t border-slate-700">
                            <h3 class="text-[10px] font-black uppercase tracking-widest text-slate-500">World Info Cache
                            </h3>
                            <div class="space-y-3">
                                <div class="bg-slate-900/50 rounded-xl p-3 border border-slate-700/50">
                                    <div class="flex justify-between items-center mb-2">
                                        <div class="text-[9px] font-black uppercase text-slate-400">Cache Status</div>
                                        <div class="flex gap-2">
                                            <button @click="fetchCacheStats()"
                                                class="text-[8px] text-slate-500 hover:text-slate-300 font-bold uppercase"
                                                :disabled="isFetchingCache">
                                                <i class="fa-solid mr-1"
                                                    :class="isFetchingCache ? 'fa-circle-notch fa-spin' : 'fa-refresh'"></i>Refresh
                                            </button>
                                            <button @click="clearCache()"
                                                class="text-[8px] text-red-400 hover:text-red-300 font-bold uppercase"
                                                :disabled="isClearingCache">
                                                <i class="fa-solid mr-1"
                                                    :class="isClearingCache ? 'fa-circle-notch fa-spin' : 'fa-trash'"></i>Clear
                                            </button>
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-2 gap-2 text-[8px] text-slate-500">
                                        <div>Entries: <span x-text="cacheStats.size || '0'"></span></div>
                                        <div>Max: <span x-text="cacheStats.max_size || '1000'"></span></div>
                                        <div>Usage: <span
                                                x-text="(cacheStats.usage_percent || 0).toFixed(1) + '%'"></span></div>
                                        <div>Memory: <span
                                                x-text="((cacheStats.size || 0) * 2).toFixed(1) + ' KB (est.)'"></span>
                                        </div>
                                    </div>
                                    <div class="mt-2 w-full bg-slate-800 rounded-full h-1.5">
                                        <div class="bg-green-500 h-1.5 rounded-full"
                                            :style="'width: ' + (cacheStats.usage_percent || 0) + '%'"></div>
                                    </div>
                                </div>
                                <div class="space-y-1">
                                    <label class="text-[10px] text-slate-450 uppercase font-bold">Cache Size
                                        Limit</label>
                                    <div class="flex gap-2">
                                        <input type="number" x-model.number="cacheConfig.max_size"
                                            class="w-24 bg-slate-900 border border-slate-700 rounded-lg p-1 text-xs outline-none focus:ring-1 focus:ring-blue-500"
                                            placeholder="1000">
                                        <button @click="updateCacheConfig()"
                                            class="bg-blue-600 hover:bg-blue-500 text-white px-3 py-1 rounded-lg text-[10px] font-black uppercase tracking-widest shadow-lg shadow-blue-900/20 transition-all"
                                            :disabled="isUpdatingCache">
                                            <span x-show="!isUpdatingCache">Update</span>
                                            <i x-show="isUpdatingCache" class="fa-solid fa-circle-notch fa-spin"></i>
                                        </button>
                                    </div>
                                    <p class="text-[8px] text-slate-500 leading-tight">Maximum number of cached world
                                        info entries (0 = unlimited)</p>
                                </div>
                            </div>
                        </div>

                        <div class="space-y-4 pt-4 border-t border-slate-700">
                            <h3 class="text-[10px] font-black uppercase tracking-widest text-slate-500">API
                                Configuration</h3>
                            <div class="space-y-3">
                                <div class="space-y-1">
                                    <label class="text-[10px] text-slate-450 uppercase font-bold">Kobold URL</label>
                                    <div class="flex gap-2">
                                        <input x-model="config.kobold_url"
                                            class="flex-1 bg-slate-900 border border-slate-700 rounded-lg p-2 text-sm outline-none focus:ring-1 focus:ring-blue-500">
                                        <button @click="updateAPIURLs()"
                                            class="bg-blue-600 hover:bg-blue-500 text-white px-3 py-2 rounded-lg text-[10px] font-black uppercase tracking-widest shadow-lg shadow-blue-900/20 transition-all"
                                            :disabled="isCheckingConnections">
                                            <span x-show="!isCheckingConnections">Update & Test</span>
                                            <i x-show="isCheckingConnections"
                                                class="fa-solid fa-circle-notch fa-spin"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="space-y-1">
                                    <label class="text-[10px] text-slate-450 uppercase font-bold">SD API URL</label>
                                    <div class="flex gap-2">
                                        <input x-model="config.sd_url"
                                            class="flex-1 bg-slate-900 border border-slate-700 rounded-lg p-2 text-sm outline-none focus:ring-1 focus:ring-purple-500">
                                        <button @click="updateAPIURLs()"
                                            class="bg-purple-600 hover:bg-purple-500 text-white px-3 py-2 rounded-lg text-[10px] font-black uppercase tracking-widest shadow-lg shadow-purple-900/20 transition-all"
                                            :disabled="isCheckingConnections">
                                            <span x-show="!isCheckingConnections">Update & Test</span>
                                            <i x-show="isCheckingConnections"
                                                class="fa-solid fa-circle-notch fa-spin"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Data Recovery Section -->
                        <div class="space-y-4 pt-4 border-t border-slate-700">
                            <h3 class="text-[10px] font-black uppercase tracking-widest text-orange-400">Data Recovery
                            </h3>
                            <div class="space-y-3">
                                <div class="bg-slate-900/50 rounded-xl p-4 border border-slate-700/50">
                                    <div class="flex justify-between items-center mb-3">
                                        <div class="text-[9px] font-bold text-slate-400 leading-relaxed">
                                            <p class="mb-2">View and restore previous versions of characters, world
                                                info, and chats.</p>
                                            <p class="mb-2 text-[8px] text-slate-500">The change log preserves 30 days
                                                of history with before/after snapshots for recovery.</p>
                                        </div>
                                        <button @click="openChangeHistoryModal()"
                                            class="bg-orange-600 hover:bg-orange-500 text-white px-4 py-2 rounded-lg text-[10px] font-black uppercase tracking-widest shadow-lg shadow-orange-900/20 transition-all">
                                            <i class="fa-solid fa-clock-rotate-left mr-2"></i>View Change History
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
        </div>

        <!-- Search Bar (Fixed Overlay) -->
        <div x-show="showSearchBar"
            class="fixed top-0 left-0 right-0 bg-slate-800 border-b border-slate-700 z-50 shadow-2xl"
            style="max-height: 80vh;">
            <div class="p-4 space-y-3 overflow-y-auto" style="max-height: 80vh;">
                <div class="flex gap-2">
                    <input type="text" x-model="searchQuery" @keydown.enter="performSearch()"
                        class="flex-1 bg-slate-950 border border-slate-700 rounded-xl px-4 py-2 text-sm outline-none focus:ring-2 focus:ring-blue-500/30"
                        placeholder="Search messages... (e.g., 'flame sword', 'prophecy')">
                    <button @click="performSearch()"
                        class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg text-xs font-bold uppercase tracking-widest shadow-lg shadow-blue-900/20 transition-all"
                        :disabled="isSearching">
                        <span x-show="!isSearching">🔍 Search</span>
                        <span x-show="isSearching">Searching...</span>
                    </button>
                    <button @click="toggleSearchFilters()"
                        class="bg-slate-700 hover:bg-slate-600 text-slate-300 px-3 py-2 rounded-lg transition-all">
                        <i class="fa-solid fa-sliders"></i>
                    </button>
                    <button @click="clearSearch()"
                        class="bg-slate-700 hover:bg-red-600 text-slate-300 px-3 py-2 rounded-lg transition-all">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                </div>

                <!-- Search Filters -->
                <div x-show="showSearchFilters" class="space-y-3 border-t border-slate-700 pt-3 mt-3">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div>
                            <label class="text-[9px] text-slate-500 uppercase font-bold">Filter by Chat</label>
                            <select x-model="searchFilters.chat_id"
                                class="w-full bg-slate-950 border border-slate-700 rounded-lg px-2 py-1.5 text-xs outline-none focus:ring-1 focus:ring-blue-500/30">
                                <option value="">All Chats</option>
                                <template x-for="chat in savedChats" :key="chat.id">
                                    <option :value="chat.id" x-text="chat.branch_name || getDisplayName(chat.id)">
                                    </option>
                                </template>
                            </select>
                        </div>
                        <div>
                            <label class="text-[9px] text-slate-500 uppercase font-bold">Filter by Speaker</label>
                            <select x-model="searchFilters.speaker"
                                class="w-full bg-slate-950 border border-slate-700 rounded-lg px-2 py-1.5 text-xs outline-none focus:ring-1 focus:ring-blue-500/30">
                                <option value="">All Speakers</option>
                                <template x-for="speaker in searchFilters.available_speakers" :key="speaker">
                                    <option :value="speaker" x-text="speaker"></option>
                                </template>
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div>
                            <label class="text-[9px] text-slate-500 uppercase font-bold">From Date</label>
                            <input type="date" x-model="searchFilters.start_date"
                                class="w-full bg-slate-950 border border-slate-700 rounded-lg px-2 py-1.5 text-xs outline-none focus:ring-1 focus:ring-blue-500/30">
                        </div>
                        <div>
                            <label class="text-[9px] text-slate-500 uppercase font-bold">To Date</label>
                            <input type="date" x-model="searchFilters.end_date"
                                class="w-full bg-slate-950 border border-slate-700 rounded-lg px-2 py-1.5 text-xs outline-none focus:ring-1 focus:ring-blue-500/30">
                        </div>
                    </div>
                    <div class="flex justify-end">
                        <button @click="clearSearchFilters()"
                            class="text-[9px] text-slate-500 hover:text-slate-300 uppercase font-bold">Clear
                            Filters</button>
                    </div>
                </div>
            </div>

            <!-- Search Results -->
            <div x-show="searchResults.length > 0"
                class="bg-slate-900 border-t border-slate-700 max-h-[60vh] overflow-y-auto">
                <div class="p-4">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-xs font-black uppercase tracking-widest text-blue-400">
                            Search Results (<span x-text="searchResultsCount"></span> message<span
                                x-text="searchResults.length > 1 ? 's' : ''"></span>)
                        </h3>
                        <button @click="showSearchBar = false" class="text-slate-400 hover:text-slate-200">
                            <i class="fa-solid fa-xmark"></i>
                        </button>
                    </div>
                    <p class="text-[9px] text-slate-500 mb-3">Query: "<span class="text-blue-400 font-bold"
                            x-text="searchQuery"></span>"</p>
                    <div class="space-y-3">
                        <template x-for="result in searchResults" :key="result.id">
                            <div class="p-3 bg-slate-800 rounded-xl border border-slate-700/50 hover:border-slate-600 transition-all cursor-pointer group"
                                @click="jumpToMessage(result.chat_id, result.id)">
                                <div class="flex justify-between items-start mb-2">
                                    <div class="flex items-center gap-2">
                                        <div class="text-[9px] text-blue-500 font-black uppercase tracking-widest"
                                            x-text="result.speaker || result.role"></div>
                                        <div class="text-[9px] text-slate-500"
                                            x-text="formatDate(result.timestamp * 1000)"></div>
                                    </div>
                                    <div x-show="result.branch_name"
                                        class="text-[9px] text-green-500 uppercase font-bold">
                                        📍 <span x-text="result.branch_name"></span>
                                    </div>
                                </div>
                                <div class="text-xs text-slate-400 leading-relaxed"
                                    x-html="highlightSearchTerms(result.content, searchQuery)"></div>
                                <div class="flex gap-2 mt-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                    <button @click.stop="jumpToMessage(result.chat_id, result.id)"
                                        class="px-3 py-1 bg-blue-600 hover:bg-blue-500 text-white text-[10px] font-black uppercase rounded-lg transition-all">
                                        <i class="fa-solid fa-arrow-right mr-1"></i>Jump to Message
                                    </button>
                                    <button @click.stop="showMessageContext(result.id)"
                                        class="px-3 py-1 bg-slate-700 hover:bg-slate-600 text-slate-300 text-[10px] font-black uppercase rounded-lg transition-all">
                                        <i class="fa-solid fa-expand mr-1"></i>Show Context
                                    </button>
                                </div>
                            </div>
                        </template>
                    </div>
                    <div x-show="searchResults.length === 0" class="text-center py-8 text-slate-500">
                        <p>No messages found matching your search.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col min-w-0 relative">
            <!-- Header -->
            <div
                class="h-14 border-b border-slate-700 flex items-center justify-between px-6 bg-slate-800/80 backdrop-blur shrink-0 z-10">
                <div class="flex gap-6">
                    <button @click="showSidebar = 'chats'"
                        class="hover:text-green-400 flex items-center gap-2.5 text-xs font-black uppercase tracking-widest transition-all"
                        :class="showSidebar === 'chats' ? 'text-green-400' : 'text-slate-400'">
                        <i class="fa-solid fa-message text-sm"></i><span class="hidden sm:inline">Chats</span>
                    </button>
                    <button @click="showSidebar = 'characters'"
                        class="hover:text-blue-400 flex items-center gap-2.5 text-xs font-black uppercase tracking-widest transition-all"
                        :class="showSidebar === 'characters' ? 'text-blue-400' : 'text-slate-400'">
                        <i class="fa-solid fa-users text-sm"></i><span class="hidden sm:inline">Characters</span>
                    </button>
                    <button @click="showSidebar = 'world-info'"
                        class="hover:text-green-400 flex items-center gap-2.5 text-xs font-black uppercase tracking-widest transition-all"
                        :class="showSidebar === 'world-info' ? 'text-green-400' : 'text-slate-400'">
                        <i class="fa-solid fa-earth-americas text-sm"></i><span class="hidden sm:inline">World
                            Info</span>
                    </button>
                    <button @click="openCardGen()"
                        class="hover:text-purple-400 flex items-center gap-2.5 text-xs font-black uppercase tracking-widest transition-all text-slate-400">
                        <i class="fa-solid fa-id-card text-sm"></i><span class="hidden sm:inline">Gen Card</span>
                    </button>
                    <button @click="openWorldGen()"
                        class="hover:text-orange-400 flex items-center gap-2.5 text-xs font-black uppercase tracking-widest transition-all text-slate-400">
                        <i class="fa-solid fa-earth-europe text-sm"></i><span class="hidden sm:inline">Gen World</span>
                    </button>
                    <button @click="showSearchBar = !showSearchBar"
                        class="hover:text-yellow-400 flex items-center gap-2.5 text-xs font-black uppercase tracking-widest transition-all"
                        :class="showSearchBar ? 'text-yellow-400' : 'text-slate-400'">
                        <i class="fa-solid fa-magnifying-glass text-sm"></i><span class="hidden sm:inline">Search</span>
                    </button>
                    <button @click="showSidebar = 'favorites'"
                        class="hover:text-pink-400 flex items-center gap-2.5 text-xs font-black uppercase tracking-widest transition-all"
                        :class="showSidebar === 'favorites' ? 'text-pink-400' : 'text-slate-400'">
                        <i class="fa-solid fa-heart text-sm"></i><span class="hidden sm:inline">Favorites</span>
                    </button>
                </div>
                <button @click="openExportDialog()"
                    class="flex items-center gap-2.5 text-xs font-black uppercase tracking-widest transition-all"
                    :class="currentChatId ? 'text-slate-400' : 'text-slate-600 cursor-not-allowed'"
                    :title="currentChatId ? 'Export chat for training' : 'Save a chat first'">
                    <i class="fa-solid fa-file-export text-sm hover:text-green-400" :class="!currentChatId ? 'opacity-50' : ''"></i>
                    <span class="hidden sm:inline hover:text-green-400">Export</span>
                <!-- Active Character Indicator -->
                <div class="flex-1 flex justify-center overflow-hidden mx-4 text-center">
                    <div x-show="activeCharactersWithData().length > 0"
                        class="flex items-center gap-2 overflow-x-auto no-scrollbar py-1" x-cloak x-transition>
                        <template x-for="char in activeCharactersWithData()" :key="char.data.name">
                            <div
                                class="flex items-center gap-2 bg-slate-950/50 px-3 py-1 rounded-full text-[9px] border border-slate-700/50 shadow-inner whitespace-nowrap shrink-0">
                                <span
                                    class="w-1.5 h-1.5 rounded-full bg-green-500 shadow-[0_0_6px_rgba(34,197,94,0.5)]"></span>
                                <span class="font-black tracking-wide uppercase" x-text="char.data?.name"></span>
                                <button @click="toggleCharacter(char)"
                                    class="text-slate-500 hover:text-red-400 ml-1 transition-all"><i
                                        class="fa-solid fa-xmark"></i></button>
                            </div>
                        </template>
                    </div>
                    <div x-show="activeCharactersWithData().length === 0"
                        class="flex items-center gap-2.5 bg-slate-950/50 px-4 py-1.5 rounded-full text-xs border border-slate-700/50 shadow-inner"
                        x-cloak x-transition>
                        <span class="w-2 h-2 rounded-full bg-blue-500 shadow-[0_0_8px_rgba(59,130,246,0.5)]"></span>
                        <span class="font-black tracking-wide uppercase text-[10px]">Narrator Mode</span>
                    </div>
                </div>

                <button @click="showSidebar = 'settings'" class="text-slate-400 hover:text-slate-200 transition-all"
                    :class="showSidebar === 'settings' ? 'text-blue-400' : ''">
                    <i class="fa-solid fa-sliders text-sm"></i>
                </button>
            </div>
            <!-- Chat Area -->
            <div id="chat-container"
                class="flex-1 overflow-y-auto p-6 space-y-8 bg-slate-900 border-x border-slate-800/50 w-full">
                <template x-if="messages.length === 0">
                    <div class="h-full flex flex-col items-center justify-center text-slate-600 space-y-6 opacity-50">
                        <div
                            class="w-20 h-20 rounded-3xl bg-slate-800/50 border border-slate-700 flex items-center justify-center shadow-2xl">
                            <span class="text-3xl rotate-12">*-*</span>
                        </div>
                        <div class="text-center group">
                            <p
                                class="text-[10px] font-black uppercase tracking-[0.3em] mb-1 group-hover:text-blue-500 transition-colors">
                                Neural Connection Ready</p>
                            <p class="text-[9px] font-medium text-slate-500">Awaiting user input or vision sequence</p>
                        </div>
                    </div>
                </template>

                <div class="space-y-8">
                    <template x-for="(msg, index) in messages" :key="msg.id">
                        <div :id="'message-' + index" class="flex group" :class="msg.role === 'user' ? 'justify-end' : 'justify-start'">
                            <div class="max-w-[85%] space-y-1.5 relative"
                                :style="editingMessageId === msg.id && editingWidth ? 'width: ' + editingWidth : ''">
                                <div x-show="msg.role !== 'user' && msg.speaker !== 'Visual System'"
                                    class="text-[9px] font-black text-blue-500 uppercase tracking-[0.2em] ml-4 mb-1"
                                    x-text="msg.speaker || 'Narrator'"></div>

                                <div class="relative px-5 py-3.5 shadow-xl transition-all border border-transparent"
                                    :class="msg.role === 'user' ? 'bg-blue-600 text-white rounded-3xl rounded-tr-[4px] shadow-blue-900/20' : 'bg-slate-800 border border-slate-700/50 text-slate-200 rounded-3xl rounded-tl-[4px] shadow-black/20 hover:border-slate-600'"
                                    :style="msg.speaker === 'Visual System' ? 'padding: 0; background: transparent; border: none; box-shadow: none;' : ''">

                                    <!-- Message Controls -->
                                    <div
                                        class="absolute -top-3 right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition-all z-10 h-6">
                                        <template x-if="msg.role === 'user'">
                                            <button @click="regenerate(index)"
                                                class="w-6 h-6 rounded-full bg-slate-700 hover:bg-green-600 text-white flex items-center justify-center shadow-lg border border-slate-600 border-opacity-50"
                                                title="Regenerate from here">
                                                <i class="fa-solid fa-rotate text-[8px]"></i>
                                            </button>
                                        </template>
                                        <button @click="openForkDialog(msg.id)"
                                            class="w-6 h-6 rounded-full bg-slate-700 hover:bg-blue-600 text-white flex items-center justify-center shadow-lg border border-slate-600 border-opacity-50"
                                            title="Fork from here">
                                            <i class="fa-solid fa-code-branch text-[8px]"></i>
                                        </button>
                                        <button
                                            @click="editingMessageId = msg.id; editBuffer = msg.content; editingWidth = $el.closest('.max-w-\\[85\\%\\]').offsetWidth + 'px'"
                                            class="w-6 h-6 rounded-full bg-slate-700 hover:bg-blue-600 text-white flex items-center justify-center shadow-lg border border-slate-600 border-opacity-50">
                                            <i class="fa-solid fa-pen text-[8px]"></i>
                                        </button>
                                        <button @click="deleteMessage(index)"
                                            class="w-6 h-6 rounded-full bg-slate-700 hover:bg-red-600 text-white flex items-center justify-center shadow-lg border border-slate-600 border-opacity-50">
                                            <i class="fa-solid fa-trash text-[8px]"></i>
                                        </button>
                                        <template x-if="msg.image">
                                            <button @click="copyImageSettings(msg.image)"
                                                class="w-6 h-6 rounded-full bg-slate-700 hover:bg-purple-600 text-white flex items-center justify-center shadow-lg border border-slate-600 border-opacity-50"
                                                title="Copy Image Settings">
                                                <i class="fa-solid fa-copy text-[8px]"></i>
                                            </button>
                                        </template>
                                        <template x-if="msg.image || msg.snapshot">
                                            <button @click="openInpaintDialog(msg, index)"
                                                class="w-6 h-6 rounded-full bg-slate-700 hover:bg-orange-600 text-white flex items-center justify-center shadow-lg border border-slate-600 border-opacity-50"
                                                title="Inpaint Image">
                                                <i class="fa-solid fa-paintbrush text-[8px]"></i>
                                            </button>
                                        </template>
                                    </div>

                                    <template x-if="editingMessageId !== msg.id">
                                        <div>
                                            <div x-show="msg.content"
                                                class="whitespace-pre-wrap leading-relaxed text-[13px] font-medium"
                                                x-text="msg.content" @mouseup="handleTextSelection($event)"></div>
                                            <template x-if="msg.image">
                                                <div :class="msg.content ? 'mt-3 -mx-2' : ''">
                                                    <a :href="msg.image" target="_blank">
                                                        <img :src="msg.image"
                                                            class="rounded-2xl border border-slate-700/50 max-w-full shadow-2xl hover:brightness-110 transition-all cursor-zoom-in">
                                                    </a>

                                                    <!-- Manual Image Actions -->
                                                    <div class="snapshot-actions">
                                                        <div class="favorite-dropdown">
                                                            <button @click.stop="toggleManualImageFavorite(msg.id, msg.is_favorite)"
                                                                @mouseenter="showManualFavoriteMenu(msg.id)"
                                                                class="favorite-btn"
                                                                :class="{ 'active': msg.is_favorite }">
                                                                <i :class="msg.is_favorite ? 'fa-solid fa-heart' : 'fa-regular fa-heart'"></i>
                                                            </button>

                                                            <div class="favorite-menu"
                                                                :id="'manual-fav-menu-' + msg.id"
                                                                :class="{ 'hidden': !msg.favoriteMenuVisible }">
                                                                <template x-if="msg.is_favorite">
                                                                    <div>
                                                                        <div class="menu-item" @click="toggleManualImageFavorite(msg.id, true)">
                                                                            <i class="fa-solid fa-heart text-red-500"></i>
                                                                            <span>Keep favorited</span>
                                                                        </div>
                                                                        <div class="menu-item" @click="toggleManualImageFavorite(msg.id, false)">
                                                                            <i class="fa-solid fa-trash text-slate-400"></i>
                                                                            <span>Remove from favorites</span>
                                                                        </div>
                                                                    </div>
                                                                </template>
                                                                <template x-if="!msg.is_favorite">
                                                                    <div class="menu-item" @click="toggleManualImageFavorite(msg.id, true)">
                                                                        <i class="fa-regular fa-heart text-slate-400"></i>
                                                                        <span>Add to favorites</span>
                                                                    </div>
                                                                </template>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </template>

                                            <!-- Snapshot Message -->
                                            <template x-if="msg.snapshot">
                                                <div class="mt-3 -mx-2">
                                                    <div class="bg-slate-800/50 rounded-xl p-3 border border-purple-600/50">
                                                        <div class="flex justify-between items-center mb-2">
                                                            <div class="flex items-center gap-2">
                                                                <i class="fa-solid fa-camera text-purple-400"></i>
                                                                <span class="text-[10px] text-purple-300 font-bold uppercase tracking-widest">Scene Snapshot</span>
                                                            </div>
                                                            <button @click="msg.showDetails = !msg.showDetails"
                                                                class="text-[9px] text-slate-400 hover:text-slate-200 uppercase font-bold tracking-widest">
                                                                <i class="fa-solid mr-1" :class="msg.showDetails ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
                                                                <span x-text="msg.showDetails ? 'Hide Details' : 'Show Details'"></span>
                                                            </button>
                                                        </div>

                                                        <!-- Snapshot Image -->
                                                        <img :src="msg.snapshot.image_url"
                                                            class="rounded-xl w-full border border-slate-700 shadow-lg">

                                                        <!-- Snapshot Actions -->
                                                        <div class="snapshot-actions">
                                                            <div class="favorite-dropdown">
                                                                <button @click.stop="toggleSnapshotFavorite(msg.id, msg.snapshot.is_favorite)"
                                                                    @mouseenter="showFavoriteMenu(msg.id)"
                                                                    class="favorite-btn"
                                                                    :class="{ 'active': msg.snapshot.is_favorite }">
                                                                    <i :class="msg.snapshot.is_favorite ? 'fa-solid fa-heart' : 'fa-regular fa-heart'"></i>
                                                                </button>

                                                                <div class="favorite-menu"
                                                                    :id="'fav-menu-' + msg.id"
                                                                    :class="{ 'hidden': !msg.favoriteMenuVisible }">
                                                                    <template x-if="msg.snapshot.is_favorite">
                                                                        <div>
                                                                            <div class="menu-item" @click="toggleSnapshotFavorite(msg.id, true)">
                                                                                <i class="fa-solid fa-heart text-red-500"></i>
                                                                                <span>Keep favorited</span>
                                                                            </div>
                                                                            <div class="menu-item" @click="toggleSnapshotFavorite(msg.id, false)">
                                                                                <i class="fa-solid fa-trash text-slate-400"></i>
                                                                                <span>Remove from favorites</span>
                                                                            </div>
                                                                        </div>
                                                                    </template>
                                                                    <template x-if="!msg.snapshot.is_favorite">
                                                                        <div class="menu-item" @click="toggleSnapshotFavorite(msg.id, true)">
                                                                            <i class="fa-regular fa-heart text-slate-400"></i>
                                                                            <span>Add to favorites</span>
                                                                        </div>
                                                                    </template>
                                                                </div>
                                                            </div>

                                                            <button @click="regenerateSnapshot()"
                                                                    class="regenerate-btn"
                                                                    :disabled="isGeneratingSnapshot"
                                                                    title="Regenerate with variation mode">
                                                                <i class="fa-solid fa-rotate" :class="{ 'regenerating': isGeneratingSnapshot }"></i>
                                                            </button>

                                                            <button @click="msg.showDetails = !msg.showDetails"
                                                                    class="details-btn"
                                                                    title="Show prompt details">
                                                                <i class="fa-solid fa-list-ul"></i>
                                                            </button>
                                                        </div>

                                                        <!-- Scene Analysis Details (Toggleable) -->
                                                        <div x-show="msg.showDetails" x-transition class="mt-3 space-y-2">
                                                            <div class="bg-slate-950/50 rounded-lg p-2">
                                                                <div class="text-[9px] text-slate-400 font-bold uppercase mb-1">Scene Type</div>
                                                                <div class="text-[10px] text-slate-200" x-text="msg.snapshot.scene_analysis.scene_type"></div>
                                                            </div>
                                                            <div class="bg-slate-950/50 rounded-lg p-2">
                                                                <div class="text-[9px] text-slate-400 font-bold uppercase mb-1">Setting</div>
                                                                <div class="text-[10px] text-slate-200" x-text="msg.snapshot.scene_analysis.setting || 'Unknown'"></div>
                                                            </div>
                                                            <div class="bg-slate-950/50 rounded-lg p-2">
                                                                <div class="text-[9px] text-slate-400 font-bold uppercase mb-1">Mood</div>
                                                                <div class="text-[10px] text-slate-200" x-text="msg.snapshot.scene_analysis.mood || 'Unknown'"></div>
                                                            </div>
                                                            <div class="bg-slate-950/50 rounded-lg p-2">
                                                                <div class="text-[9px] text-slate-400 font-bold uppercase mb-1">Prompt</div>
                                                                <div class="text-[9px] text-slate-300 font-mono break-all" x-text="msg.snapshot.prompt"></div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </template>
                                        </div>
                                    </template>

                                    <!-- Edit Interface -->
                                    <template x-if="editingMessageId === msg.id">
                                        <div class="space-y-3">
                                            <textarea x-model="editBuffer" x-ref="editTextarea"
                                                @input="$el.style.height = 'auto'; $el.style.height = $el.scrollHeight + 'px'"
                                                x-init="$nextTick(() => { $el.style.height = 'auto'; $el.style.height = $el.scrollHeight + 'px'; })"
                                                class="w-full bg-slate-900/50 text-slate-100 outline-none text-[13px] font-medium leading-relaxed resize-none min-h-[100px] max-h-[600px] overflow-y-auto border border-slate-600/30 rounded-lg p-3 focus:border-blue-500/50 transition-colors"
                                                placeholder="Edit your message..."></textarea>
                                            <div class="flex gap-2 justify-end">
                                                <button @click="updateMessage(index)"
                                                    class="px-3 py-1 bg-blue-500 hover:bg-blue-400 text-white text-[10px] font-black uppercase tracking-widest rounded-lg transition-all">Update</button>
                                                <button @click="editingMessageId = null; editingWidth = null"
                                                    class="px-3 py-1 bg-slate-700 hover:bg-slate-600 text-white text-[10px] font-black uppercase tracking-widest rounded-lg transition-all">Cancel</button>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </div>
                    </template>

                    <div x-show="isLoading || isGeneratingSnapshot" class="flex justify-start" x-cloak>
                        <div class="bg-slate-800/50 border border-slate-700/50 rounded-2xl rounded-tl-[4px] px-5 py-4">
                            <div class="flex gap-2 item-center">
                                <div class="w-1.5 h-1.5 bg-blue-500 rounded-full animate-bounce"></div>
                                <div class="w-1.5 h-1.5 bg-blue-500 rounded-full animate-bounce"
                                    style="animation-delay: 0.2s"></div>
                                <div class="w-1.5 h-1.5 bg-blue-500 rounded-full animate-bounce"
                                    style="animation-delay: 0.4s"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Image Generator (Collapsible) -->
            <div class="bg-slate-800 border-t border-slate-700 transition-all duration-500 ease-in-out overflow-hidden z-20 shadow-2xl shrink-0"
                :class="showImagePanel ? 'max-h-[500px]' : 'max-h-0 border-transparent'">
                <div class="p-6 space-y-6 w-full">
                    <div class="flex flex-col md:flex-row gap-6">
                        <div class="flex-1">
                            <label
                                class="text-[9px] text-slate-500 uppercase font-black mb-2 block tracking-widest">Vision
                                Input</label>
                            <textarea x-model="sdParams.prompt"
                                class="w-full bg-slate-900 border border-slate-700 rounded-2xl p-4 text-xs h-28 resize-none focus:ring-2 focus:ring-purple-500/30 outline-none transition-all font-mono leading-relaxed"
                                placeholder="Prompt..."></textarea>
                        </div>
                        <div class="flex-1">
                            <label
                                class="text-[9px] text-slate-500 uppercase font-black mb-2 block tracking-widest">Negative
                                Prompt</label>
                            <textarea x-model="sdParams.negative_prompt"
                                class="w-full bg-slate-950 border border-slate-700 rounded-2xl p-4 text-xs h-28 resize-none focus:ring-2 focus:ring-red-500/30 outline-none transition-all font-mono leading-relaxed"
                                placeholder="Omit..."></textarea>
                        </div>
                    </div>
                    <div class="flex flex-wrap items-center gap-8 pt-4 border-t border-slate-700/50">
                        <div class="flex gap-6 text-center">
                            <div class="flex flex-col gap-1.5">
                                <label
                                    class="text-[8px] text-slate-500 uppercase font-black tracking-widest">Steps</label>
                                <input type="number" x-model.number="sdParams.steps"
                                    class="w-16 bg-slate-950 border border-slate-700 rounded-lg px-2 py-1.5 text-xs outline-none focus:border-purple-500 font-bold">
                            </div>
                            <div class="flex flex-col gap-1.5">
                                <label
                                    class="text-[8px] text-slate-500 uppercase font-black tracking-widest">Scale</label>
                                <input type="number" step="0.5" x-model.number="sdParams.cfg_scale"
                                    class="w-16 bg-slate-950 border border-slate-700 rounded-lg px-2 py-1.5 text-xs outline-none focus:border-purple-500 font-bold">
                            </div>
                            <div class="flex flex-col gap-1.5">
                                <label
                                    class="text-[8px] text-slate-500 uppercase font-black tracking-widest">Resolution</label>
                                <div class="flex items-center gap-2">
                                    <input type="number" x-model.number="sdParams.width"
                                        class="w-16 bg-slate-950 border border-slate-700 rounded-lg px-2 py-1.5 text-xs outline-none focus:border-purple-500 font-bold">
                                    <span class="text-slate-600 text-[10px] font-black">×</span>
                                    <input type="number" x-model.number="sdParams.height"
                                        class="w-16 bg-slate-950 border border-slate-700 rounded-lg px-2 py-1.5 text-xs outline-none focus:border-purple-500 font-bold">
                                </div>
                            </div>
                        </div>
                        <div class="flex-1 flex justify-end gap-3">
                            <button @click="generateImage()"
                                class="bg-purple-600 hover:bg-purple-500 text-white px-8 py-3 rounded-2xl text-xs font-black uppercase tracking-[0.2em] shadow-xl shadow-purple-900/40 transition-all active:scale-95 disabled:opacity-50 flex items-center gap-3"
                                :disabled="isLoading">
                                <span x-show="!isLoading">Generate Vision Sequence</span>
                                <span x-show="isLoading">Generating...</span>
                                <i class="fa-solid"
                                    :class="isLoading ? 'fa-spinner fa-spin' : 'fa-wand-magic-sparkles'"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Context Menu for NPC Creation -->
            <div x-show="showNPCCreateMenu" class="fixed bg-slate-900 border border-slate-700 rounded-lg shadow-xl z-50"
                :style="`top: ${menuY}px; left: ${menuX}px;`" @click.away="showNPCCreateMenu = false" x-cloak>
                <button @click="createNPCFromSelection()"
                    class="px-4 py-2 text-sm text-white hover:bg-blue-600 rounded-t-lg w-full text-left flex items-center gap-2 transition-all"
                    :disabled="isCreatingNPC">
                    <i class="fa-solid fa-wand-magic-sparkles text-blue-400"></i>
                    <span>Create NPC from selection</span>
                </button>
                <button @click="showNPCCreateMenu = false"
                    class="px-4 py-2 text-sm text-slate-400 hover:bg-slate-700 hover:text-white rounded-b-lg w-full text-left transition-all">Cancel</button>
            </div>

            <!-- Input Area -->
            <div
                class="p-6 bg-slate-800 border-t border-slate-700 flex flex-col gap-2 shrink-0 z-10 shadow-[0_-10px_30px_-5px_rgba(0,0,0,0.3)]">
                <!-- Token Counter Display -->
                <div class="flex justify-between items-center px-4">
                    <div class="text-[9px] font-black tracking-widest uppercase text-slate-500 flex items-center gap-2">
                        <span
                            :class="tokenCount > settings.max_context * 0.85 ? 'text-orange-500' : 'text-slate-500'">Context:
                            <span x-text="tokenCount">0</span> / <span x-text="settings.max_context">4096</span></span>
                        <template x-if="isCountingTokens">
                            <i class="fa-solid fa-circle-notch fa-spin text-blue-500"></i>
                        </template>
                    </div>
                    <button @click="updateTokenCount()"
                        class="text-[9px] font-bold text-blue-400 hover:text-blue-300 transition-colors uppercase tracking-tight">Manual
                        Refresh</button>
                </div>

                <div class="flex gap-4 items-end">
                    <!-- Create NPC Button -->
                    <button @click="showNPCCreateDialog = true"
                        class="p-4 rounded-2xl transition-all relative group shadow-lg shadow-black/20"
                        :class="showNPCCreateDialog ? 'bg-green-600 text-white shadow-green-900/40' : 'bg-slate-700/50 text-slate-400 hover:bg-slate-700 hover:text-slate-200'"
                        :disabled="!currentChatId || isLoading" title="Create NPC from description">
                        <i class="fa-solid fa-user-plus text-lg group-hover:scale-110 transition-transform"></i>
                        <div x-show="!currentChatId"
                            class="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full shadow-lg shadow-red-900/40">
                        </div>
                    </button>

                    <button @click="showImagePanel = !showImagePanel"
                        class="p-4 rounded-2xl transition-all relative group shadow-lg shadow-black/20"
                        :class="showImagePanel ? 'bg-purple-600 text-white shadow-purple-900/40' : 'bg-slate-700/50 text-slate-400 hover:bg-slate-700 hover:text-slate-200'"
                        :disabled="!canGenerateImages() || isLoading">
                        <i class="fa-solid fa-wand-magic-sparkles text-lg group-hover:scale-110 transition-transform"
                            :class="!canGenerateImages() ? 'opacity-50' : ''"></i>
                        <div x-show="!canGenerateImages()"
                            class="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full shadow-lg shadow-red-900/40">
                        </div>
                    </button>

                    <!-- Mode Selector Dropdown -->
                    <div class="relative">
                        <select x-model="selectedMode"
                            class="appearance-none bg-slate-700/50 border border-slate-600 text-slate-300 rounded-2xl px-4 py-3 pr-10 text-[10px] font-bold uppercase tracking-widest outline-none focus:ring-2 focus:ring-blue-500/30 cursor-pointer shadow-lg shadow-black/20 hover:bg-slate-700 transition-all"
                            :class="isClassifyingMode ? 'opacity-50' : ''" :disabled="!canGenerateText()">
                            <option value="auto">🤖 Auto</option>
                            <option value="narrator">🎭 Narrator</option>
                            <template x-for="char in activeCharactersWithData()" :key="char.data.name">
                                <option :value="'focus:' + char.data.name" x-text="'👤 ' + char.data.name"></option>
                            </template>
                        </select>
                        <div class="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-slate-500">
                            <i class="fa-solid fa-chevron-down text-[8px]" x-show="!isClassifyingMode"></i>
                            <i class="fa-solid fa-circle-notch fa-spin text-[10px] text-blue-400"
                                x-show="isClassifyingMode"></i>
                        </div>
                        <div x-show="!canGenerateText()"
                            class="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full shadow-lg shadow-red-900/40">
                        </div>
                    </div>

                    <div class="flex-1 relative group">
                        <textarea x-model="input" @keydown.enter="if(!$event.shiftKey) { $event.preventDefault(); sendMessage(); }"
                            class="w-full bg-slate-950/50 border border-slate-700 rounded-[24px] p-4 pr-14 max-h-44 resize-none focus:ring-2 focus:ring-blue-500/20 border-slate-700/50 outline-none text-[13px] font-medium leading-relaxed transition-all shadow-inner"
                             :placeholder="activeCharactersWithData().length > 0 ? 'Chatting with party...' : 'Input neural prompt...'"
                            :disabled="!canGenerateText() || isLoading" rows="1"></textarea>

                        <!-- Snapshot Button -->
                        <button @click="generateSnapshot()"
                            class="absolute right-14 bottom-2.5 p-3 bg-purple-600 hover:bg-purple-500 rounded-2xl text-white shadow-xl shadow-purple-900/40 disabled:opacity-20 transition-all active:scale-90"
                            :disabled="isLoading || !currentChatId"
                            title="Generate Scene Snapshot">
                            <i class="fa-solid fa-camera"></i>
                            <!-- SD Unavailable Indicator (Red Light) -->
                            <div x-show="!sdAvailable"
                                class="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full shadow-lg shadow-red-900/40 animate-pulse">
                            </div>
                        </button>

                        <button @click="sendMessage()"
                            class="absolute right-2.5 bottom-2.5 p-3 bg-blue-600 hover:bg-blue-500 rounded-2xl text-white shadow-xl shadow-blue-900/40 disabled:opacity-20 transition-all active:scale-90"
                            :disabled="!input.trim() || isLoading || !canGenerateText()">
                            <i class="fa-solid fa-paper-plane"></i>
                        </button>
                        <div x-show="!canGenerateText()"
                            class="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full shadow-lg shadow-red-900/40">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Fork Dialog Modal -->
    <div x-show="showForkDialog"
        class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-950/80 backdrop-blur-sm" x-cloak
        x-transition>
        <div class="bg-slate-900 border border-slate-700 w-full max-w-md rounded-3xl shadow-2xl overflow-hidden">
            <div class="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-800/50">
                <h2 class="text-xs font-black uppercase tracking-widest text-blue-400">Create Branch</h2>
                <button @click="showForkDialog = false" class="text-slate-400 hover:text-white"><i
                        class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <div class="space-y-2">
                    <label class="text-[10px] text-slate-500 uppercase font-black tracking-widest">Branch Name</label>
                    <input x-model="forkBranchName"
                        class="w-full bg-slate-950 border border-slate-700 rounded-xl px-4 py-2 text-sm outline-none focus:ring-2 focus:ring-blue-500/30"
                        placeholder="e.g. 'Accepted the deal' or 'Refused the deal'">
                </div>
                <div class="text-[9px] text-slate-500 leading-relaxed">
                    <p class="font-bold mb-1">Forking creates a new independent chat session</p>
                    <p>This branch will start from the selected message and maintain all current context (characters,
                        world info, settings).</p>
                </div>
            </div>
            <div class="p-4 border-t border-slate-700 bg-slate-800/30 flex gap-3">
                <button @click="createFork()"
                    class="flex-1 bg-blue-600 hover:bg-blue-500 text-white py-3 rounded-2xl text-[11px] font-black uppercase tracking-widest shadow-lg shadow-blue-900/20 transition-all"
                    :disabled="!forkBranchName || isForking">
                    <span x-show="!isForking">Create Branch</span>
                    <span x-show="isForking">Creating...</span>
                </button>
                <button @click="showForkDialog = false"
                    class="px-6 bg-slate-700 hover:bg-slate-600 text-white rounded-2xl text-[11px] font-black uppercase tracking-widest transition-all">Cancel</button>
            </div>
        </div>
    </div>

    <!-- NPC Creation Dialog -->
    <div x-show="showNPCCreateDialog"
        class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-950/80 backdrop-blur-sm" x-cloak
        x-transition>
        <div class="bg-slate-900 border border-slate-700 w-full max-w-md rounded-3xl shadow-2xl overflow-hidden">
            <div class="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-800/50">
                <h2 class="text-xs font-black uppercase tracking-widest text-blue-400">Create NPC from Description</h2>
                <button @click="showNPCCreateDialog = false" class="text-slate-400 hover:text-white">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            <div class="p-6 space-y-4">
                <div class="space-y-2">
                    <label class="text-[10px] text-slate-500 uppercase font-black tracking-widest">NPC Name</label>
                    <input x-model="npcName"
                        class="w-full bg-slate-950 border border-slate-700 rounded-xl p-3 text-xs outline-none focus:ring-2 focus:ring-blue-500/30"
                        placeholder="e.g., 'Captain Morgan' (leave empty for auto-generated)"
                        :disabled="isCreatingNPC">
                </div>

                <!-- Gender Toggle -->
                <div class="space-y-2">
                    <label class="text-[10px] text-slate-500 uppercase font-black tracking-widest">Gender</label>
                    <div class="flex gap-2">
                        <button @click="npcGender = 'female'"
                            :class="npcGender === 'female' ? 'bg-pink-600 border-pink-500 text-white' : 'bg-slate-800 border-slate-700 text-slate-400 hover:bg-slate-700'"
                            class="flex-1 py-2 px-3 rounded-xl text-[10px] font-bold uppercase border transition-all"
                            :disabled="isCreatingNPC">
                            Female
                        </button>
                        <button @click="npcGender = 'male'"
                            :class="npcGender === 'male' ? 'bg-blue-600 border-blue-500 text-white' : 'bg-slate-800 border-slate-700 text-slate-400 hover:bg-slate-700'"
                            class="flex-1 py-2 px-3 rounded-xl text-[10px] font-bold uppercase border transition-all"
                            :disabled="isCreatingNPC">
                            Male
                        </button>
                        <button @click="npcGender = 'other'"
                            :class="npcGender === 'other' ? 'bg-purple-600 border-purple-500 text-white' : 'bg-slate-800 border-slate-700 text-slate-400 hover:bg-slate-700'"
                            class="flex-1 py-2 px-3 rounded-xl text-[10px] font-bold uppercase border transition-all"
                            :disabled="isCreatingNPC">
                            Other
                        </button>
                    </div>
                </div>

                <div class="space-y-2">
                    <label class="text-[10px] text-slate-500 uppercase font-black tracking-widest">Describe
                        NPC</label>
                    <textarea x-model="npcDescription"
                        class="w-full bg-slate-950 border border-slate-700 rounded-xl p-4 text-xs h-32 outline-none focus:ring-2 focus:ring-blue-500/30 font-medium leading-relaxed resize-none"
                        placeholder="e.g., 'A grizzled bartender with a cybernetic arm and weary eyes who has seen too much...'"
                        :disabled="isCreatingNPC"></textarea>
                </div>
                <div class="text-[9px] text-slate-500 leading-relaxed">
                    <p class="font-bold mb-1">AI will generate a complete character card from your description</p>
                    <p class="mb-1">Tip: Include hair color, eye color, hair style, and body type for Danbooru tag matching.</p>
                    <p>This NPC will be saved to the current chat only (not global characters).</p>
                </div>
            </div>
            <div class="p-4 border-t border-slate-700 bg-slate-800/30 flex gap-3">
                <button @click="createNPCFromDescription()"
                    class="flex-1 bg-blue-600 hover:bg-blue-500 text-white py-3 rounded-2xl text-[11px] font-black uppercase tracking-widest shadow-lg shadow-blue-900/20 transition-all flex items-center justify-center gap-2"
                    :disabled="isCreatingNPC">
                    <i x-show="isCreatingNPC" class="fa-solid fa-circle-notch fa-spin"></i>
                    <i x-show="!isCreatingNPC" class="fa-solid fa-wand-magic-sparkles"></i>
                    <span x-show="!isCreatingNPC">Generate NPC</span>
                    <span x-show="isCreatingNPC">Generating...</span>
                </button>
                <button @click="showNPCCreateDialog = false"
                    class="px-6 bg-slate-700 hover:bg-slate-600 text-white rounded-2xl text-[11px] font-black uppercase tracking-widest transition-all"
                    :disabled="isCreatingNPC">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Character Card Generation Modal -->
    <div x-show="showCardGen"
        class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-950/80 backdrop-blur-sm" x-cloak
        x-transition>
        <div
            class="bg-slate-900 border border-slate-700 w-full max-w-5xl rounded-3xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
            <div class="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-800/50">
                <h2 class="text-xs font-black uppercase tracking-widest text-blue-400">Generate Character Card from Chat
                </h2>
                <button @click="showCardGen = false" class="text-slate-400 hover:text-white"><i
                        class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto p-6 space-y-6">
                <!-- Source Mode Selector -->
                <div class="flex gap-4 p-4 bg-slate-950/30 rounded-2xl border border-slate-700/50">
                    <button @click="cardGen.source_mode = 'chat'"
                        class="flex-1 py-2 px-4 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all border"
                        :class="cardGen.source_mode === 'chat' ? 'bg-blue-600 border-blue-500 text-white shadow-lg shadow-blue-900/20' : 'bg-slate-800 border-slate-700 text-slate-500 hover:text-slate-300'">
                        <i class="fa-solid fa-comments mr-2"></i>Current Chat
                    </button>
                    <button @click="cardGen.source_mode = 'manual'"
                        class="flex-1 py-2 px-4 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all border"
                        :class="cardGen.source_mode === 'manual' ? 'bg-blue-600 border-blue-500 text-white shadow-lg shadow-blue-900/20' : 'bg-slate-800 border-slate-700 text-slate-500 hover:text-slate-300'">
                        <i class="fa-solid fa-file-lines mr-2"></i>Manual Input
                    </button>
                </div>

                <!-- Manual Input Area -->
                <div x-show="cardGen.source_mode === 'manual'" x-transition class="space-y-2">
                    <label class="text-[10px] text-slate-500 uppercase font-black tracking-widest">Manual Verbiage /
                        Description</label>
                    <textarea x-model="cardGen.manual_text"
                        class="w-full bg-slate-950 border border-slate-700 rounded-xl p-4 text-xs h-32 outline-none focus:ring-2 focus:ring-blue-500/30 font-medium leading-relaxed"
                        placeholder="Paste any plain-text description, story snippets, or details about the character here. The LLM will use this as the source for generation."></textarea>
                </div>

                <div class="space-y-2">
                    <label class="text-[10px] text-slate-500 uppercase font-black tracking-widest">Target Character
                        Name</label>
                    <div class="flex gap-2">
                        <input x-model="cardGen.char_name"
                            class="flex-1 bg-slate-950 border border-slate-700 rounded-xl px-4 py-2 text-sm outline-none focus:ring-2 focus:ring-blue-500/30"
                            placeholder="e.g. Mark, Sarah, The Barkeeper...">
                        <button @click="generateAllFields()"
                            class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest shadow-lg shadow-blue-900/20 transition-all"
                            :disabled="!cardGen.char_name || isGenLoading">
                            <span x-show="!isGenLoading">Auto-Generate All</span>
                            <i x-show="isGenLoading" class="fa-solid fa-circle-notch fa-spin"></i>
                        </button>
                    </div>
                </div>

                <!-- Gender Toggle -->
                <div class="space-y-2">
                    <label class="text-[10px] text-slate-500 uppercase font-black tracking-widest">Gender</label>
                    <div class="flex gap-2">
                        <button @click="cardGen.gender = 'female'"
                            :class="cardGen.gender === 'female' ? 'bg-pink-600 border-pink-500 text-white' : 'bg-slate-800 border-slate-700 text-slate-400 hover:bg-slate-700'"
                            class="flex-1 py-2 px-3 rounded-xl text-[10px] font-bold uppercase border transition-all">
                            Female
                        </button>
                        <button @click="cardGen.gender = 'male'"
                            :class="cardGen.gender === 'male' ? 'bg-blue-600 border-blue-500 text-white' : 'bg-slate-800 border-slate-700 text-slate-400 hover:bg-slate-700'"
                            class="flex-1 py-2 px-3 rounded-xl text-[10px] font-bold uppercase border transition-all">
                            Male
                        </button>
                        <button @click="cardGen.gender = 'other'"
                            :class="cardGen.gender === 'other' ? 'bg-purple-600 border-purple-500 text-white' : 'bg-slate-800 border-slate-700 text-slate-400 hover:bg-slate-700'"
                            class="flex-1 py-2 px-3 rounded-xl text-[10px] font-bold uppercase border transition-all">
                            Other
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Personality -->
                    <div class="space-y-2">
                        <div class="flex justify-between items-center">
                            <label class="text-[9px] text-slate-500 uppercase font-black tracking-widest">Personality (PList)</label>
                            <button @click="generateField('personality')"
                                class="text-[8px] text-blue-400 hover:text-blue-300 font-bold uppercase"
                                :disabled="cardGen.loading && cardGen.loading.personality">
                                <i class="fa-solid mr-1"
                                    :class="cardGen.loading && cardGen.loading.personality ? 'fa-circle-notch fa-spin' : 'fa-wand-magic-sparkles'"></i>Gen
                            </button>
                        </div>
                        <textarea x-model="cardGen.fields.personality"
                            class="w-full bg-slate-950 border border-slate-700 rounded-xl p-3 text-[10px] h-32 outline-none focus:ring-1 focus:ring-blue-500/50 font-mono"
                            placeholder="Personality traits in PList format..."></textarea>
                    </div>

                    <!-- Body -->
                    <div class="space-y-2">
                        <div class="flex justify-between items-center">
                            <label class="text-[9px] text-slate-500 uppercase font-black tracking-widest">Physical Body (PList)</label>
                            <button @click="generateField('body')"
                                class="text-[8px] text-blue-400 hover:text-blue-300 font-bold uppercase"
                                :disabled="cardGen.loading && cardGen.loading.body">
                                <i class="fa-solid mr-1"
                                    :class="cardGen.loading && cardGen.loading.body ? 'fa-circle-notch fa-spin' : 'fa-wand-magic-sparkles'"></i>Gen
                            </button>
                        </div>
                        <textarea x-model="cardGen.fields.body"
                            class="w-full bg-slate-950 border border-slate-700 rounded-xl p-3 text-[10px] h-32 outline-none focus:ring-1 focus:ring-blue-500/50 font-mono"
                            placeholder="Physical appearance..."></textarea>
                    </div>

                    <!-- Genre & Tags -->
                    <div class="space-y-2">
                        <div class="flex justify-between items-center">
                            <label class="text-[9px] text-slate-500 uppercase font-black tracking-widest">Genre & Tags</label>
                            <button @click="generateField('genre'); generateField('tags')"
                                class="text-[8px] text-blue-400 hover:text-blue-300 font-bold uppercase"
                                :disabled="cardGen.loading && (cardGen.loading.genre || cardGen.loading.tags)">
                                <i class="fa-solid mr-1"
                                    :class="cardGen.loading && (cardGen.loading.genre || cardGen.loading.tags) ? 'fa-circle-notch fa-spin' : 'fa-wand-magic-sparkles'"></i>Gen
                            </button>
                        </div>
                        <div class="flex gap-2">
                            <input x-model="cardGen.fields.genre"
                                class="w-1/3 bg-slate-950 border border-slate-700 rounded-xl px-3 py-2 text-[10px] outline-none focus:ring-1 focus:ring-blue-500/50"
                                placeholder="Genre">
                            <input x-model="cardGen.fields.tags"
                                class="w-2/3 bg-slate-950 border border-slate-700 rounded-xl px-3 py-2 text-[10px] outline-none focus:ring-1 focus:ring-blue-500/50"
                                placeholder="Tags (comma separated)">
                        </div>
                    </div>

                    <!-- Scenario -->
                    <div class="space-y-2">
                        <div class="flex justify-between items-center">
                            <label class="text-[9px] text-slate-500 uppercase font-black tracking-widest">Scenario</label>
                            <button @click="generateField('scenario')"
                                class="text-[8px] text-blue-400 hover:text-blue-300 font-bold uppercase"
                                :disabled="cardGen.loading && cardGen.loading.scenario">
                                <i class="fa-solid mr-1"
                                    :class="cardGen.loading && cardGen.loading.scenario ? 'fa-circle-notch fa-spin' : 'fa-wand-magic-sparkles'"></i>Gen
                            </button>
                        </div>
                        <input x-model="cardGen.fields.scenario"
                            class="w-full bg-slate-950 border border-slate-700 rounded-xl px-3 py-2 text-[10px] outline-none focus:ring-1 focus:ring-blue-500/50"
                            placeholder="One sentence situation">
                    </div>

                    <!-- First Message -->
                    <div class="space-y-2">
                        <div class="flex justify-between items-center">
                            <label class="text-[9px] text-slate-500 uppercase font-black tracking-widest">First Message</label>
                            <button @click="generateField('first_message')"
                                class="text-[8px] text-blue-400 hover:text-blue-300 font-bold uppercase"
                                :disabled="cardGen.loading && cardGen.loading.first_message">
                                <i class="fa-solid mr-1"
                                    :class="cardGen.loading && cardGen.loading.first_message ? 'fa-circle-notch fa-spin' : 'fa-wand-magic-sparkles'"></i>Gen
                            </button>
                        </div>
                        <textarea x-model="cardGen.fields.first_message"
                            class="w-full bg-slate-950 border border-slate-700 rounded-xl p-3 text-[10px] h-24 outline-none focus:ring-1 focus:ring-blue-500/50 resize-none font-medium"
                            placeholder="Character's opening line..."></textarea>
                    </div>

                    <!-- Dialogue -->
                    <div class="space-y-2 md:col-span-2">
                        <div class="flex justify-between items-center">
                            <label class="text-[9px] text-slate-500 uppercase font-black tracking-widest">Example Dialogue</label>
                            <button @click="generateField('dialogue_likes'); generateField('dialogue_story')"
                                class="text-[8px] text-blue-400 hover:text-blue-300 font-bold uppercase"
                                :disabled="cardGen.loading && (cardGen.loading.dialogue_likes || cardGen.loading.dialogue_story)">
                                <i class="fa-solid mr-1"
                                    :class="cardGen.loading && (cardGen.loading.dialogue_likes || cardGen.loading.dialogue_story) ? 'fa-circle-notch fa-spin' : 'fa-wand-magic-sparkles'"></i>Gen
                            </button>
                        </div>
                        <textarea x-model="cardGen.fields.dialogue"
                            class="w-full bg-slate-950 border border-slate-700 rounded-xl p-3 text-[10px] h-32 outline-none focus:ring-1 focus:ring-blue-500/50 font-mono"
                            placeholder="Example dialogue with character..."></textarea>
                    </div>
                </div>

                <!-- Footer -->
                <div class="p-4 border-t border-slate-700 bg-slate-800/30 flex gap-3">
                    <button @click="saveGeneratedCard()"
                        class="flex-1 bg-green-600 hover:bg-green-500 text-white py-3 rounded-2xl text-[11px] font-black uppercase tracking-widest shadow-lg shadow-green-900/20 transition-all"
                        :disabled="!cardGen.char_name">Save Character Card</button>
                    <button @click="showCardGen = false"
                        class="px-6 bg-slate-700 hover:bg-slate-600 text-white rounded-2xl text-[11px] font-black uppercase tracking-widest transition-all">Cancel</button>
                </div>
            </div>
        </div>
    </div>

                                    <!-- Change History Modal -->
                                    <div x-show="showChangeHistory"
                                        class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-950/80 backdrop-blur-sm" x-cloak
                                        x-transition>
                                        <div
                                            class="bg-slate-900 border border-slate-700 w-full max-w-4xl rounded-3xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
                                            <div class="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-800/50">
                                                <h2 class="text-xs font-black uppercase tracking-widest text-orange-400">Change History</h2>
                                                <button @click="showChangeHistory = false" class="text-slate-400 hover:text-white"><i
                                                        class="fa-solid fa-xmark"></i></button>
                                            </div>
                                            <div class="flex-1 overflow-y-auto p-6 space-y-4">
                                                <!-- Filters -->
                                                <div class="flex gap-4 mb-4 p-4 bg-slate-800/50 rounded-xl border border-slate-700/50">
                                                    <div class="flex-1">
                                                        <label class="text-[10px] text-slate-500 uppercase font-bold tracking-widest">Entity Type</label>
                                                        <select x-model="changeHistoryFilters.entity_type" @change="fetchChangeHistory()"
                                                            class="w-full bg-slate-950 border border-slate-700 rounded-lg px-3 py-2 text-sm outline-none focus:ring-1 focus:ring-orange-500/30">
                                                            <option value="">All Types</option>
                                                            <option value="character">Character</option>
                                                            <option value="world_info">World Info</option>
                                                            <option value="chat">Chat</option>
                                                        </select>
                                                    </div>
                                                    <div class="flex-1">
                                                        <label class="text-[10px] text-slate-500 uppercase font-bold tracking-widest">Entity ID</label>
                                                        <input x-model="changeHistoryFilters.entity_id" @keydown.enter="fetchChangeHistory()"
                                                            class="w-full bg-slate-950 border border-slate-700 rounded-lg px-3 py-2 text-sm outline-none focus:ring-1 focus:ring-orange-500/30"
                                                            placeholder="e.g., alice.json, FantasyWorld">
                                                    </div>
                                                    <div class="w-32">
                                                        <label class="text-[10px] text-slate-500 uppercase font-bold tracking-widest">Limit</label>
                                                        <input type="number" x-model.number="changeHistoryFilters.limit"
                                                            @keydown.enter="fetchChangeHistory()"
                                                            class="w-full bg-slate-950 border border-slate-700 rounded-lg px-3 py-2 text-sm outline-none focus:ring-1 focus:ring-orange-500/30"
                                                            min="1" max="50">
                                                    </div>
                                                    <div class="flex items-end gap-2">
                                                        <button
                                                            @click="changeHistoryFilters = {entity_type: '', entityid: '', limit: 10}; fetchChangeHistory()"
                                                            class="px-3 py-2 bg-slate-700 hover:bg-slate-600 text-slate-300 text-[9px] font-bold uppercase tracking-widest rounded-lg transition-all">
                                                            <i class="fa-solid fa-eraser mr-1"></i>Clear
                                                        </button>
                                                        <button @click="fetchChangeHistory()"
                                                            class="px-3 py-2 bg-orange-600 hover:bg-orange-500 text-white text-[9px] font-bold uppercase tracking-widest rounded-lg shadow-lg shadow-orange-900/20 transition-all"
                                                            :disabled="isFetchingChanges">
                                                            <i class="fa-solid mr-1"
                                                                :class="isFetchingChanges ? 'fa-circle-notch fa-spin' : 'fa-refresh'"></i>Refresh
                                                        </button>
                                                    </div>
                                                </div>
                                    
                                                <!-- Loading State -->
                                                <div x-show="isFetchingChanges" class="text-center py-8">
                                                    <div class="inline-flex items-center gap-3">
                                                        <div class="w-8 h-8 border-4 border-orange-500/30 border-t-orange-500 rounded-full animate-spin">
                                                        </div>
                                                        <span class="text-sm text-slate-400">Loading change history...</span>
                                                    </div>
                                                </div>
                                    
                                                <!-- Empty State -->
                                                <template x-if="changeHistory.length === 0 && !isFetchingChanges">
                                                    <div class="text-center py-12">
                                                        <i class="fa-solid fa-clock-rotate-left text-6xl text-slate-600 mb-4"></i>
                                                        <h3 class="text-lg font-bold text-slate-400 mb-2">No Change History</h3>
                                                        <p class="text-sm text-slate-500">Once you make changes to characters, world info, or chats, they
                                                            will appear here.</p>
                                                    </div>
                                                </template>
                                    
                                                <!-- Change History Table -->
                                                <template x-if="changeHistory.length > 0">
                                                    <div class="overflow-x-auto rounded-xl border border-slate-700">
                                                        <table class="w-full text-left">
                                                            <thead>
                                                                <tr class="bg-slate-800 text-[10px] font-black uppercase tracking-widest">
                                                                    <th class="px-4 py-3 text-left border-b border-slate-600">Entity Type</th>
                                                                    <th class="px-4 py-3 text-left border-b border-slate-600">Entity ID</th>
                                                                    <th class="px-4 py-3 text-left border-b border-slate-600">Operation</th>
                                                                    <th class="px-4 py-3 text-left border-b border-slate-600">Timestamp</th>
                                                                    <th class="px-4 py-3 text-left border-b border-slate-600">Action</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                <template x-for="change in changeHistory" :key="change.id">
                                                                    <tr class="hover:bg-slate-800/50 transition-colors border-b border-slate-700/30">
                                                                        <td class="px-4 py-3">
                                                                            <span
                                                                                class="inline-block px-2 py-1 rounded-lg text-[10px] font-black uppercase tracking-widest"
                                                                                :class="{
                                                                                      'character': 'bg-blue-900/50 text-blue-400 border-blue-500/30',
                                                                                      'world_info': 'bg-green-900/50 text-green-400 border-green-500/30',
                                                                                      'chat': 'bg-purple-900/50 text-purple-400 border-purple-500/30'
                                                                                  }[change.entity_type]" x-text="change.entity_type"></span>
                                                                        </td>
                                                                        <td class="px-4 py-3">
                                                                            <span class="text-sm font-mono text-slate-300" x-text="change.entity_id"></span>
                                                                        </td>
                                                                        <td class="px-4 py-3">
                                                                            <span class="inline-block px-2 py-1 rounded text-[10px] font-black uppercase"
                                                                                :class="{
                                                                                      'CREATE': 'bg-green-600 text-white',
                                                                                      'UPDATE': 'bg-yellow-600 text-white',
                                                                                      'DELETE': 'bg-red-600 text-white'
                                                                                  }[change.operation]" x-text="change.operation"></span>
                                                                        </td>
                                                                        <td class="px-4 py-3 text-sm text-slate-500">
                                                                            <span x-text="formatChangeTimestamp(change.timestamp)"></span>
                                                                        </td>
                                                                        <td class="px-4 py-3">
                                                                            <button @click="restoreChange(change.id)"
                                                                                class="px-3 py-1.5 bg-orange-600 hover:bg-orange-500 text-white text-[10px] font-black uppercase tracking-widest rounded-lg transition-all shadow-lg shadow-orange-900/20"
                                                                                :disabled="!canRestoreChange(change) || isRestoringChange"
                                                                                :title="canRestoreChange(change) ? 'Restore this version' : 'CREATE operations cannot be restored'">
                                                                                <i class="fa-solid mr-1"
                                                                                    :class="isRestoringChange ? 'fa-circle-notch fa-spin' : 'fa-rotate-left'"></i>
                                                                                <span x-show="!isRestoringChange">Restore</span>
                                                                                <span x-show="isRestoringChange">Restoring...</span>
                                                                            </button>
                                                                        </td>
                                                                    </tr>
                                                                </template>
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </template>
                                            </div>
                                            <div class="p-4 border-t border-slate-700 bg-slate-800/30 flex gap-3 justify-end">
                                                <button @click="showChangeHistory = false"
                                                    class="px-6 bg-slate-700 hover:bg-slate-600 text-white rounded-xl text-[11px] font-black uppercase tracking-widest transition-all">Close</button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- World Info Generation Modal -->
    <div x-show="showWorldGen" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-950/80 backdrop-blur-sm" x-cloak x-transition>
        <div class="bg-slate-900 border border-slate-700 w-full max-w-6xl rounded-3xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
            <div class="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-800/50">
                <h2 class="text-xs font-black uppercase tracking-widest text-orange-400">World Evolution & Lore Extraction</h2>
                <button @click="showWorldGen = false" class="text-slate-400 hover:text-white"><i class="fa-solid fa-xmark"></i></button>
            </div>
            
            <div class="flex-1 overflow-y-auto p-6 space-y-6">
                <!-- Source Mode Selector -->
                <div class="flex gap-4 p-4 bg-slate-950/30 rounded-2xl border border-slate-700/50">
                    <button @click="worldGen.source_mode = 'chat'" 
                            class="flex-1 py-2 px-4 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all border"
                            :class="worldGen.source_mode === 'chat' ? 'bg-orange-600 border-orange-500 text-white shadow-lg shadow-orange-900/20' : 'bg-slate-800 border-slate-700 text-slate-500 hover:text-slate-300'">
                        <i class="fa-solid fa-comments mr-2"></i>Current Chat
                    </button>
                    <button @click="worldGen.source_mode = 'manual'" 
                            class="flex-1 py-2 px-4 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all border"
                            :class="worldGen.source_mode === 'manual' ? 'bg-orange-600 border-orange-500 text-white shadow-lg shadow-orange-900/20' : 'bg-slate-800 border-slate-700 text-slate-500 hover:text-slate-300'">
                        <i class="fa-solid fa-file-lines mr-2"></i>Manual Input
                    </button>
                </div>

                <!-- Manual Input Area -->
                <div x-show="worldGen.source_mode === 'manual'" x-transition class="space-y-2">
                    <label class="text-[10px] text-slate-500 uppercase font-black tracking-widest">Manual Lore / Background Verbiage</label>
                    <textarea x-model="worldGen.manual_text" 
                              class="w-full bg-slate-950 border border-slate-700 rounded-xl p-4 text-xs h-32 outline-none focus:ring-2 focus:ring-orange-500/30 font-medium leading-relaxed"
                              placeholder="Paste plain-text lore, history, or world details here. The LLM will extract PList entries from this text."></textarea>
                </div>

                <div class="space-y-2">
                    <label class="text-[10px] text-slate-500 uppercase font-black tracking-widest">World / Location Name</label>
                    <div class="flex gap-2">
                        <input x-model="worldGen.world_name" class="flex-1 bg-slate-950 border border-slate-700 rounded-xl px-4 py-2 text-sm outline-none focus:ring-2 focus:ring-orange-500/30" placeholder="e.g. Farlandia, Mystic Island...">
                        <button @click="generateAllWorldStuff()" class="bg-orange-600 hover:bg-orange-500 text-white px-4 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest shadow-lg shadow-orange-900/20 transition-all" :disabled="!worldGen.world_name || isWorldLoading">
                            <span x-show="!isWorldLoading">Analyze All Lore</span>
                            <i x-show="isWorldLoading" class="fa-solid fa-circle-notch fa-spin"></i>
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <template x-for="section in ['history', 'locations', 'creatures', 'factions']" :key="section">
                        <div class="space-y-2">
                            <div class="flex justify-between items-center">
                                <label class="text-[9px] text-slate-500 uppercase font-black tracking-widest" x-text="section"></label>
                                <button @click="generateWorldSection(section)" class="text-[8px] text-orange-400 hover:text-orange-300 font-bold uppercase" :disabled="worldGen.loading && worldGen.loading[section]">
                                    <i class="fa-solid mr-1" :class="worldGen.loading && worldGen.loading[section] ? 'fa-circle-notch fa-spin' : 'fa-wand-magic-sparkles'"></i>Extract</button>
                            </div>
                            <textarea x-model="worldGen.fields[section]" class="w-full bg-slate-950 border border-slate-700 rounded-xl p-3 text-[10px] h-32 outline-none focus:ring-1 focus:ring-orange-500/50 font-mono" :placeholder="'[Lore Entry: type(...), details(...)]'"></textarea>
                        </div>
                    </template>
                </div>
            </div>

            <div class="p-4 border-t border-slate-700 bg-slate-800/30 flex gap-3">
                <button @click="saveWorldEvolution()" class="flex-1 bg-green-600 hover:bg-green-500 text-white py-3 rounded-2xl text-[11px] font-black uppercase tracking-widest shadow-lg shadow-green-900/20 transition-all" :disabled="!worldGen.world_name">Finalize & Update World Lore</button>
                <button @click="showWorldGen = false" class="px-6 bg-slate-700 hover:bg-slate-600 text-white rounded-2xl text-[11px] font-black uppercase tracking-widest transition-all">Cancel</button>
            </div>
        </div>
    </div>

                                    <!-- Inpaint Dialog Modal -->
                                    <div x-show="showInpaintDialog"
                                        class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-950/80 backdrop-blur-sm" x-cloak
                                        x-transition>
                                        <div
                                            class="bg-slate-900 border border-slate-700 w-full max-w-6xl rounded-3xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
                                            <div class="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-800/50">
                                                <h2 class="text-xs font-black uppercase tracking-widest text-orange-400">Inpaint Image</h2>
                                                <button @click="closeInpaintDialog()" class="text-slate-400 hover:text-white"><i
                                                        class="fa-solid fa-xmark"></i></button>
                                            </div>
                                            <div class="flex-1 overflow-y-auto p-6 space-y-6">
                                                <!-- Inpaint Prompt -->
                                                <div class="space-y-2">
                                                    <label class="text-[10px] text-slate-500 uppercase font-black tracking-widest">Inpaint Prompt</label>
                                                    <textarea x-model="inpaintPrompt"
                                                        class="w-full bg-slate-950 border border-slate-700 rounded-xl p-4 text-xs h-24 outline-none focus:ring-2 focus:ring-orange-500/30 font-medium leading-relaxed"
                                                        placeholder="Describe what you want to paint in the masked area..."></textarea>
                                                </div>
                                    
                                                <!-- Denoising Strength Slider -->
                                                <div class="space-y-2 bg-slate-800/50 rounded-xl p-4 border border-slate-700/50">
                                                    <div class="flex justify-between items-center">
                                                        <label class="text-[10px] text-slate-500 uppercase font-black tracking-widest">Denoising
                                                            Strength</label>
                                                        <span class="text-sm font-bold text-orange-400" x-text="inpaintDenoisingStrength.toFixed(2)"></span>
                                                    </div>
                                                    <input type="range" x-model.number="inpaintDenoisingStrength" min="0" max="1" step="0.05"
                                                        class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-orange-500">
                                                    <div class="flex justify-between text-[8px] text-slate-500 uppercase font-bold">
                                                        <span>0 = Keep Original</span>
                                                        <span>0.5 = Balanced</span>
                                                        <span>1 = Full Inpaint</span>
                                                    </div>
                                                    <p class="text-[8px] text-slate-400 leading-relaxed mt-1">
                                                        <i class="fa-solid fa-info-circle mr-1 text-orange-400/70"></i>
                                                        Lower values preserve more of the original image. Higher values give the AI more creative freedom in
                                                        the masked area.
                                                    </p>
                                                </div>
                                    
                                                <!-- Canvas Container -->
                                                <div class="space-y-2">
                                                    <div class="flex justify-between items-center">
                                                        <label class="text-[10px] text-slate-500 uppercase font-black tracking-widest">Draw Mask (Brush over
                                                            areas to inpaint)</label>
                                                        <div class="flex items-center gap-3">
                                                            <span class="text-[9px] text-slate-500 uppercase font-bold">Brush Size:</span>
                                                            <input type="range" x-model.number="brushSize" min="5" max="100" step="5" class="w-32">
                                                            <span class="text-[9px] text-slate-400 font-mono" x-text="brushSize + 'px'"></span>
                                                            <!-- Eraser Toggle Button -->
                                                            <button @click="brushMode = brushMode === 'paint' ? 'eraser' : 'paint'"
                                                                class="p-2 rounded-lg transition-all"
                                                                :class="brushMode === 'paint' ? 'bg-blue-600 text-white' : 'bg-slate-700 text-slate-300'"
                                                                title="Toggle between paint and eraser">
                                                                <i :class="brushMode === 'paint' ? 'fa-solid fa-paintbrush' : 'fa-solid fa-eraser'"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                    <div class="relative bg-slate-950 rounded-xl border border-slate-700 overflow-auto" style="max-height: 60vh;"
                                                        tabindex="0" @keydown="handleInpaintKeyboard($event)">
                                                        <div class="relative inline-block">
                                                            <!-- Original Image -->
                                                            <img :src="inpaintImageUrl" id="inpaint-image" class="block" @load="initializeInpaintCanvas()"
                                                                style="max-width: none;">
                                                            <!-- Brush Cursor Indicator -->
                                                            <div id="brush-cursor" x-show="showBrushCursor"
                                                                class="absolute pointer-events-none rounded-full border-2 transition-none"
                                                                :class="brushMode === 'paint' ? 'border-white/80 bg-white/30 shadow-[0_0_8px_rgba(255,255,255,0.3)]' : 'border-black/80 bg-black/30 shadow-[0_0_8px_rgba(0,0,0,0.3)]'"
                                                                :style="{
                                                                     width: brushSize + 'px',
                                                                     height: brushSize + 'px',
                                                                     left: (brushCursorX - brushSize / 2) + 'px',
                                                                     top: (brushCursorY - brushSize / 2) + 'px'
                                                                 }"></div>
                                                            <!-- Canvas Overlay for drawing -->
                                                            <canvas id="inpaint-canvas" tabindex="0" class="absolute top-0 left-0"
                                                                @mousedown="startDrawing($event)" @mousemove="trackBrushCursor($event)"
                                                                @mouseup="stopDrawing()" @mouseleave="hideBrushCursor()"
                                                                @mouseenter="showBrushCursor = true" style="touch-action: none;"></canvas>
                                                        </div>
                                                    </div>
                                                    <div class="flex justify-between items-center px-2">
                                                        <div class="text-[8px] text-slate-500">
                                                            <span class="font-bold">Tip:</span> Press Ctrl+Z to undo brush strokes
                                                        </div>
                                                        <button @click="clearMask()"
                                                            class="text-[9px] text-slate-400 hover:text-slate-200 uppercase font-bold tracking-widest">
                                                            <i class="fa-solid fa-eraser mr-1"></i>Clear Mask
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                    
                                            <!-- Preview Mode: Clickable Images -->
                                            <template x-if="isPreviewMode">
                                                <div class="p-4 border-t border-slate-700 bg-slate-800/30">
                                                    <div class="space-y-3">
                                                        <div class="text-[10px] text-green-400 font-black uppercase tracking-widest text-center">✓ Preview
                                                            Ready - Click an image to choose</div>
                                                        <div class="grid grid-cols-2 gap-4">
                                                            <!-- Original Image - Click to Try Again -->
                                                            <div class="space-y-1 group">
                                                                <div
                                                                    class="text-[8px] text-slate-500 font-bold uppercase text-center group-hover:text-orange-400 transition-colors">
                                                                    Original</div>
                                                                <div class="relative cursor-pointer" @click="discardInpaint()">
                                                                    <img :src="originalImageBackup"
                                                                        class="rounded-xl border-2 border-slate-700 w-full shadow-lg transition-all duration-200 group-hover:border-orange-500 group-hover:shadow-orange-900/40 group-hover:brightness-90">
                                                                    <div
                                                                        class="absolute inset-0 rounded-xl bg-orange-500/0 group-hover:bg-orange-500/20 transition-all duration-200 flex items-center justify-center">
                                                                        <div
                                                                            class="opacity-0 group-hover:opacity-100 transition-opacity duration-200 bg-orange-600 text-white px-4 py-2 rounded-xl text-[11px] font-black uppercase tracking-widest shadow-lg">
                                                                            <i class="fa-solid fa-rotate mr-2"></i>Try Again
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <!-- Inpainted Image - Click to Accept -->
                                                            <div class="space-y-1 group">
                                                                <div
                                                                    class="text-[8px] text-green-400 font-bold uppercase text-center group-hover:text-green-300 transition-colors">
                                                                    Preview</div>
                                                                <div class="relative cursor-pointer" @click="acceptInpaint()">
                                                                    <img :src="inpaintPreviewUrl"
                                                                        class="rounded-xl border-2 border-green-500/50 w-full shadow-lg shadow-green-900/20 transition-all duration-200 group-hover:border-green-400 group-hover:shadow-green-500/40 group-hover:brightness-110">
                                                                    <div
                                                                        class="absolute inset-0 rounded-xl bg-green-500/0 group-hover:bg-green-500/20 transition-all duration-200 flex items-center justify-center">
                                                                        <div
                                                                            class="opacity-0 group-hover:opacity-100 transition-opacity duration-200 bg-green-600 text-white px-4 py-2 rounded-xl text-[11px] font-black uppercase tracking-widest shadow-lg">
                                                                            <i class="fa-solid fa-check mr-2"></i>Accept
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="flex justify-center pt-2">
                                                            <button @click="closeInpaintDialog()"
                                                                class="px-4 py-2 bg-slate-700/50 hover:bg-slate-600 text-slate-400 hover:text-white rounded-xl text-[9px] font-bold uppercase tracking-widest transition-all border border-slate-600/50">
                                                                <i class="fa-solid fa-xmark mr-1"></i>Cancel
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </template>
                                    
                                            <!-- Editing Mode: Show Generate Preview button -->
                                            <template x-if="!isPreviewMode">
                                                <div class="p-4 border-t border-slate-700 bg-slate-800/30 flex gap-3">
                                                    <button @click="generateInpaintPreview()"
                                                        class="flex-1 bg-orange-600 hover:bg-orange-500 text-white py-3 rounded-2xl text-[11px] font-black uppercase tracking-widest shadow-lg shadow-orange-900/20 transition-all"
                                                        :disabled="isInpainting">
                                                        <i class="fa-solid mr-2"
                                                            :class="isInpainting ? 'fa-circle-notch fa-spin' : 'fa-wand-magic-sparkles'"></i>
                                                        <span x-show="!isInpainting">Generate Preview</span>
                                                        <span x-show="isInpainting">Generating...</span>
                                                    </button>
                                                    <button @click="closeInpaintDialog()"
                                                        class="px-6 bg-slate-700 hover:bg-slate-600 text-white rounded-2xl text-[11px] font-black uppercase tracking-widest transition-all">Cancel</button>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                    
                                    <!-- Rename Branch Dialog -->
                                    <div x-show="showRenameDialog"
                                        class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-950/80 backdrop-blur-sm" x-cloak
                                        x-transition>
                                        <div class="bg-slate-900 border border-slate-700 w-full max-w-md rounded-3xl shadow-2xl overflow-hidden">
                                            <div class="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-800/50">
                                                <h2 class="text-xs font-black uppercase tracking-widest text-blue-400">Rename Branch</h2>
                                                <button @click="showRenameDialog = false" class="text-slate-400 hover:text-white"><i
                                                        class="fa-solid fa-xmark"></i></button>
                                            </div>
                                            <div class="p-6 space-y-4">
                                                <div class="space-y-2">
                                                    <label class="text-[10px] text-slate-500 uppercase font-black tracking-widest">New Branch Name</label>
                                                    <input x-model="renameBranchName"
                                                        class="w-full bg-slate-950 border border-slate-700 rounded-xl px-4 py-2 text-sm outline-none focus:ring-2 focus:ring-blue-500/30"
                                                        placeholder="Enter new branch name">
                                                </div>
                                            </div>
                                            <div class="p-4 border-t border-slate-700 bg-slate-800/30 flex gap-3">
                                                <button @click="renameBranch()"
                                                    class="flex-1 bg-yellow-600 hover:bg-yellow-500 text-white py-3 rounded-2xl text-[11px] font-black uppercase tracking-widest shadow-lg shadow-yellow-900/20 transition-all"
                                                    :disabled="!renameBranchName || isRenaming">
                                                    <span x-show="!isRenaming">Rename</span>
                                                    <span x-show="isRenaming">Renaming...</span>
                                                </button>
                                                <button @click="showRenameDialog = false"
                                                    class="px-6 bg-slate-700 hover:bg-slate-600 text-white rounded-2xl text-[11px] font-black uppercase tracking-widest transition-all">Cancel</button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Branch Management Dialog -->
                                    <div x-show="showBranchDialog"
                                        class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-950/80 backdrop-blur-sm" x-cloak
                                        x-transition>
                                        <div
                                            class="bg-slate-900 border border-slate-700 w-full max-w-2xl rounded-3xl shadow-2xl overflow-hidden flex flex-col max-h-[80vh]">
                                            <div class="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-800/50">
                                                <h2 class="text-xs font-black uppercase tracking-widest text-blue-400">Branch Management</h2>
                                                <button @click="showBranchDialog = false" class="text-slate-400 hover:text-white"><i
                                                        class="fa-solid fa-xmark"></i></button>
                                            </div>
                                            <div class="flex-1 overflow-y-auto p-6 space-y-4">
                                                <div class="text-[9px] text-slate-500 font-bold uppercase tracking-widest">Active Branches</div>
                                                <template x-if="currentChatBranches.length === 0">
                                                    <div class="text-[10px] text-slate-500 text-center py-8">No branches found for this chat.</div>
                                                </template>
                                                <template x-for="branch in currentChatBranches" :key="branch.name">
                                                    <div class="flex items-center justify-between p-3 bg-slate-800 rounded-xl border border-slate-700/50">
                                                        <div class="flex-1">
                                                            <div class="font-bold text-sm" x-text="branch.branch_name || branch.name"></div>
                                                            <div class="text-[9px] text-slate-500" x-text="'Created ' + formatTime(branch.createdat)"></div>
                                                        </div>
                                                        <div class="flex gap-2">
                                                            <button @click="loadChat(branch.name)"
                                                                class="px-3 py-1 bg-blue-600 hover:bg-blue-500 text-white text-[10px] font-black uppercase tracking-widest rounded-lg">Switch</button>
                                                            <button @click="renameBranchDialog(branch)"
                                                                class="px-3 py-1 bg-yellow-600 hover:bg-yellow-500 text-white text-[10px] font-black uppercase tracking-widest rounded-lg">Rename</button>
                                                            <button @click="deleteChat(branch.name)"
                                                                class="px-3 py-1 bg-red-600 hover:bg-red-500 text-white text-[10px] font-black uppercase tracking-widest rounded-lg">Delete</button>
                                                        </div>
                                                    </div>
                                                </template>
                                            </div>
                                            <div class="p-4 border-t border-slate-700 bg-slate-800/30 flex gap-3">
                                                <button @click="showBranchDialog = false"
                                                    class="px-6 bg-slate-700 hover:bg-slate-600 text-white rounded-2xl text-[11px] font-black uppercase tracking-widest transition-all">Close</button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Chat Settings Modal -->
                                    <div x-show="showChatSettings"
                                        class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-950/80 backdrop-blur-sm" x-cloak
                                        x-transition>
                                        <div
                                            class="bg-slate-900 border border-slate-700 w-full max-w-4xl rounded-3xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
                                            <div class="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-800/50">
                                                <h2 class="text-xs font-black uppercase tracking-widest text-blue-400">Chat Settings</h2>
                                                <button @click="showChatSettings = false" class="text-slate-400 hover:text-white">
                                                    <i class="fa-solid fa-xmark"></i>
                                                </button>
                                            </div>
                                            <div class="flex-1 overflow-hidden">

                                    
                                                <!-- Tab Content -->
                                                <div class="flex-1 overflow-y-auto p-6">

                                    

                                    

                                    
                                                    <!-- Export Tab -->
                                                    <div class="space-y-4">
                                                        <h3 class="text-[10px] font-black uppercase tracking-widest text-slate-400 mb-4">Export for Training</h3>
                                                    
                                                        <!-- Export Status -->
                                                        <div x-show="!currentChatId" class="bg-red-900/30 border border-red-600/50 rounded-xl p-4 text-center">
                                                            <i class="fa-solid fa-exclamation-triangle text-red-400 text-2xl mb-2"></i>
                                                            <p class="text-sm text-red-400">Please save or load a chat first before exporting.</p>
                                                        </div>
                                                    
                                                        <div x-show="currentChatId" class="export-section space-y-4">
                                                            <div class="bg-slate-800/50 rounded-xl p-4 border border-slate-700/50">
                                                                <h4 class="text-sm font-bold text-green-400 mb-2">Export Chat for LLM Fine-tuning</h4>
                                                                <p class="text-xs text-slate-400 mb-4">Export this chat in training format for fine-tuning LLMs (Unsloth,
                                                                    Axolotl, etc.)</p>
                                                    
                                                                <div class="export-options space-y-3">
                                                                    <div>
                                                                        <label class="text-[10px] text-slate-500 uppercase font-bold mb-2 block">Format</label>
                                                                        <select x-model="exportFormat"
                                                                            class="w-full bg-slate-950 border border-slate-700 rounded-lg px-3 py-2 text-xs outline-none focus:ring-1 focus:ring-green-500/30">
                                                                            <option value="alpaca">Alpaca (Instruction/Input/Output)</option>
                                                                            <option value="sharegpt">ShareGPT (Multi-turn)</option>
                                                                            <option value="chat-ml">ChatML</option>
                                                                        </select>
                                                                    </div>
                                                    
                                                                    <div class="space-y-2">
                                                                        <label class="flex items-center gap-2 text-sm cursor-pointer">
                                                                            <input type="checkbox" x-model="exportIncludeSystem"
                                                                                class="w-4 h-4 text-green-600 bg-slate-900 border-slate-700 rounded focus:ring-green-500">
                                                                            <span class="text-slate-300">Include system prompts</span>
                                                                        </label>
                                                                        <label class="flex items-center gap-2 text-sm cursor-pointer">
                                                                            <input type="checkbox" x-model="exportIncludeWorldInfo"
                                                                                class="w-4 h-4 text-green-600 bg-slate-900 border-slate-700 rounded focus:ring-green-500">
                                                                            <span class="text-slate-300">Include world info (Canon Law only)</span>
                                                                        </label>
                                                                        <label class="flex items-center gap-2 text-sm cursor-pointer">
                                                                            <input type="checkbox" x-model="exportIncludeNPCs"
                                                                                class="w-4 h-4 text-green-600 bg-slate-900 border-slate-700 rounded focus:ring-green-500">
                                                                            <span class="text-slate-300">Include NPC responses</span>
                                                                        </label>
                                                                    </div>
                                                                </div>
                                                    
                                                                <div class="mt-4 pt-4 border-t border-slate-700/50">
                                                                    <button @click="exportChatForTraining()"
                                                                        class="w-full bg-green-600 hover:bg-green-500 text-white py-3 rounded-xl text-[11px] font-black uppercase tracking-widest shadow-lg shadow-green-900/20 transition-all active:scale-95"
                                                                        :disabled="isExporting">
                                                                        <i class="fa-solid mr-2" :class="isExporting ? 'fa-circle-notch fa-spin' : 'fa-download'"></i>
                                                                        <span x-show="!isExporting">Export Training Data</span>
                                                                        <span x-show="isExporting">Exporting...</span>
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="p-4 border-t border-slate-700 bg-slate-800/30 flex gap-3 justify-end">
                                                <button @click="showChatSettings = false"
                                                    class="px-6 bg-slate-700 hover:bg-slate-600 text-white rounded-2xl text-[11px] font-black uppercase tracking-widest transition-all">Close</button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- NPC Details Modal -->
                                    <div x-show="showNPCDetailsModal && selectedNPC?.name"
                                        class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-950/80 backdrop-blur-sm" x-cloak
                                        x-transition>
                                        <div
                                            class="bg-slate-900 border border-slate-700 w-full max-w-3xl rounded-3xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
                                            <div class="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-800/50">
                                                <h2 class="text-xs font-black uppercase tracking-widest text-blue-400">NPC Details</h2>
                                                <button @click="showNPCDetailsModal = false" class="text-slate-400 hover:text-white">
                                                    <i class="fa-solid fa-xmark"></i>
                                                </button>
                                            </div>
                                            <div class="flex-1 overflow-y-auto p-6" x-show="selectedNPC?.name">
                                                <div class="space-y-6">
                                                    <!-- NPC Header -->
                                                    <div class="bg-slate-800/50 rounded-xl p-6 border border-slate-700/50">
                                                        <div class="flex items-start justify-between mb-4">
                                                            <div>
                                                                <h3 class="text-2xl font-bold mb-2" x-text="selectedNPC?.name || selectedNPC?.data?.name">
                                                                </h3>
                                                                <div class="flex gap-2 flex-wrap">
                                                                    <span
                                                                        class="badge badge-npc px-3 py-1 rounded text-[10px] font-bold bg-gray-600 text-white">NPC</span>
                                                                    <span x-show="selectedNPC?.isactive"
                                                                        class="badge badge-global px-3 py-1 rounded text-[10px] font-bold bg-green-600 text-white">Active</span>
                                                                    <span x-show="!selectedNPC?.isactive"
                                                                        class="badge badge-inactive px-3 py-1 rounded text-[10px] font-bold bg-gray-500 text-white">Inactive</span>
                                                                    <span x-show="selectedNPC?.promoted"
                                                                        class="badge badge-promoted px-3 py-1 rounded text-[10px] font-bold bg-orange-600 text-white">Promoted</span>
                                                                </div>
                                                            </div>
                                                            <div class="text-right text-slate-500 text-xs">
                                                                <div>Created: <span x-text="formatDate(selectedNPC?.createdat)"></span></div>
                                                                <div x-show="selectedNPC?.promoted">Global: <span class="font-mono text-orange-400"
                                                                        x-text="selectedNPC?.globalfilename"></span></div>
                                                            </div>
                                                        </div>
                                                        <div x-show="selectedNPC?.data?.description" class="text-slate-300 leading-relaxed text-sm"
                                                            x-text="selectedNPC?.data?.description"></div>
                                                    </div>

                                                    <!-- Creator Notes (PList) -->
                                                    <div x-show="selectedNPC?.data?.creator_notes" class="space-y-2">
                                                        <h4 class="text-[10px] font-black uppercase tracking-widest text-slate-400">Creator Notes</h4>
                                                        <div class="bg-slate-800/50 rounded-xl p-4 border border-slate-700/50">
                                                            <pre class="text-xs text-slate-300 whitespace-pre-wrap font-mono"
                                                                x-text="selectedNPC?.data?.creator_notes"></pre>
                                                        </div>
                                                    </div>

                                                    <!-- NPC First Message -->
                                                    <div x-show="selectedNPC?.data?.first_mes" class="space-y-2">
                                                        <h4 class="text-[10px] font-black uppercase tracking-widest text-slate-400">First Message</h4>
                                                        <div class="bg-slate-800/50 rounded-xl p-4 border border-slate-700/50">
                                                            <p class="text-xs text-slate-300 italic" x-text="selectedNPC?.data?.first_mes"></p>
                                                        </div>
                                                    </div>

                                                    <!-- NPC Scenario -->
                                                    <div x-show="selectedNPC?.data?.scenario" class="space-y-2">
                                                        <h4 class="text-[10px] font-black uppercase tracking-widest text-slate-400">Scenario</h4>
                                                        <div class="bg-slate-800/50 rounded-xl p-4 border border-slate-700/50">
                                                            <p class="text-xs text-slate-300" x-text="selectedNPC?.data?.scenario"></p>
                                                        </div>
                                                    </div>

                                                    <!-- Tags -->
                                                    <div x-show="selectedNPC?.data?.tags?.length > 0" class="space-y-2">
                                                        <h4 class="text-[10px] font-black uppercase tracking-widest text-slate-400">Tags</h4>
                                                        <div class="flex gap-2 flex-wrap">
                                                            <template x-for="tag in selectedNPC?.data?.tags" :key="tag">
                                                                <span
                                                                    class="px-2 py-1 bg-blue-600/20 border border-blue-600/50 rounded text-[10px] text-blue-300"
                                                                    x-text="tag"></span>
                                                            </template>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="p-4 border-t border-slate-700 bg-slate-800/30 flex gap-3 justify-end" x-show="selectedNPC?.name">
                                                <button @click="showNPCDetailsModal = false"
                                                    class="px-6 bg-slate-700 hover:bg-slate-600 text-white rounded-2xl text-[11px] font-black uppercase tracking-widest transition-all">Close</button>
                                            </div>
                                        </div>
                                    </div>
                            

<!-- JavaScript - MUST come before Alpine.js -->
<script>
    // Debug: Log when script starts parsing
    console.log('Script parsing started...');

    function chatUI() {
        return {
            // ========== STATE PROPERTIES ==========
            messages: [],
            input: '',
            summary: '',
            isLoading: false,
            isCountingTokens: false,
            tokenCount: 0,
            showSidebar: 'none',
            showImagePanel: false,
            activeCharacters: [],
            characters: [],
            localNPCs: [],
            isLoadingCharacters: false,
            
            // Tag filtering
            filterTags: [],
            allCharacterTags: [],
            popularCharacterTags: [],
            
             // World tag filtering
             worldFilterTags: [],
             allWorldTags: [],
             popularWorldTags: [],
             
             // Favorites viewer
             favorites: [],
             favoritesSourceType: null,
             favoritesTags: [],
             popularFavoritesTags: [],
             favoritesTagInput: '',
             favoritesTagSuggestions: [],
             favoritesFilterTags: [],
             favoritesOffset: 0,
             favoritesLimit: 50,
             isLoadingFavorites: false,
             savedChats: [],
            editingChar: null,
            selectedNPC: null,
            showChatSettings: false,
            showNPCDetailsModal: false,
            worldInfos: [],
            activeWI: null,
            expandedWorlds: new Set(),
            currentChatId: null,
            newWIEntry: { keys: '', content: '' },
            editingMessageId: null,
            editBuffer: '',
            editingWidth: null,

            settings: {
                system_prompt: 'Write a highly detailed, creative, and immersive response. Stay in character at all times.',
                user_persona: '',
                userName: '',
                reinforce_freq: 5,
                world_info_reinforce_freq: 3,
                world_info_enabled: true,
                max_world_info_entries: 10,
                temperature: 0.7,
                max_length: 250,
                max_context: 4096,
                summarize_threshold: 0.85,
                performance_mode_enabled: true
            },

            settingsTab: 'export',

            config: {
                kobold_url: 'http://127.0.0.1:5001',
                sd_url: 'http://127.0.0.1:7861'
            },

            sdParams: {
                prompt: '',
                negative_prompt: '',
                steps: 20,
                cfg_scale: 7.0,
                width: 512,
                height: 512,
                sampler_name: 'Euler a',
                scheduler: 'Automatic'
            },

            // Snapshot feature (v1.9.0)
            sdAvailable: true,
            isGeneratingSnapshot: false,
            snapshotCharacterRef: null,  // "filename.json" or "npc_xxx"

            // Danbooru Tag Generator (v1.10.0)
            isGeneratingDanbooruTags: false,

            // Card Generation
            showCardGen: false,
            isGenLoading: false,
            cardGen: {
                char_name: '',
                gender: '',
                source_mode: 'chat',
                manual_text: '',
                loading: {},
                fields: {
                    personality: '',
                    body: '',
                    dialogue: '',
                    genre: '',
                    tags: '',
                    scenario: '',
                    first_message: ''
                }
            },

            // World Generation
            showWorldGen: false,
            isWorldLoading: false,
            worldGen: {
                world_name: '',
                source_mode: 'chat',
                manual_text: '',
                tone: 'neutral',
                loading: {},
                fields: {
                    history: '',
                    locations: '',
                    creatures: '',
                    factions: ''
                }
            },

            // Character editing
            isEditingField: false,
            editContextMode: 'chat',
            editContextText: '',
            isReimporting: false,

            // Mode selector
            selectedMode: 'auto',
            isClassifyingMode: false,

            // Inpaint state
            showInpaintDialog: false,
            inpaintImageUrl: '',
            inpaintPrompt: '',
            inpaintMessageIndex: null,
            brushSize: 30,
            brushMode: 'paint',
            isDrawing: false,
            isInpainting: false,
            maskCanvas: null,
            maskCtx: null,
            overlayCtx: null,
            brushHistory: [],
            inpaintPreviewUrl: null,
            isPreviewMode: false,
            originalImageBackup: null,
            inpaintDenoisingStrength: 0.75,
            showBrushCursor: false,
            brushCursorX: 0,
            brushCursorY: 0,

            // Fork/Branch state
            showForkDialog: false,
            forkBranchName: '',
            forkMessageId: null,
            isForking: false,
            showBranchDialog: false,
            currentChatBranches: [],
            showRenameDialog: false,
            renameBranchName: '',
            isRenaming: false,
            currentBranchToRename: null,
            currentChatName: '',

            // NPC Creation
            showNPCCreateMenu: false,
            menuX: 0,
            menuY: 0,
            selectedText: '',
            showNPCCreateDialog: false,
            npcDescription: '',
            npcName: '',
            npcGender: '',
            isCreatingNPC: false,

            // Search
            searchQuery: '',
            searchResults: [],
            searchResultsCount: 0,
            isSearching: false,
            showSearchBar: false,
            showSearchFilters: false,
            searchFilters: {
                chat_id: '',
                speaker: '',
                start_date: '',
                end_date: '',
                available_speakers: []
            },
            
            // Tag Editor (for character/world editing)
            editingTags: [],
            tagInput: '',
            
            // World Tag Editor
            editingWorldTags: [],
            worldTagInput: '',
            
            // Change History
            showChangeHistory: false,
            changeHistory: [],
            isFetchingChanges: false,
            isRestoringChange: false,
            changeHistoryFilters: {
                entity_type: '',
                entityid: '',
                limit: 10
            },

            // Export
            exportFormat: 'alpaca',
            exportIncludeSystem: true,
            exportIncludeWorldInfo: false,
            exportIncludeNPCs: true,
            isExporting: false,

            // World Info Editing
            editingWorldEntry: null,
            worldEditContextMode: 'chat',
            worldEditContextText: '',
            isEditingWorldEntry: false,
            isAddingWorldEntry: false,
            isDeletingWorldEntry: false,

            // Service status
            serviceStatus: {
                kobold: { status: 'disconnected', details: 'Not checked', latency_ms: 0 },
                sd: { status: 'disconnected', details: 'Not checked', latency_ms: 0 }
            },
            isCheckingConnections: false,

            // Cache
            cacheStats: { size: 0, max_size: 1000, usage_percent: 0 },
            cacheConfig: { max_size: 1000 },
            isFetchingCache: false,
            isClearingCache: false,
            isUpdatingCache: false,

            // Connection monitoring
            connectionMonitoring: {
                interval: null,
                baseInterval: 30000,
                currentInterval: 30000,
                consecutiveFailures: 0,
                lastSuccessTime: 0,
                isMonitoring: false,
                isPaused: false
            },

            // ========== UTILITY METHODS ==========
            parseFavoriteTags(tags) {
                if (!tags) return [];
                if (Array.isArray(tags)) return tags;
                try {
                    const parsed = JSON.parse(tags);
                    if (Array.isArray(parsed)) return parsed;
                    return [parsed];
                } catch (e) {
                    // If it's a comma-separated string, split it
                    if (typeof tags === 'string' && tags.includes(',')) {
                        return tags.split(',').map(t => t.trim()).filter(t => t);
                    }
                    // Otherwise treat as single tag
                    return tags ? [tags] : [];
                }
            },

            // ========== INITIALIZATION ==========
            async init() {
                console.log("chatUI init called")

                // Keep settings behavior if you like
                this.loadSettings()

                // FORCE a new chat session on every page load
                this.currentChatId = null
                this.currentChatName = null
                localStorage.removeItem("currentChatId")

                // Clear chat-specific state
                this.messages = []
                this.summary = ""
                this.activeCharacters = []
                this.localNPCs = []

                // Global data still loads as before
                await this.fetchCharacters()
                await this.fetchWorldInfo()
                await this.fetchChats()
                await this.fetchSearchFilters()
                await this.checkAllServices()

                // Check SD availability for snapshot feature
                await this.checkSnapshotStatus()

                // Use Alpine's $watch magic
                this.$watch('settings', () => this.saveSettings())
                this.$watch('sdParams', () => this.saveSettings())
                
                 // Load tags when sidebar changes to world-info or favorites
                   this.$watch('showSidebar', async (value) => {
                       if (value === 'world-info' && !this.allWorldTags.length) {
                           await this.loadAllWorldTags();
                       }
                       if (value === 'favorites') {
                           await this.fetchFavoritesTags();
                           await this.fetchFavorites(true);
                       }
                   })

                setInterval(() => {
                    if (this.messages.length > 0 && !this.isLoading) {
                        this.updateTokenCount()
                    }
                }, 30000)

                this.initConnectionMonitoring()
                document.addEventListener("visibilitychange", () => {
                    if (document.hidden) this.pauseConnectionMonitoring()
                    else this.resumeConnectionMonitoring()
                })

                // Global click listener to hide favorite menus
                document.addEventListener('click', (event) => {
                    if (!event.target.closest('.favorite-dropdown')) {
                        this.hideAllFavoriteMenus();
                    }
                });

                console.log("chatUI init complete")
            },



            // ========== COMPUTED METHODS (call with parentheses) ==========
            allCharacters() {
                const characters = Array.isArray(this.characters) ? this.characters : [];
                const localNPCs = Array.isArray(this.localNPCs) ? this.localNPCs : [];

                // Filter out invalid characters - must have name in data
                const validCharacters = characters.filter(char => {
                    // Character must exist and have a name
                    if (!char) return false;
                    const name = char?.data?.name || char?.name;
                    return name && name.trim() !== '' && name !== 'Unknown';
                });

                const all = validCharacters.map(char => ({
                    type: 'global',
                    char: char,
                    npc: null
                }));

                // Only add NPCs if we have a current chat and valid NPCs
                if (this.currentChatId && localNPCs.length > 0) {
                    // Filter out invalid NPCs - must have entity_id and name
                    const validNPCs = localNPCs.filter(npc => {
                        if (!npc) return false;
                        const entityId = npc.entity_id || npc.entityid;
                        const name = npc.name || npc?.data?.name;
                        return entityId && name && name.trim() !== '' && name !== 'Unknown';
                    });

                    const npcs = validNPCs.map(npc => ({
                        type: 'npc',
                        char: null,
                        npc: npc
                    }));
                    all.push(...npcs);
                }

                return all;
            },

            activeCharactersWithData() {
                if (!Array.isArray(this.activeCharacters)) return [];

                return this.activeCharacters.map(charRef => {
                    if (typeof charRef === 'string') {
                        if (charRef.startsWith('npc_')) {
                            const npc = this.localNPCs.find(n => n.entity_id === charRef || n.entityid === charRef);
                            if (npc && (npc.isactive || npc.is_active)) {
                                return {
                                    data: { name: npc.name || npc.data?.name, ...npc.data },
                                    isNPC: true,
                                    npcId: npc.entityid || npc.entity_id
                                };
                            }
                        } else {
                            const char = this.characters.find(c => c._filename === charRef);
                            if (char) return char;
                        }
                    } else if (charRef && charRef.data) {
                        return charRef;
                    }
                    return null;
                }).filter(c => c !== null);
            },

            // ========== SETTINGS ==========
            loadSettings() {
                const saved = localStorage.getItem('ai_chat_settings');
                if (saved) {
                    try {
                        const parsed = JSON.parse(saved);
                        if (parsed.settings) this.settings = { ...this.settings, ...parsed.settings };
                        if (parsed.sdParams) this.sdParams = { ...this.sdParams, ...parsed.sdParams };
                        if (!parsed.settings && !parsed.sdParams) this.settings = { ...this.settings, ...parsed };
                    } catch (e) {
                        console.error('Failed to load settings', e);
                    }
                }
            },

            saveSettings() {
                const toSave = { settings: this.settings, sdParams: this.sdParams };
                localStorage.setItem('ai_chat_settings', JSON.stringify(toSave));
            },

            // ========== API CALLS ==========
            async fetchCharacters() {
                try {
                    // Fetch characters with optional tag filter
                    const tagFilter = this.filterTags.length > 0 ? this.filterTags.join(',') : null;
                    const url = tagFilter ? `/api/characters?tags=${tagFilter}` : '/api/characters';
                    const res = await axios.get(url);
                    this.characters = res.data;
                    
                    // Load all tags when no filter is applied (for dropdown)
                    if (!tagFilter && !this.allCharacterTags.length) {
                        await this.loadAllCharacterTags();
                    }
                } catch (e) {
                    console.error('Failed to fetch characters:', e);
                }
            },
            
            // ========== TAG MANAGEMENT ==========
            async loadCharacterTags(filename) {
                try {
                    const res = await axios.get(`/api/characters/${filename}/tags`);
                    this.editingTags = res.data.tags || [];
                    this.tagInput = '';
                } catch (e) {
                    console.error('Failed to load character tags:', e);
                    this.editingTags = [];
                    this.tagInput = '';
                }
            },
            
            async loadAllCharacterTags() {
                try {
                    // Load all tags and popular tags in parallel
                    const [allTagsRes, popularTagsRes] = await Promise.all([
                        axios.get('/api/characters/tags'),
                        axios.get('/api/characters/popular-tags?limit=5')
                    ]);
                    
                    this.allCharacterTags = allTagsRes.data.tags || [];
                    this.popularCharacterTags = popularTagsRes.data || [];
                } catch (e) {
                    console.error('Failed to load character tags:', e);
                }
            },
            
            toggleFilterTag(tag) {
                if (this.filterTags.includes(tag)) {
                    this.filterTags = this.filterTags.filter(t => t !== tag);
                } else {
                    this.filterTags.push(tag);
                }
                this.fetchCharacters();
            },
            
            addFilterTag(tag) {
                if (tag && !this.filterTags.includes(tag)) {
                    this.filterTags.push(tag);
                    this.fetchCharacters();
                }
            },
            
            addEditTag() {
                if (this.tagInput && !this.editingTags.includes(this.tagInput)) {
                    this.editingTags.push(this.tagInput.toLowerCase().trim());
                    this.tagInput = '';
                }
            },
            
            removeEditTag(tag) {
                this.editingTags = this.editingTags.filter(t => t !== tag);
            },
            
            get tagSuggestions() {
                if (!this.tagInput) return [];
                return this.allCharacterTags.filter(
                    t => t.toLowerCase().startsWith(this.tagInput.toLowerCase()) &&
                         !this.editingTags.includes(t)
                ).slice(0, 5);
            },
            
            // ========== WORLD TAG MANAGEMENT ==========
            async loadWorldTags(worldName) {
                try {
                    const res = await axios.get(`/api/world-info/${worldName}/tags`);
                    this.editingWorldTags = res.data.tags || [];
                    this.worldTagInput = '';
                } catch (e) {
                    console.error('Failed to load world tags:', e);
                    this.editingWorldTags = [];
                    this.worldTagInput = '';
                }
            },
            
            async loadAllWorldTags() {
                try {
                    // Load all world tags and popular world tags in parallel
                    const [allTagsRes, popularTagsRes] = await Promise.all([
                        axios.get('/api/world-info/tags'),
                        axios.get('/api/world-info/popular-tags?limit=5')
                    ]);
                    
                    this.allWorldTags = allTagsRes.data.tags || [];
                    this.popularWorldTags = popularTagsRes.data || [];
                } catch (e) {
                    console.error('Failed to load world tags:', e);
                }
            },
            
            toggleWorldFilterTag(tag) {
                if (this.worldFilterTags.includes(tag)) {
                    this.worldFilterTags = this.worldFilterTags.filter(t => t !== tag);
                } else {
                    this.worldFilterTags.push(tag);
                }
                this.fetchWorldInfo();
            },
            
            addWorldFilterTag(tag) {
                if (tag && !this.worldFilterTags.includes(tag)) {
                    this.worldFilterTags.push(tag);
                    this.fetchWorldInfo();
                }
            },
            
            addEditWorldTag() {
                if (this.worldTagInput && !this.editingWorldTags.includes(this.worldTagInput)) {
                    this.editingWorldTags.push(this.worldTagInput.toLowerCase().trim());
                    this.worldTagInput = '';
                }
            },
            
            removeEditWorldTag(tag) {
                this.editingWorldTags = this.editingWorldTags.filter(t => t !== tag);
            },
            
            get worldTagSuggestions() {
                if (!this.worldTagInput) return [];
                return this.allWorldTags.filter(
                    t => t.toLowerCase().startsWith(this.worldTagInput.toLowerCase()) &&
                         !this.editingWorldTags.includes(t)
                ).slice(0, 5);
            },
            
            async fetchWorldInfo() {
                try {
                    // Fetch world info with optional tag filter
                    const tagFilter = this.worldFilterTags.length > 0 ? this.worldFilterTags.join(',') : null;
                    const url = tagFilter ? `/api/world-info?tags=${tagFilter}` : '/api/world-info';
                    const res = await axios.get(url);
                    this.worldInfos = res.data;

                    // Auto-expand all filtered worlds and clear activeWI
                    if (tagFilter && this.worldInfos.length > 0) {
                        this.expandedWorlds.clear();
                        this.worldInfos.forEach(wi => this.expandedWorlds.add(wi.name));
                        this.activeWI = null;
                    } else {
                        this.expandedWorlds.clear();
                        this.activeWI = null;
                    }

                    // Load all world tags when no filter is applied (for dropdown)
                    if (!tagFilter && !this.allWorldTags.length) {
                        await this.loadAllWorldTags();
                    }
                } catch (e) {
                    console.error('Failed to fetch world info:', e);
                }
            },

            toggleWorldExpansion(worldName) {
                const world = this.worldInfos.find(w => w.name === worldName);
                if (!world) return;

                if (this.worldFilterTags.length > 0) {
                    if (this.expandedWorlds.has(worldName)) {
                        this.expandedWorlds.delete(worldName);
                    } else {
                        this.expandedWorlds.add(worldName);
                    }
                    this.activeWI = world;
                } else {
                    if (this.expandedWorlds.has(worldName)) {
                        this.expandedWorlds.clear();
                        this.activeWI = null;
                    } else {
                        this.expandedWorlds.clear();
                        this.expandedWorlds.add(worldName);
                        this.activeWI = world;
                    }
                }
            },

            async fetchChats() {
                try {
                    const res = await axios.get('/api/chats');
                    this.savedChats = res.data;
                } catch (e) {
                    console.error('Failed to fetch chats:', e);
                }
            },

            async fetchSearchFilters() {
                try {
                    const res = await axios.get('/api/search/filters');
                    if (res.data.success) {
                        this.searchFilters.available_speakers = res.data.speakers || [];
                    }
                } catch (e) {
                    console.error('Failed to fetch filters:', e);
                }
            },

            // ========== FAVORITES VIEWER ==========
            async fetchFavoritesTags() {
                try {
                    const [allTagsRes, popularTagsRes] = await Promise.all([
                        axios.get('/api/snapshots/tags'),
                        axios.get('/api/snapshots/tags/popular?limit=5')
                    ]);
                    this.favoritesTags = allTagsRes.data.tags || [];
                    this.popularFavoritesTags = popularTagsRes.data || [];
                } catch (e) {
                    console.error('Failed to fetch favorites tags:', e);
                    this.favoritesTags = [];
                    this.popularFavoritesTags = [];
                }
            },

            async fetchFavorites(resetOffset = true) {
                if (resetOffset) {
                    this.favoritesOffset = 0;
                }
                const tagFilter = this.favoritesFilterTags.length > 0 ? this.favoritesFilterTags.join(',') : null;
                const sourceTypeFilter = this.favoritesSourceType || null;
                this.isLoadingFavorites = true;
                try {
                    const res = await axios.get('/api/snapshots/favorites', {
                        params: {
                            limit: this.favoritesLimit,
                            offset: this.favoritesOffset,
                            source_type: sourceTypeFilter,
                            tags: tagFilter
                        }
                    });
                    if (this.favoritesOffset === 0) {
                        this.favorites = res.data.favorites || [];
                    } else {
                        this.favorites = [...this.favorites, ...(res.data.favorites || [])];
                    }
                } catch (e) {
                    console.error('Failed to fetch favorites:', e);
                    alert('Failed to load favorites: ' + (e.response?.data?.detail || e.message));
                } finally {
                    this.isLoadingFavorites = false;
                }
            },

            loadMoreFavorites() {
                this.favoritesOffset += this.favoritesLimit;
                this.fetchFavorites(false);
            },

            toggleFavoritesTag(tag) {
                const index = this.favoritesFilterTags.indexOf(tag);
                if (index > -1) {
                    this.favoritesFilterTags.splice(index, 1);
                } else {
                    this.favoritesFilterTags.push(tag);
                }
                this.fetchFavorites(true);
            },

            clearFavoritesTags() {
                this.favoritesFilterTags = [];
                this.favoritesTagInput = '';
                this.favoritesTagSuggestions = [];
                this.fetchFavorites(true);
            },

            updateFavoritesTagSuggestions() {
                const input = this.favoritesTagInput.toLowerCase().trim();
                if (input.length < 1) {
                    this.favoritesTagSuggestions = [];
                    return;
                }
                this.favoritesTagSuggestions = this.favoritesTags
                    .filter(tag => tag.toLowerCase().startsWith(input))
                    .slice(0, 50);
            },

            applyFavoriteTagFromInput(tag) {
                this.favoritesTagInput = '';
                this.favoritesTagSuggestions = [];
                this.toggleFavoritesTag(tag);
            },

            setFavoritesSourceType(type) {
                if (type === this.favoritesSourceType) {
                    this.favoritesSourceType = null;
                } else {
                    this.favoritesSourceType = type;
                }
                this.fetchFavorites(true);
            },

            async deleteFavorite(favoriteId) {
                if (!confirm('Are you sure you want to delete this favorite?')) {
                    return;
                }
                try {
                    await axios.delete(`/api/snapshots/favorites/${favoriteId}`);
                    this.favorites = this.favorites.filter(f => f.id !== favoriteId);
                    await this.fetchFavoritesTags();
                } catch (e) {
                    console.error('Failed to delete favorite:', e);
                    alert('Failed to delete favorite: ' + (e.response?.data?.detail || e.message));
                }
            },

            async jumpToFavoriteSource(favorite) {
                console.log('[JUMP] Attempting to jump to source for favorite:', favorite.id);
                
                if (!favorite.chat_id) {
                    alert('This favorite is not associated with a chat. It may be an older manual upload or the chat was deleted.');
                    return;
                }

                try {
                    // Show loading indicator
                    this.isLoading = true;
                    
                    // Load the chat
                    const chatId = favorite.chat_id;
                    const imageFilename = favorite.image_filename;
                    
                    console.log(`[JUMP] Loading chat ${chatId}, looking for image ${imageFilename}`);
                    
                    // Check if chat exists
                    const chatRes = await axios.get(`/api/chats/${chatId}`);
                    if (!chatRes.data) {
                        alert('Chat not found. It may have been deleted.');
                        return;
                    }
                    
                    // Load the chat (this sets currentChatId and messages)
                    await this.loadChat(chatId);
                    
                    // Wait for messages to load
                    await this.$nextTick();
                    
                    // Search for the message containing this image
                    let targetMessageIndex = -1;
                    for (let i = 0; i < this.messages.length; i++) {
                        const msg = this.messages[i];
                        // Check both snapshot images and manual images
                        if (msg.snapshot && msg.snapshot.image_url && msg.snapshot.image_url.includes(imageFilename)) {
                            targetMessageIndex = i;
                            break;
                        }
                        if (msg.image && msg.image.includes(imageFilename)) {
                            targetMessageIndex = i;
                            break;
                        }
                    }
                    
                    if (targetMessageIndex === -1) {
                        alert('Image not found in this chat. It may have been deleted or the chat was modified.');
                        return;
                    }
                    
                    console.log(`[JUMP] Found image at message index ${targetMessageIndex}`);
                    
                    // Close favorites sidebar
                    this.showFavoritesSidebar = false;
                    
                    // Scroll to the message
                    await this.$nextTick();
                    const messageElement = document.getElementById(`message-${targetMessageIndex}`);
                    if (messageElement) {
                        messageElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        
                        // Add highlight effect
                        messageElement.classList.add('highlight-message');
                        setTimeout(() => {
                            messageElement.classList.remove('highlight-message');
                        }, 3000);
                    }
                    
                    console.log('[JUMP] Successfully jumped to source message');
                    
                } catch (e) {
                    console.error('[JUMP] Failed to jump to favorite source:', e);
                    alert('Failed to navigate to chat: ' + (e.response?.data?.detail || e.message));
                } finally {
                    this.isLoading = false;
                }
            },

            // ========== CONNECTION MANAGEMENT ==========
            async checkKoboldConnection() {
                this.isCheckingConnections = true;
                try {
                    const res = await axios.get('/api/health/kobold');
                    this.serviceStatus.kobold = res.data;
                } catch (e) {
                    this.serviceStatus.kobold = { status: 'disconnected', details: 'Connection failed', latency_ms: 0 };
                } finally {
                    this.isCheckingConnections = false;
                }
            },

            async checkSDConnection() {
                this.isCheckingConnections = true;
                try {
                    const res = await axios.get('/api/health/sd');
                    this.serviceStatus.sd = res.data;
                } catch (e) {
                    this.serviceStatus.sd = { status: 'disconnected', details: 'Connection failed', latency_ms: 0 };
                } finally {
                    this.isCheckingConnections = false;
                }
            },

            async checkAllServices() {
                await Promise.all([
                    this.checkKoboldConnection(),
                    this.checkSDConnection()
                ]);
            },

            async testConnection(service) {
                if (service === 'kobold') {
                    await this.checkKoboldConnection();
                } else if (service === 'sd') {
                    await this.checkSDConnection();
                }
            },

            isServiceConnected(service) {
                return this.serviceStatus[service]?.status === 'connected';
            },

            getServiceStatusText(service) {
                const status = this.serviceStatus[service];
                if (!status) return 'Unknown';
                switch (status.status) {
                    case 'connected': return `Connected (${status.latency_ms}ms)`;
                    case 'disconnected': return 'Disconnected';
                    case 'testing': return 'Testing...';
                    default: return status.details || 'Unknown';
                }
            },

            getServiceStatusClass(service) {
                const status = this.serviceStatus[service]?.status;
                switch (status) {
                    case 'connected': return 'bg-green-500';
                    case 'disconnected': return 'bg-red-500';
                    case 'testing': return 'bg-yellow-500';
                    default: return 'bg-slate-500';
                }
            },

            canGenerateText() {
                return this.isServiceConnected('kobold');
            },

            canGenerateImages() {
                return this.isServiceConnected('sd');
            },

            async updateAPIURLs() {
                await this.checkAllServices();
            },

            // Connection monitoring
            initConnectionMonitoring() {
                this.connectionMonitoring.isMonitoring = true;
                this.connectionMonitoring.lastSuccessTime = Date.now();
                this.startConnectionMonitoring();
            },

            startConnectionMonitoring() {
                if (this.connectionMonitoring.interval) return;
                this.connectionMonitoring.interval = setInterval(() => {
                    if (!this.connectionMonitoring.isPaused && this.connectionMonitoring.isMonitoring) {
                        this.checkAllServices();
                    }
                }, this.connectionMonitoring.currentInterval);
            },

            pauseConnectionMonitoring() {
                this.connectionMonitoring.isPaused = true;
                if (this.connectionMonitoring.interval) {
                    clearInterval(this.connectionMonitoring.interval);
                    this.connectionMonitoring.interval = null;
                }
            },

            resumeConnectionMonitoring() {
                this.connectionMonitoring.isPaused = false;
                this.startConnectionMonitoring();
                this.checkAllServices();
            },

            // ========== TOKEN COUNTING ==========
            async updateTokenCount() {
                if (this.isCountingTokens) return;
                this.isCountingTokens = true;
                try {
                    const prompt = this.constructPromptLocally();
                    const res = await axios.post('/api/extra/tokencount', { prompt });
                    this.tokenCount = res.data.count;
                } catch (e) {
                    console.error('Token count failed', e);
                } finally {
                    this.isCountingTokens = false;
                }
            },

            constructPromptLocally() {
                let p = `### System: ${this.settings.system_prompt}\n`;
                const isGroupChat = this.activeCharactersWithData().length >= 2;
                if (isGroupChat) p += "\n[MODE: NARRATOR]\n";
                if (this.summary) p += `### Long-Term Context:\n${this.summary}\n`;
                if (this.settings.user_persona) p += `### Your Character:\n${this.settings.user_persona}\n`;

                this.activeCharactersWithData().forEach(c => {
                    const name = c.data.name;
                    p += `### Character: ${name}\n${c.data.description || ''}\n`;
                });

                p += "\n### Chat:\n";
                this.messages.forEach(m => {
                    if (m.speaker === 'Visual System') return;
                    const speaker = m.speaker || (m.role === 'user' ? 'User' : 'Narrator');
                    p += `${speaker}: ${m.content}\n`;
                });
                p += "Narrator:";
                return p;
            },

            // ========== CHAT MANAGEMENT ==========
            async saveNewChat() {
                const name = prompt("Name this chat session:");
                if (!name) return;
                const data = {
                    messages: this.messages,
                    summary: this.summary,
                    activeCharacters: this.activeCharacters,
                    activeWI: this.activeWI,
                    settings: this.settings
                };
                try {
                    const res = await axios.post('/api/chats', { name, data });
                    if (!res.data.success) {
                        this.showNotification(res.data.error || 'Failed to save chat', 'error');
                        return;
                    }
                    const oldChatId = this.currentChatId;
                    this.currentChatId = name;
                    this.currentChatName = name;
                    localStorage.setItem('currentChatId', name);
                    
                    // Sync message IDs with database-generated IDs
                    if (res.data.id_mapping) {
                        for (const msg of this.messages) {
                            const newId = res.data.id_mapping[msg.id.toString()];
                            if (newId) {
                                msg.id = newId;
                            }
                        }
                    }
                    
                    // Delete old autosaved chat if it exists and was new_chat_*
                    if (oldChatId && oldChatId.startsWith('new_chat_')) {
                        try {
                            await axios.delete(`/api/chats/${oldChatId}`);
                            console.log(`Deleted old autosaved chat: ${oldChatId}`);
                        } catch (e) {
                            console.error('Failed to delete old autosaved chat:', e);
                        }
                    }
                    
                    await this.fetchChats();
                } catch (e) {
                    this.showNotification('Failed to save chat: ' + (e.response?.data?.error || e.message), 'error');
                }
            },

            async loadChat(name) {
                if (this.messages.length > 0 && !confirm('Load chat? Current progress will be lost.')) return;

                try {
                    const res = await axios.get(`/api/chats/${name}`);
                    const d = res.data;

                    this.messages = d.messages || [];
                    this.summary = d.summary || '';
                    this.activeWI = d.activeWI || null;
                    this.settings = { ...this.settings, ...(d.settings || {}) };
                    this.currentChatName = name;
                    this.currentChatId = d.id || name;

                    localStorage.setItem('currentChatId', this.currentChatId);

                    // Load NPCs BEFORE restoring activeCharacters
                    await this.loadChatNPCs(this.currentChatId);

                    // Now restore activeCharacters, validating NPC references
                    const savedActiveChars = d.activeCharacters || [];
                    this.activeCharacters = [];

                    for (const charRef of savedActiveChars) {
                        if (typeof charRef === 'string') {
                            if (charRef.startsWith('npc_')) {
                                // Validate NPC still exists
                                const npcExists = this.localNPCs.some(n => n.entity_id === charRef);
                                if (npcExists) {
                                    this.activeCharacters.push(charRef);
                                } else {
                                    console.warn(`NPC ${charRef} no longer exists, skipping`);
                                }
                            } else {
                                // Global character reference
                                const charExists = this.characters.some(c => c._filename === charRef);
                                if (charExists) {
                                    this.activeCharacters.push(charRef);
                                } else {
                                    console.warn(`Character ${charRef} no longer exists, skipping`);
                                }
                            }
                        }
                    }

                    this.showForkDialog = false;
                    this.showBranchDialog = false;
                    this.showRenameDialog = false;
                    this.showSidebar = 'none';

                    this.scrollToBottom();
                    this.updateTokenCount();

                    console.log('Chat loaded:', this.currentChatId, 'NPCs:', this.localNPCs.length, 'Active:', this.activeCharacters);
                } catch (e) {
                    console.error('Failed to load chat:', e);
                    this.showNotification('Failed to load chat', 'error');
                }
            },

            async deleteChat(chatId) {
                if (!confirm('Delete this chat?')) return;
                try {
                    await axios.delete(`/api/chats/${chatId}`);
                    await this.fetchChats();
                } catch (e) {
                    console.error(e);
                }
            },

            async autosaveChat() {
                // Require at least one message
                if (this.messages.length === 0) return;

                // Normalize activeCharacters to string references
                const normalizedActiveChars = this.activeCharacters
                    .map(ref => {
                        if (typeof ref === "string") return ref;
                        if (ref.isNPC && ref.npcId) return ref.npcId;
                        if (ref._filename) return ref._filename;
                        if (ref.data?.name) return ref.data.name + ".json";
                        return null;
                    })
                    .filter(Boolean);

                const chatData = {
                    messages: this.messages,
                    summary: this.summary,
                    activeCharacters: normalizedActiveChars,
                    activeWI: this.activeWI,
                    settings: this.settings,
                };

                try {
                    const res = await axios.post("/api/chats", {
                        name: this.currentChatId,   // null/undefined on first save
                        data: chatData,
                });

                // Autosave saves chat data but doesn't update currentChatId anymore
                // Backend now tracks chat ID via client-side generation and /api/chat response
                // Commented out to prevent race condition where autosave overwrites chat ID from /api/chat
                // if (res.data && res.data.id && !this.currentChatId) {
                //     this.currentChatId = res.data.id;
                //     // Do NOT persist to localStorage unless you explicitly want auto-reopen
                //     // localStorage.setItem("currentChatId", this.currentChatId);
                // }
                 
                // Sync message IDs with database-generated IDs
                    if (res.data && res.data.id_mapping) {
                        for (const msg of this.messages) {
                            const newId = res.data.id_mapping[msg.id.toString()];
                            if (newId) {
                                msg.id = newId;
                            }
                        }
                    }

                    console.log(
                        "Autosaved chat:",
                        this.currentChatId,
                        "with",
                        normalizedActiveChars.length,
                        "active characters"
                    );
                } catch (e) {
                    console.error('Autosave failed:', e);
                }
            },
            // ========== NPC MANAGEMENT ==========
            async loadChatNPCs(chatId) {
                if (!chatId) {
                    this.localNPCs = [];
                    return;
                }
                try {
                    const res = await axios.get(`/api/chats/${chatId}/npcs`);
                    this.localNPCs = res.data.npcs || [];
                    if (!Array.isArray(this.localNPCs)) {
                        this.localNPCs = Object.values(this.localNPCs);
                    }
                } catch (e) {
                    console.error('Failed to load NPCs:', e);
                    this.localNPCs = [];
                }
            },

            async toggleNPCActive(chatId, npcId) {
                if (!chatId || !npcId) {
                    this.showNotification('Cannot toggle NPC: missing chat or NPC ID', 'error');
                    return;
                }
                try {
                    const res = await axios.post(`/api/chats/${chatId}/npcs/${npcId}/toggle-active`);
                    if (res.data.success) {
                        await this.loadChatNPCs(chatId);
                        // Backend returns is_active, handle both naming conventions
                        const isActive = res.data.is_active ?? res.data.isactive ?? false;
                        
                        // Update activeCharacters array to match backend
                        if (isActive) {
                            if (!this.activeCharacters.includes(npcId)) {
                                this.activeCharacters.push(npcId);
                            }
                        } else {
                            this.activeCharacters = this.activeCharacters.filter(id => id !== npcId);
                        }
                        
                        this.showNotification(`NPC ${isActive ? 'activated' : 'deactivated'}`, 'success');
                    } else {
                        this.showNotification(res.data.error || 'Failed to toggle NPC', 'error');
                    }
                } catch (e) {
                    console.error('Toggle NPC failed:', e);
                    const errorMsg = e.response?.data?.error || 'Failed to toggle NPC status';
                    this.showNotification(errorMsg, 'error');
                }
            },

            async promoteNPC(chatId, npcId) {
                if (!chatId || !npcId) {
                    this.showNotification('Cannot promote NPC: missing chat or NPC ID', 'error');
                    return;
                }
                if (!confirm('Promote this NPC to a permanent global character?')) return;
                
                try {
                    const res = await axios.post(`/api/chats/${chatId}/npcs/${npcId}/promote`);
                    if (res.data.success) {
                        this.showNotification(`NPC promoted to ${res.data.filename || 'global character'}`, 'success');
                        // Refresh both NPC list and character list
                        await this.loadChatNPCs(chatId);
                        await this.fetchCharacters();
                        // Also reload active characters to include the new global character
                        if (res.data.filename) {
                            // Add the promoted character to active characters if not already there
                            if (!this.activeCharacters.includes(res.data.filename)) {
                                this.activeCharacters.push(res.data.filename);
                            }
                        }
                    } else {
                        const errorMsg = res.data.message || res.data.error || 'Promotion failed';
                        this.showNotification(errorMsg, 'warning');
                    }
                } catch (e) {
                    console.error('Promotion failed:', e);
                    const errorMsg = e.response?.data?.error || e.response?.data?.message || 'Failed to promote NPC';
                    this.showNotification(errorMsg, 'error');
                }
            },

            async deleteNPC(chatId, npcId) {
                if (!chatId || !npcId) {
                    this.showNotification('Cannot delete NPC: missing chat or NPC ID', 'error');
                    return;
                }
                if (!confirm('Delete this NPC? This cannot be undone.')) return;
                
                try {
                    const res = await axios.delete(`/api/chats/${chatId}/npcs/${npcId}`);
                    if (res.data.success) {
                        this.showNotification(res.data.message || 'NPC deleted', 'success');
                        // Remove NPC from activeCharacters if present
                        const idx = this.activeCharacters.indexOf(npcId);
                        if (idx > -1) {
                            this.activeCharacters.splice(idx, 1);
                        }
                        // Refresh NPC list
                        await this.loadChatNPCs(chatId);
                    } else {
                        const errorMsg = res.data.error || res.data.message || 'Failed to delete NPC';
                        this.showNotification(errorMsg, 'error');
                    }
                } catch (e) {
                    console.error('Delete failed:', e);
                    const errorMsg = e.response?.data?.error || e.response?.data?.message || 'Failed to delete NPC';
                    this.showNotification(errorMsg, 'error');
                }
            },

            startEditNPC(npc) {
                const clone = JSON.parse(JSON.stringify(npc));

                // Handle NPC structure: npc.data contains the character data
                const charData = clone.data || {};

                // Ensure required nested structures exist
                if (!charData.extensions) charData.extensions = {};
                if (!charData.extensions.depth_prompt) {
                    charData.extensions.depth_prompt = { depth: 4, prompt: '' };
                }
                if (!charData.personality) charData.personality = '';
                if (!charData.scenario) charData.scenario = '';
                if (!charData.tags) charData.tags = [];

                // Ensure name is set
                if (!charData.name) charData.name = npc.name || 'Unknown NPC';

                this.editingChar = {
                    data: charData,
                    isNPC: true,
                    npcId: npc.entityid,
                    _chatId: this.currentChatId
                };
                
                this.showSidebar = 'characters';
                
                // Load tags when character sidebar is opened
                if (!this.allCharacterTags.length) {
                    this.loadAllCharacterTags();
                }
            },

            viewNPCDetails(npc) {
                this.selectedNPC = npc;
                this.showNPCDetailsModal = true;
            },

            handleTextSelection(event) {
                const selection = window.getSelection().toString().trim();
                if (selection.length > 5 && selection.length < 500) {
                    this.selectedText = selection;
                    let x = event.pageX;
                    let y = event.pageY;
                    const viewportWidth = window.innerWidth;
                    const viewportHeight = window.innerHeight;
                    const menuWidth = 220;
                    const menuHeight = 90;
                    const padding = 20;

                    if (x + menuWidth > viewportWidth - padding) {
                        x = viewportWidth - menuWidth - padding;
                    }
                    if (y + menuHeight > viewportHeight - padding) {
                        y = viewportHeight - menuHeight - padding;
                    }

                    this.menuX = x;
                    this.menuY = y;
                    this.showNPCCreateMenu = true;
                } else {
                    this.showNPCCreateMenu = false;
                }
            },

            async createNPCFromDescription() {
                if (!this.npcDescription.trim()) {
                    this.showNotification('Please enter a description', 'error');
                    return;
                }

                if (!this.currentChatId) {
                    this.showNotification('Please save the chat first before creating NPCs', 'error');
                    return;
                }

                this.isCreatingNPC = true;
                try {
                    const res = await axios.post('/api/card-gen/generate-field', {
                        char_name: this.npcName,
                        context: this.npcDescription,
                        field_type: 'full',
                        source_mode: 'manual',
                        save_as: 'local_npc',
                        chat_id: this.currentChatId,
                        gender: this.npcGender
                    });

                    if (res.data.success) {
                        this.showNPCCreateDialog = false;
                        this.showNotification(`NPC "${res.data.name}" created!`, 'success');

                        // Handle both field name formats (entityid and entity_id)
                        const newEntityId = res.data.entity_id || res.data.entity_id;
                        if (newEntityId && !this.activeCharacters.includes(newEntityId)) {
                            this.activeCharacters.push(newEntityId);
                        }

                        await this.loadChatNPCs(this.currentChatId);
                        await this.autosaveChat();
                        this.npcDescription = '';
                        this.npcName = '';
                        this.npcGender = '';
                    } else {
                        // Handle duplicate NPC error
                        if (res.data.existing_entityid) {
                            this.showNotification(`NPC already exists: ${res.data.existing_name || res.data.error}`, 'warning');
                        } else {
                            this.showNotification(res.data.error || 'Failed to create NPC', 'error');
                        }
                    }
                } catch (e) {
                    console.error('NPC creation failed:', e);
                    const errorMsg = e.response?.data?.error || e.message || 'Unknown error';
                    this.showNotification('Failed to create NPC: ' + errorMsg, 'error');
                } finally {
                    this.isCreatingNPC = false;
                }
            },

            async createNPCFromSelection() {
                this.showNPCCreateMenu = false;

                if (!this.selectedText) {
                    this.showNotification('No text selected', 'error');
                    return;
                }

                if (!this.currentChatId) {
                    this.showNotification('Please save the chat first before creating NPCs', 'error');
                    return;
                }

                this.isCreatingNPC = true;
                try {
                    const res = await axios.post('/api/card-gen/generate-field', {
                        char_name: this.npcName,
                        context: this.selectedText,
                        field_type: 'full',
                        source_mode: 'chat',
                        save_as: 'local_npc',
                        chat_id: this.currentChatId,
                        gender: this.npcGender
                    });

                    if (res.data.success) {
                        this.showNotification(`NPC "${res.data.name}" created!`, 'success');

                        if (res.data.entity_id && !this.activeCharacters.includes(res.data.entity_id)) {
                            this.activeCharacters.push(res.data.entity_id);
                        }
                        await this.loadChatNPCs(this.currentChatId);
                        await this.autosaveChat();
                        this.selectedText = '';
                        this.npcName = '';
                        this.npcGender = '';
                    } else {
                        this.showNotification(res.data.error || 'Failed to create NPC', 'error');
                    }
                } catch (e) {
                    console.error('NPC creation failed:', e);
                    this.showNotification('Failed to create NPC: ' + (e.response?.data?.error || e.message), 'error');
                } finally {
                    this.isCreatingNPC = false;
                }
            },

            // ========== CHARACTER MANAGEMENT ==========
            isCharacterActive(char) {
                if (!char) return false;
                return this.activeCharacters.includes(char._filename);
            },

            async toggleCharacter(char) {
                let charRef;
                if (char.isNPC) {
                    charRef = char.npcId;
                } else {
                    charRef = char._filename;
                }

                const index = this.activeCharacters.findIndex(ref => {
                    if (typeof ref === 'string') {
                        return ref === charRef;
                    }
                    return ref._filename === charRef || ref.data?.name === char.data?.name;
                });

                if (index > -1) {
                    this.activeCharacters.splice(index, 1);
                } else {
                    this.activeCharacters.push(charRef);
                }

                await this.autosaveChat();
            },

            startNewCharacter() {
                this.editingChar = {
                    spec: 'chara_card_v2',
                    spec_version: '2.0',
                    data: {
                        name: 'New',
                        description: '',
                        personality: '',
                        scenario: '',
                        first_mes: '',
                        mes_example: '',
                        creator_notes: '',
                        system_prompt: '',
                        post_history_instructions: '',
                        alternate_greetings: [],
                        character_book: null,
                        tags: [],
                        creator: '',
                        character_version: '',
                        extensions: {
                            depth_prompt: { depth: 4, prompt: '' },
                            label_description: '',
                            danbooru_tag: '',
                            genre: '',
                            gender: ''
                        }
                    }
                };
                this.editingTags = [];
            },

            startEditCharacter(char) {
                const clone = JSON.parse(JSON.stringify(char));
                if (!clone.data.extensions) clone.data.extensions = {};
                if (!clone.data.extensions.depth_prompt) {
                    clone.data.extensions.depth_prompt = { depth: 4, prompt: '' };
                }
                if (!clone.data.extensions.gender) clone.data.extensions.gender = '';
                if (!clone.data.personality) clone.data.personality = '';
                if (!clone.data.scenario) clone.data.scenario = '';
                if (!clone.data.tags) clone.data.tags = [];
                this.editingChar = clone;
                
                // Load existing tags for editing
                this.loadCharacterTags(char._filename);
            },

            async saveCharacter() {
                if (!this.editingChar) return;

                // Detect NPC by explicit flag OR presence of npcId
                const isEditingNPC =
                    this.editingChar.isNPC === true ||
                    typeof this.editingChar.npcId === "string";

                try {
                    if (isEditingNPC) {
                        const chatId = this.editingChar.chatId || this.currentChatId;
                        if (!chatId) {
                            alert("Cannot save NPC: No chat context found.");
                            return;
                        }
                        if (!this.editingChar.npcId) {
                            alert("Cannot save NPC: Missing NPC ID.");
                            return;
                        }

                        const res = await axios.put(
                            `/api/chats/${chatId}/npcs/${this.editingChar.npcId}`,
                            { data: this.editingChar.data }
                        );

                        if (res.data.success) {
                            this.editingChar = null;
                            await this.loadChatNPCs(chatId);
                            this.showNotification("NPC saved successfully!", "success");
                        } else {
                            alert("Failed to save NPC: " + (res.data.error || "Unknown error"));
                        }
                    } else {
                        // Sync tags to character data before saving
                        if (this.editingChar.data) {
                            this.editingChar.data.tags = [...this.editingTags];
                        }
                        
                        // Save as global character
                        const res = await axios.post("/api/characters", this.editingChar);
                        if (res.data.success) {
                            this.editingChar = null;
                            await this.fetchCharacters();
                            this.showNotification("Character saved successfully!", "success");
                        } else {
                            alert("Failed to save character: " + (res.data.error || "Unknown error"));
                        }
                    }
                } catch (e) {
                    console.error("Save failed", e);
                    alert("Failed to save: " + (e.response?.data?.error || e.message));
                }
            },


            async deleteCharacter(char) {
                if (!confirm(`Delete character "${char.data.name}"?`)) return;
                this.showUndoToast('character', char._filename);
                try {
                    await axios.delete(`/api/characters/${char._filename}`);
                    await this.fetchCharacters();
                } catch (e) {
                    console.error('Failed to delete character:', e);
                    alert('Failed to delete character.');
                }
            },

            async reimportAndRefreshCharacters() {
                this.isReimporting = true;
                try {
                    await axios.post('/api/reimport/characters');
                    await this.fetchCharacters();
                } catch (e) {
                    console.error('Failed to reimport characters:', e);
                    alert('Failed to reimport characters.');
                } finally {
                    this.isReimporting = false;
                }
            },

            async generateDanbooruTags() {
                if (!this.editingChar) return;
                
                // Check if gender is set
                if (!this.editingChar.data.extensions.gender) {
                    this.showNotification('Please select a gender (Female/Male/Other) first', 'warning');
                    return;
                }
                
                // Check if description exists
                if (!this.editingChar.data.description || !this.editingChar.data.description.trim()) {
                    this.showNotification('Please add a Description with physical details (hair color, eye color, etc.)', 'warning');
                    return;
                }
                
                this.isGeneratingDanbooruTags = true;
                
                try {
                    const isNPC = this.editingChar.isNPC === true || typeof this.editingChar.npcId === "string";
                    let res;
                    
                    const requestData = {
                        description: this.editingChar.data.description,
                        gender: this.editingChar.data.extensions.gender
                    };
                    
                    if (isNPC) {
                        const chatId = this.editingChar.chatId || this.currentChatId;
                        const npcId = this.editingChar.npcId;
                        res = await axios.post(
                            `/api/chats/${chatId}/npcs/${npcId}/generate-danbooru-tags`,
                            requestData
                        );
                    } else {
                        res = await axios.post(
                            `/api/characters/${this.editingChar._filename}/generate-danbooru-tags`,
                            requestData
                        );
                    }
                    
                    if (res.data.success) {
                        // Overwrite the Danbooru Tag field completely
                        this.editingChar.data.extensions.danbooru_tag = res.data.suggested_tags;
                        this.showNotification(`Generated Danbooru tags: ${res.data.suggested_tags.substring(0, 50)}...`, 'success');
                    } else {
                        this.showNotification(res.data.message || 'Could not generate Danbooru tags', 'warning');
                    }
                } catch (e) {
                    console.error('Failed to generate Danbooru tags:', e);
                    this.showNotification('Failed to generate Danbooru tags', 'error');
                } finally {
                    this.isGeneratingDanbooruTags = false;
                }
            },

            // ========== MESSAGING ==========
            async resolveMode(userMessage) {
                if (!this.canGenerateText()) {
                    return 'narrator';
                }

                if (!this.activeCharacters) {
                    this.activeCharacters = [];
                }

                if (this.activeCharactersWithData().length === 1) {
                    if (this.selectedMode === 'narrator') return 'narrator';
                    if (this.selectedMode === 'auto') return 'focus:' + this.activeCharactersWithData()[0].data.name;
                    return this.selectedMode;
                }

                if (this.activeCharactersWithData().length === 0) {
                    return 'narrator';
                }

                if (this.selectedMode !== 'auto') {
                    return this.selectedMode;
                }

                this.isClassifyingMode = true;
                try {
                    const charNames = this.activeCharactersWithData().map(c => c.data.name);
                    const res = await axios.post('/api/classify-mode', {
                        user_message: userMessage,
                        character_names: charNames
                    });
                    if (res.data.success) {
                        return res.data.mode;
                    }
                } catch (e) {
                    console.error('Mode classification failed', e);
                } finally {
                    this.isClassifyingMode = false;
                }

                return 'narrator';
            },

            getSpeakerFromMode(resolvedMode) {
                if (resolvedMode.startsWith('focus:')) {
                    return resolvedMode.split(':')[1];
                }
                return 'Narrator';
            },

            async sendMessage() {
                if (!this.input.trim() || this.isLoading) return;

                // Generate UUID for new chats if currentChatId is null/undefined
                if (!this.currentChatId) {
                    this.currentChatId = 'new_chat_' + crypto.randomUUID();
                    console.log('[CHAT ID] Generated new client-side chat ID:', this.currentChatId);
                }

                const userMsg = { role: 'user', content: this.input, id: Date.now() };
                this.messages.push(userMsg);
                const currentInput = this.input;
                this.input = '';
                this.isLoading = true;
                this.scrollToBottom();

                try {
                    const mode = await this.resolveMode(currentInput);
                    const res = await axios.post('/api/chat', {
                        messages: this.messages,
                        summary: this.summary,
                        characters: this.activeCharactersWithData(),
                        world_info: this.settings.world_info_enabled ? this.activeWI : null,
                        settings: this.settings,
                        mode: mode,
                        chat_id: this.currentChatId
                    });

                    if (res.data._updated_state) {
                        if (res.data._updated_state.summary !== this.summary) {
                            this.messages = res.data._updated_state.messages;
                        }
                        this.summary = res.data._updated_state.summary;
                    }

                    // Always use chat_id returned from backend (whether new or existing)
                    if (res.data._chat_id) {
                        this.currentChatId = res.data._chat_id;
                        console.log('[CHAT ID] Updated currentChatId from /api/chat response:', this.currentChatId);
                    } else {
                        console.warn('[CHAT ID] No _chat_id returned from /api/chat');
                    }

                    let aiContent = '';
                    if (res.data.message && res.data.message.content) {
                        aiContent = res.data.message.content;
                    } else if (res.data.results && res.data.results.length > 0) {
                        aiContent = res.data.results[0].text;
                    } else if (res.data.text) {
                        aiContent = res.data.text;
                    }

                    const aiMsg = {
                        role: 'assistant',
                        speaker: this.getSpeakerFromMode(mode),
                        content: aiContent.trim(),
                        id: Date.now() + 1
                    };
                    this.messages.push(aiMsg);
                    await this.autosaveChat();

                } catch (e) {
                    console.error('Send message failed:', e);
                    const errorMsg = e.response?.data?.error || e.message || 'Failed to send message';
                    this.messages.push({
                        role: 'assistant',
                        speaker: 'System',
                        content: `Error: ${errorMsg}`,
                        id: Date.now() + 1
                    });
                } finally {
                    this.isLoading = false;
                    this.scrollToBottom();
                    this.updateTokenCount();
                }
            },

            async regenerate(index) {
                if (this.isLoading) return;
                this.messages = this.messages.slice(0, index + 1);
                this.isLoading = true;
                this.scrollToBottom();

                try {
                    const lastUserMsg = this.messages[index];
                    const mode = await this.resolveMode(lastUserMsg?.content || '');
                    const res = await axios.post('/api/chat', {
                        messages: this.messages,
                        summary: this.summary,
                        characters: this.activeCharactersWithData(),
                        world_info: this.settings.world_info_enabled ? this.activeWI : null,
                        settings: this.settings,
                        mode: mode
                    });

                    if (res.data._updated_state) {
                        if (res.data._updated_state.summary !== this.summary) {
                            this.messages = res.data._updated_state.messages;
                        }
                        this.summary = res.data._updated_state.summary;
                    }

                    let aiContent = '';
                    if (res.data.message && res.data.message.content) {
                        aiContent = res.data.message.content;
                    } else if (res.data.results && res.data.results.length > 0) {
                        aiContent = res.data.results[0].text;
                    } else if (res.data.text) {
                        aiContent = res.data.text;
                    }

                    const aiMsg = {
                        role: 'assistant',
                        speaker: this.getSpeakerFromMode(mode),
                        content: aiContent.trim(),
                        id: Date.now() + 1
                    };
                    this.messages.push(aiMsg);

                } catch (e) {
                    console.error('Regenerate failed:', e);
                    const errorMsg = e.response?.data?.error || e.message || 'Failed to regenerate';
                    this.messages.push({
                        role: 'assistant',
                        speaker: 'System',
                        content: `Error: ${errorMsg}`,
                        id: Date.now() + 1
                    });
                } finally {
                    this.isLoading = false;
                    this.scrollToBottom();
                    this.updateTokenCount();
                }
            },

            async deleteMessage(index) {
                if (confirm('Delete this turn from history?')) {
                    this.messages.splice(index, 1);
                    this.updateTokenCount();
                }
            },

            updateMessage(index) {
                this.messages[index].content = this.editBuffer;
                this.editingMessageId = null;
                this.editingWidth = null;
                this.editBuffer = '';
                this.updateTokenCount();
            },

            // ========== IMAGE GENERATION ==========
            async generateImage() {
                this.isLoading = true;
                this.showImagePanel = false;
                try {
                    const res = await axios.post('/api/generate-image', this.sdParams);

                    const imageMsg = {
                        role: 'assistant',
                        speaker: 'Visual System',
                        content: '',
                        image: res.data.url,
                        id: Date.now(),
                        is_favorite: false,
                        favorite_id: null,
                        favoriteMenuVisible: false,
                        manualImageData: {
                            prompt: this.sdParams.prompt,
                            negative_prompt: this.sdParams.negative_prompt || '',
                            steps: this.sdParams.steps,
                            cfg_scale: this.sdParams.cfg_scale,
                            width: this.sdParams.width,
                            height: this.sdParams.height,
                            sampler: this.sdParams.sampler || 'Euler a',
                            scheduler: this.sdParams.scheduler || 'Automatic'
                        }
                    };
                    this.messages.push(imageMsg);
                } catch (e) {
                    console.error(e);
                } finally {
                    this.isLoading = false;
                    this.scrollToBottom();
                }
            },

            async copyImageSettings(imageUrl) {
                try {
                    const filename = imageUrl.split('/').pop();
                    const res = await axios.get(`/api/image-metadata/${filename}`);
                    if (res.data.success && res.data.metadata) {
                        const metadata = res.data.metadata;
                        this.sdParams.prompt = metadata.prompt;
                        this.sdParams.negative_prompt = metadata.negative_prompt;
                        this.sdParams.steps = metadata.steps;
                        this.sdParams.cfg_scale = metadata.cfg_scale;
                        this.sdParams.width = metadata.width;
                        this.sdParams.height = metadata.height;
                        this.sdParams.sampler_name = metadata.sampler_name;
                        this.sdParams.scheduler = metadata.scheduler;
                        this.showImagePanel = true;
                        alert('Image settings copied!');
                    } else {
                        alert('No metadata found for this image.');
                    }
                } catch (e) {
                    console.error('Failed to copy image settings:', e);
                    alert('Failed to copy image settings.');
                }
            },

            // ========== INPAINTING ==========
            openInpaintDialog(message, index) {
                const imageUrl = message.snapshot ? message.snapshot.image_url : message.image;
                this.inpaintImageUrl = imageUrl;
                this.inpaintMessageIndex = index;
                this.inpaintPrompt = '';
                this.brushHistory = [];
                this.inpaintPreviewUrl = null;
                this.isPreviewMode = false;
                this.originalImageBackup = null;
                this.showInpaintDialog = true;

                // Use a named function reference for proper removal later
                this._inpaintKeyHandler = this.handleInpaintKeyboard.bind(this);
                document.addEventListener('keydown', this._inpaintKeyHandler);
            },

            handleInpaintKeyboard(e) {
                if (!this.showInpaintDialog) return;

                // Check for Ctrl+Z or Cmd+Z
                if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'z') {
                    e.preventDefault();
                    e.stopPropagation();
                    this.undoBrushStroke();
                    console.log('Ctrl+Z pressed');
                }
            },

            initializeInpaintCanvas() {
                const img = document.getElementById('inpaint-image');
                const canvas = document.getElementById('inpaint-canvas');
                if (!img || !canvas) return;

                canvas.width = img.naturalWidth;
                canvas.height = img.naturalHeight;
                canvas.style.width = img.width + 'px';
                canvas.style.height = img.height + 'px';

                this.overlayCtx = canvas.getContext('2d');

                this.maskCanvas = document.createElement('canvas');
                this.maskCanvas.width = img.naturalWidth;
                this.maskCanvas.height = img.naturalHeight;
                this.maskCtx = this.maskCanvas.getContext('2d');

                // Clear and save initial state
                this.brushHistory = [];
                this.maskCtx.fillStyle = 'black';
                this.maskCtx.fillRect(0, 0, this.maskCanvas.width, this.maskCanvas.height);

                // Save initial empty state
                const initialState = this.maskCtx.getImageData(0, 0, this.maskCanvas.width, this.maskCanvas.height);
                this.brushHistory.push(initialState);

                this.overlayCtx.clearRect(0, 0, canvas.width, canvas.height);

                console.log('Inpaint canvas initialized');
            },

            startDrawing(e) {
                this.isDrawing = true;
                this.draw(e);
            },

            draw(e) {
                if (!this.isDrawing) return;
                const canvas = document.getElementById('inpaint-canvas');
                const rect = canvas.getBoundingClientRect();
                const scaleX = canvas.width / rect.width;
                const scaleY = canvas.height / rect.height;
                const x = (e.clientX - rect.left) * scaleX;
                const y = (e.clientY - rect.top) * scaleY;

                this.maskCtx.fillStyle = this.brushMode === 'paint' ? 'white' : 'black';
                this.maskCtx.beginPath();
                this.maskCtx.arc(x, y, this.brushSize / 2, 0, Math.PI * 2);
                this.maskCtx.fill();
                this.redrawOverlay();
            },

            stopDrawing() {
                if (this.isDrawing) {
                    // Save current state BEFORE stopping
                    const imageData = this.maskCtx.getImageData(0, 0, this.maskCanvas.width, this.maskCanvas.height);
                    this.brushHistory.push(imageData);
                    this.isDrawing = false;
                }
            },

            trackBrushCursor(e) {
                const canvas = document.getElementById('inpaint-canvas');
                if (!canvas) return;
                const rect = canvas.getBoundingClientRect();
                this.brushCursorX = e.clientX - rect.left;
                this.brushCursorY = e.clientY - rect.top;
                if (this.isDrawing) {
                    this.draw(e);
                }
            },

            hideBrushCursor() {
                this.showBrushCursor = false;
            },

            undoBrushStroke() {
                // Need at least 2 states: initial + at least one stroke
                if (this.brushHistory.length < 1) {
                    console.log('Nothing to undo');
                    return;
                }

                // Pop the current state
                this.brushHistory.pop();

                if (this.brushHistory.length > 0) {
                    // Restore the previous state
                    const previousState = this.brushHistory[this.brushHistory.length - 1];
                    this.maskCtx.putImageData(previousState, 0, 0);
                } else {
                    // No more history, clear to initial state
                    this.maskCtx.fillStyle = 'black';
                    this.maskCtx.fillRect(0, 0, this.maskCanvas.width, this.maskCanvas.height);
                }

                this.redrawOverlay();
                console.log('Undo performed, history length:', this.brushHistory.length);
            },

            redrawOverlay() {
                this.overlayCtx.clearRect(0, 0, this.overlayCtx.canvas.width, this.overlayCtx.canvas.height);
                const imageData = this.maskCtx.getImageData(0, 0, this.maskCanvas.width, this.maskCanvas.height);
                const data = imageData.data;
                this.overlayCtx.fillStyle = 'rgba(255, 100, 100, 0.3)';
                for (let i = 0; i < data.length; i += 4) {
                    if (data[i] > 128) {
                        const pixelIndex = i / 4;
                        const x = pixelIndex % this.maskCanvas.width;
                        const y = Math.floor(pixelIndex / this.maskCanvas.width);
                        this.overlayCtx.fillRect(x, y, 1, 1);
                    }
                }
            },

            clearMask() {
                if (!this.maskCtx || !this.overlayCtx) return;
                this.maskCtx.fillStyle = 'black';
                this.maskCtx.fillRect(0, 0, this.maskCanvas.width, this.maskCanvas.height);
                this.overlayCtx.clearRect(0, 0, this.overlayCtx.canvas.width, this.overlayCtx.canvas.height);
                this.brushHistory = [];
            },

            async generateInpaintPreview() {
                if (!this.inpaintPrompt.trim()) {
                    alert('Please enter an inpaint prompt.');
                    return;
                }

                this.isInpainting = true;
                try {
                    const img = document.getElementById('inpaint-image');
                    const tempCanvas = document.createElement('canvas');
                    tempCanvas.width = img.naturalWidth;
                    tempCanvas.height = img.naturalHeight;
                    const tempCtx = tempCanvas.getContext('2d');
                    tempCtx.drawImage(img, 0, 0);
                    const imageBase64 = tempCanvas.toDataURL('image/png').split(',')[1];
                    const maskBase64 = this.maskCanvas.toDataURL('image/png').split(',')[1];

                    const res = await axios.post('/api/inpaint', {
                        image: imageBase64,
                        mask: maskBase64,
                        prompt: this.inpaintPrompt,
                        width: img.naturalWidth,
                        height: img.naturalHeight,
                        denoising_strength: this.inpaintDenoisingStrength
                    });

                    if (res.data.url) {
                        this.inpaintPreviewUrl = res.data.url;
                        this.isPreviewMode = true;
                        if (!this.originalImageBackup) {
                            this.originalImageBackup = this.inpaintImageUrl;
                        }
                    } else {
                        alert('Inpainting failed: ' + (res.data.error || 'Unknown error'));
                    }
                } catch (e) {
                    console.error('Inpaint failed:', e);
                    alert('Inpainting failed. Is the SD backend running?');
                } finally {
                    this.isInpainting = false;
                }
            },

            acceptInpaint() {
                if (!this.inpaintPreviewUrl) return;
                const msg = this.messages[this.inpaintMessageIndex];

                if (msg.snapshot) {
                    msg.snapshot.image_url = this.inpaintPreviewUrl;
                } else {
                    msg.image = this.inpaintPreviewUrl;
                }

                this.closeInpaintDialog();
                alert('Inpaint accepted!');
            },

            discardInpaint() {
                this.inpaintPreviewUrl = null;
                this.isPreviewMode = false;
            },

            closeInpaintDialog() {
                this.showInpaintDialog = false;
                this.inpaintImageUrl = '';
                this.inpaintPrompt = '';
                this.inpaintMessageIndex = null;
                this.brushHistory = [];
                this.inpaintPreviewUrl = null;
                this.isPreviewMode = false;
                this.originalImageBackup = null;

                // Remove the keyboard listener
                if (this._inpaintKeyHandler) {
                    document.removeEventListener('keydown', this._inpaintKeyHandler);
                    this._inpaintKeyHandler = null;
                }
            },

            // ========== FORKING / BRANCHING ==========
            openForkDialog(msgId) {
                this.forkBranchName = '';
                this.isForking = false;
                this.showForkDialog = true;
                this.forkMessageId = msgId;

                const msg = this.messages.find(m => m.id === msgId);
                if (msg && msg.content) {
                    const preview = msg.content.length > 30 ? msg.content.substring(0, 27) + '...' : msg.content;
                    const timestamp = new Date().toLocaleString();
                    this.forkBranchName = `Fork from ${timestamp} - "${preview}"`;
                }
            },

            async createFork() {
                if (!this.forkBranchName || this.isForking) return;
                this.isForking = true;

                try {
                    const res = await axios.post('/api/chats/fork', {
                        origin_chat_name: this.currentChatName || 'current',
                        fork_from_message_id: this.forkMessageId,
                        branch_name: this.forkBranchName
                    });

                    if (res.data.success) {
                        alert(`Branch "${this.forkBranchName}" created!`);
                        this.showForkDialog = false;
                        await this.fetchChats();
                        this.loadChat(res.data.name);
                    } else {
                        alert(`Failed to create branch: ${res.data.error}`);
                    }
                } catch (e) {
                    console.error('Fork creation failed', e);
                    alert('Failed to create branch.');
                } finally {
                    this.isForking = false;
                }
            },

            renameBranchDialog(branch) {
                this.renameBranchName = branch.branch_name || branch.name;
                this.currentBranchToRename = branch;
                this.showRenameDialog = true;
            },

            async renameBranch() {
                if (!this.renameBranchName || this.isRenaming) return;
                this.isRenaming = true;

                try {
                    const res = await axios.put(`/api/chats/${this.currentBranchToRename.name}/rename-branch`, {
                        branch_name: this.renameBranchName
                    });

                    if (res.data.success) {
                        alert('Branch renamed!');
                        this.showRenameDialog = false;
                        await this.fetchChats();
                    } else {
                        alert(`Failed to rename: ${res.data.error}`);
                    }
                } catch (e) {
                    console.error('Branch rename failed', e);
                    alert('Failed to rename branch.');
                } finally {
                    this.isRenaming = false;
                }
            },

            isBranch(chatName) {
                return chatName.includes('_fork_');
            },

            getDisplayName(chatName) {
                return chatName;
            },

            getBranchOrigin(chatName) {
                const match = chatName.match(/^(.+)_fork_\d+$/);
                return match ? match[1] : 'Unknown';
            },

            // ========== WORLD INFO ==========
            async toggleCanonLaw(wi, uid) {
                const entry = wi.entries[uid];
                if (!entry) return;
                const newValue = !entry.is_canon_law;

                try {
                    const res = await axios.post('/api/world-info/edit-entry', {
                        world_name: wi.name,
                        entry_uid: uid,
                        field: 'is_canon_law',
                        new_value: newValue
                    });

                    if (res.data.success) {
                        entry.is_canon_law = newValue;
                    } else {
                        alert(`Error: ${res.data.error}`);
                        entry.is_canon_law = !newValue;
                    }
                } catch (e) {
                    console.error('Failed to toggle canon law:', e);
                    entry.is_canon_law = !newValue;
                }
            },

            startEditWorldEntry(worldInfo, entryUid) {
                const entry = worldInfo.entries[entryUid];
                const keyStr = Array.isArray(entry.key) ? entry.key.join(', ') : entry.key || '';
                this.editingWorldEntry = {
                    world_name: worldInfo.name,
                    entry_uid: entryUid,
                    entry: {
                        key: keyStr,
                        comment: entry.comment || '',
                        content: entry.content || '',
                        is_canon_law: entry.is_canon_law || false,
                        useProbability: entry.useProbability || false,
                        probability: entry.probability || 100
                    },
                    original: {
                        key: keyStr,
                        comment: entry.comment || '',
                        content: entry.content || '',
                        is_canon_law: entry.is_canon_law || false,
                        useProbability: entry.useProbability || false,
                        probability: entry.probability || 100
                    }
                };
                
                // Load existing tags for world editing
                this.loadWorldTags(worldInfo.name);
            },

            startAddWorldEntry() {
                if (!this.activeWI) {
                    alert("Please select a world info first.");
                    return;
                }
                this.editingWorldEntry = {
                    world_name: this.activeWI.name,
                    entry_uid: null,
                    entry: {
                        key: '',
                        comment: '',
                        content: '',
                        is_canon_law: false,
                        useProbability: true,
                        probability: 100
                    }
                };
            },

            async saveWorldEntry() {
                if (!this.editingWorldEntry) return;
                try {
                    // Check if this is a new entry (entry_uid is null)
                    if (this.editingWorldEntry.entry_uid === null) {
                        // Call addWorldEntry for new entries
                        await this.addWorldEntry();
                        return;
                    }
                    
                    const fields = [
                        { field: 'key', value: this.editingWorldEntry.entry.key },
                        { field: 'comment', value: this.editingWorldEntry.entry.comment },
                        { field: 'content', value: this.editingWorldEntry.entry.content },
                        { field: 'is_canon_law', value: this.editingWorldEntry.entry.is_canon_law }
                    ];

                    const changedFields = [];
                    for (const f of fields) {
                        if (!this.editingWorldEntry.original) {
                            changedFields.push(f);
                        } else {
                            const originalValue = this.editingWorldEntry.original[f.field];
                            if (originalValue !== f.value) {
                                changedFields.push(f);
                            }
                        }
                    }

                    for (const f of changedFields) {
                        const res = await axios.post('/api/world-info/edit-entry', {
                            world_name: this.editingWorldEntry.world_name,
                            entry_uid: this.editingWorldEntry.entry_uid,
                            field: f.field,
                            new_value: f.value
                        });
                        if (!res.data.success) {
                            throw new Error(`Failed to save ${f.field}: ${res.data.error}`);
                        }
                    }
  
                    // Save tags for world
                    await axios.post(`/api/world-info/${this.editingWorldEntry.world_name}/tags`, { tags: this.editingWorldTags });
                    
                    alert("World info entry saved!");
                    this.editingWorldEntry = null;
                    await this.fetchWorldInfo();
                } catch (e) {
                    console.error("Failed to save world entry", e);
                    alert("Failed to save world info entry: " + e.message);
                }
            },

            async addWorldEntry() {
                if (!this.editingWorldEntry || !this.editingWorldEntry.world_name) return;
                this.isAddingWorldEntry = true;

                try {
                    const res = await axios.post('/api/world-info/add-entry', {
                        world_name: this.editingWorldEntry.world_name,
                        entry_data: {
                            key: this.editingWorldEntry.entry.key.split(',').map(k => k.trim()),
                            comment: this.editingWorldEntry.entry.comment,
                            content: this.editingWorldEntry.entry.content,
                            is_canon_law: this.editingWorldEntry.entry.is_canon_law,
                            // Preserve probability fields for SillyTavern compatibility
                            useProbability: this.editingWorldEntry.entry.useProbability,
                            probability: this.editingWorldEntry.entry.probability
                        },
                        tags: this.editingWorldTags
                    });

                    if (res.data.success) {
                        await this.fetchWorldInfo();
                        alert("Entry added!");
                        this.editingWorldEntry = null;
                    } else {
                        alert(`Error: ${res.data.error}`);
                    }
                } catch (e) {
                    console.error("Failed to add world entry", e);
                    alert("Failed to add entry.");
                } finally {
                    this.isAddingWorldEntry = false;
                }
            },

            async deleteWorldEntry(worldName, entryUid) {
                if (!worldName || !entryUid) return;
                if (!confirm('Delete this world info entry?')) return;

                this.showUndoToast('world_info', entryUid);
                this.isDeletingWorldEntry = true;

                try {
                    const res = await axios.post('/api/world-info/delete-entry', {
                        world_name: worldName,
                        entry_uid: entryUid
                    });

                    if (res.data.success) {
                        const worldIndex = this.worldInfos.findIndex(w => w.name === worldName);
                        if (worldIndex !== -1) {
                            delete this.worldInfos[worldIndex].entries[entryUid];
                        }
                        alert("Entry deleted!");
                    } else {
                        alert(`Error: ${res.data.error}`);
                    }
                } catch (e) {
                    console.error("Failed to delete world entry", e);
                    alert("Failed to delete entry.");
                } finally {
                    this.isDeletingWorldEntry = false;
                }
            },

            async deleteWorld(world) {
                if (!confirm(`Delete world "${world.name}"?`)) return;
                this.showUndoToast('world_info', world.name);

                try {
                    await axios.delete(`/api/world-info/${world.name}`);
                    await this.fetchWorldInfo();
                    if (this.activeWI?.name === world.name) {
                        this.activeWI = null;
                    }
                    alert(`World deleted!`);
                } catch (e) {
                    console.error('Failed to delete world:', e);
                    alert('Failed to delete world.');
                }
            },

            async editWorldEntryAI(section) {
                if (!this.editingWorldEntry) {
                    this.showNotification('No world entry selected for editing', 'error');
                    return;
                }
                this.isEditingWorldEntry = true;

                let contextText = "";
                if (this.worldEditContextMode === 'manual') {
                    if (!this.worldEditContextText || !this.worldEditContextText.trim()) {
                        this.showNotification("Please provide context for AI generation.", 'warning');
                        this.isEditingWorldEntry = false;
                        return;
                    }
                    contextText = this.worldEditContextText;
                } else {
                    if (!this.messages || this.messages.length === 0) {
                        this.showNotification("Start a conversation first or switch to Manual mode.", 'warning');
                        this.isEditingWorldEntry = false;
                        return;
                    }
                    contextText = this.messages.slice(-50).map(m => `${m.speaker || m.role}: ${m.content}`).join('\n');
                }

                try {
                    // Use 'neutral' as default tone to match backend options
                    const tone = this.worldGen?.tone || 'neutral';
                    console.log(`Generating world entry AI: section=${section}, tone=${tone}, context_length=${contextText.length}`);
                    
                    const res = await axios.post('/api/world-info/edit-entry-ai', {
                        world_name: this.editingWorldEntry.world_name,
                        entry_uid: this.editingWorldEntry.entry_uid,
                        section: section,
                        tone: tone,
                        context: contextText,
                        source_mode: this.worldEditContextMode
                    });

                    if (res.data.success && res.data.text) {
                        this.editingWorldEntry.entry.content = res.data.text;
                        this.showNotification(`${section} content generated successfully!`, 'success');
                    } else {
                        const errorMsg = res.data.error || 'Unknown error generating content';
                        this.showNotification(`Error: ${errorMsg}`, 'error');
                    }
                } catch (e) {
                    console.error(`Failed to edit ${section}`, e);
                    const errorMsg = e.response?.data?.error || e.message || `Failed to generate ${section} content`;
                    this.showNotification(errorMsg, 'error');
                } finally {
                    this.isEditingWorldEntry = false;
                }
            },

            async reimportAndRefreshWorldInfo() {
                this.isReimporting = true;
                try {
                    const res = await axios.post('/api/reimport/worldinfo', { smart_sync: true });
                    if (res.data.success) {
                        alert(`Synced successfully!`);
                    } else {
                        alert(`Sync failed: ${res.data.error}`);
                    }
                    await this.fetchWorldInfo();
                } catch (e) {
                    console.error('Failed to sync world info:', e);
                    alert('Failed to sync world info.');
                } finally {
                    this.isReimporting = false;
                }
            },

            // ========== CARD/WORLD GENERATION ==========
            openCardGen() {
                this.showCardGen = true;
            },

            openWorldGen() {
                this.showWorldGen = true;
            },

            async generateField(fieldType) {
                if (!this.cardGen.loading) this.cardGen.loading = {};
                if (!this.cardGen.char_name) {
                    alert("Please enter a character name first.");
                    return;
                }

                if (this.cardGen.source_mode === 'manual' && !this.cardGen.manual_text.trim()) {
                    alert("Please enter some manual text.");
                    return;
                }

                if (this.cardGen.source_mode === 'chat' && this.messages.length === 0) {
                    alert("Start a conversation first or switch to Manual mode!");
                    return;
                }

                this.cardGen.loading[fieldType] = true;

                let contextText = "";
                if (this.cardGen.source_mode === 'manual') {
                    contextText = this.cardGen.manual_text;
                } else {
                    contextText = this.messages.slice(-20).map(m => `${m.speaker || m.role}: ${m.content}`).join('\n');
                }

                try {
                    const res = await axios.post('/api/card-gen/generate-field', {
                        char_name: this.cardGen.char_name,
                        field_type: fieldType,
                        context: contextText,
                        source_mode: this.cardGen.source_mode
                    });

                    if (res.data.success) {
                        if (fieldType.startsWith('dialogue')) {
                            if (!this.cardGen.fields.dialogue.includes('<START>')) this.cardGen.fields.dialogue = '';
                            this.cardGen.fields.dialogue += (this.cardGen.fields.dialogue ? '\n' : '') + '<START>\n' + res.data.text;
                        } else {
                            this.cardGen.fields[fieldType] = res.data.text;
                        }
                    } else {
                        alert(`Error generating ${fieldType}: ${res.data.error}`);
                    }
                } catch (e) {
                    console.error(`Failed to gen ${fieldType}`, e);
                    alert(`Connection error generating ${fieldType}.`);
                } finally {
                    this.cardGen.loading[fieldType] = false;
                }
            },

            async generateAllFields() {
                const fields = ['personality', 'body', 'genre', 'scenario', 'first_message', 'dialogue_likes', 'dialogue_story'];

                if (!this.cardGen.char_name) {
                    alert("Please enter a character name first.");
                    return;
                }

                if (this.cardGen.source_mode === 'manual' && !this.cardGen.manual_text.trim()) {
                    alert("Please enter some manual text.");
                    return;
                }

                if (this.cardGen.source_mode === 'chat' && this.messages.length === 0) {
                    alert("Start a conversation first or switch to Manual mode!");
                    return;
                }

                this.isGenLoading = true;
                this.cardGen.fields.dialogue = '';

                // Track successes and failures
                let successCount = 0;
                let failedFields = [];

                for (const f of fields) {
                    try {
                        // Set loading state for this specific field
                        if (!this.cardGen.loading) this.cardGen.loading = {};
                        this.cardGen.loading[f] = true;

                        let contextText = "";
                        if (this.cardGen.source_mode === 'manual') {
                            contextText = this.cardGen.manual_text;
                        } else {
                            contextText = this.messages.slice(-20).map(m => `${m.speaker || m.role}: ${m.content}`).join('\n');
                        }

                        const res = await axios.post('/api/card-gen/generate-field', {
                            char_name: this.cardGen.char_name,
                            field_type: f,
                            context: contextText,
                            source_mode: this.cardGen.source_mode
                        });

                            if (res.data.success && res.data.text) {
                                // Check if response is JSON (from 'full' field type)
                                if (f === 'full' && res.data.text.startsWith('{')) {
                                    // Parse structured data
                                    const fullData = JSON.parse(res.data.text);

                                    // Map to correct fields
                                    this.cardGen.fields.personality = fullData.personality;
                                    this.cardGen.fields.body = fullData.body;
                                    this.cardGen.fields.description = fullData.description;
                                    this.cardGen.fields.scenario = fullData.scenario;
                                    this.cardGen.fields.first_message = fullData.first_message;
                                    this.cardGen.fields.genre = fullData.genre;
                                } else if (f.startsWith('dialogue')) {
                                    if (!this.cardGen.fields.dialogue.includes('<START>')) this.cardGen.fields.dialogue = '';
                                    this.cardGen.fields.dialogue += (this.cardGen.fields.dialogue ? '\n' : '') + '<START>\n' + res.data.text;
                                } else {
                                    this.cardGen.fields[f] = res.data.text;
                                }
                                successCount++;
                                console.log(`Generated ${f} successfully`);
                            } else {
                                console.error(`Failed to generate ${f}: ${res.data.error || 'Unknown error'}`);
                                failedFields.push(f);
                            }
                    } catch (e) {
                        console.error(`Exception generating ${f}:`, e);
                        failedFields.push(f);
                    } finally {
                        if (this.cardGen.loading) this.cardGen.loading[f] = false;
                    }
                }

                this.isGenLoading = false;

                // Show summary notification
                if (failedFields.length === 0) {
                    this.showNotification(`All ${successCount} fields generated successfully!`, 'success');
                } else if (successCount > 0) {
                    this.showNotification(`Generated ${successCount} fields. Failed: ${failedFields.join(', ')}`, 'warning');
                } else {
                    alert(`Failed to generate any fields. Check your LLM connection. Failed fields: ${failedFields.join(', ')}`);
                }
            },

            async saveGeneratedCard() {
                const character_note_parts = [];

                const metadata = [];
                if (this.cardGen.fields.genre) metadata.push(`Genre: ${this.cardGen.fields.genre}`);
                if (metadata.length > 0) character_note_parts.push(`[${metadata.join('; ')}]`);

                const character_note = character_note_parts.join('\n');

                const newCard = {
                    spec: "chara_card_v2",
                    spec_version: "2.0",
                    data: {
                        name: this.cardGen.char_name,
                        description: this.cardGen.fields.body || "",
                        personality: this.cardGen.fields.personality || "",
                        scenario: this.cardGen.fields.scenario || "",
                        first_mes: this.cardGen.fields.first_message,
                        mes_example: this.cardGen.fields.dialogue || "",
                        creator_notes: character_note,
                        system_prompt: "",
                        post_history_instructions: "",
                        alternate_greetings: [],
                        character_book: null,
                        tags: this.cardGen.fields.tags ? this.cardGen.fields.tags.split(',').map(t => t.trim()) : [],
                        creator: "",
                        character_version: "",
                        extensions: {
                            depth_prompt: { prompt: "", depth: 4 },
                            danbooru_tag: '',
                            label_description: '',
                            gender: this.cardGen.gender || ''
                        }
                    }
                };

                try {
                    const res = await axios.post('/api/characters', newCard);
                    if (res.data.success) {
                        alert(`Character "${this.cardGen.char_name}" saved!`);
                        this.showCardGen = false;
                        await this.fetchCharacters();
                    }
                } catch (e) {
                    console.error("Save failed", e);
                    alert("Failed to save character card.");
                }
            },

            async generateWorldSection(section) {
                if (!this.worldGen.loading) this.worldGen.loading = {};
                if (!this.worldGen.world_name) {
                    this.showNotification("Please enter a world name first.", 'warning');
                    return;
                }

                if (this.worldGen.source_mode === 'manual' && (!this.worldGen.manual_text || !this.worldGen.manual_text.trim())) {
                    this.showNotification("Please enter some manual text.", 'warning');
                    return;
                }

                if (this.worldGen.source_mode === 'chat' && (!this.messages || this.messages.length === 0)) {
                    this.showNotification("Start a conversation first or switch to Manual mode!", 'warning');
                    return;
                }

                let contextText = "";
                if (this.worldGen.source_mode === 'manual') {
                    contextText = this.worldGen.manual_text;
                } else {
                    contextText = this.messages.slice(-50).map(m => `${m.speaker || m.role}: ${m.content}`).join('\n');
                }

                this.worldGen.loading[section] = true;

                try {
                    // Use 'neutral' as default tone to match backend options
                    const tone = this.worldGen.tone || 'neutral';
                    console.log(`Generating world section: ${section}, tone=${tone}, context_length=${contextText.length}`);
                    
                    const res = await axios.post('/api/world-gen/generate', {
                        world_name: this.worldGen.world_name,
                        section: section,
                        tone: tone,
                        context: contextText,
                        source_mode: this.worldGen.source_mode
                    });

                    if (res.data.success && res.data.text) {
                        this.worldGen.fields[section] = res.data.text;
                        this.showNotification(`${section} generated successfully!`, 'success');
                    } else {
                        const errorMsg = res.data.error || 'Failed to generate content';
                        this.showNotification(`Error generating ${section}: ${errorMsg}`, 'error');
                    }
                } catch (e) {
                    console.error(`Failed to gen world lore: ${section}`, e);
                    const errorMsg = e.response?.data?.error || e.message || `Failed to generate ${section}`;
                    this.showNotification(errorMsg, 'error');
                } finally {
                    this.worldGen.loading[section] = false;
                }
            },

            async generateAllWorldStuff() {
                if (!this.worldGen.world_name) {
                    this.showNotification("Please enter a world name first.", 'warning');
                    return;
                }

                if (this.worldGen.source_mode === 'manual' && (!this.worldGen.manual_text || !this.worldGen.manual_text.trim())) {
                    this.showNotification("Please enter some manual text.", 'warning');
                    return;
                }

                if (this.worldGen.source_mode === 'chat' && (!this.messages || this.messages.length === 0)) {
                    this.showNotification("Start a conversation first or switch to Manual mode!", 'warning');
                    return;
                }

                this.isWorldLoading = true;
                const sections = ['history', 'locations', 'creatures', 'factions'];
                let successCount = 0;
                let failedSections = [];
                
                for (const s of sections) {
                    try {
                        if (!this.worldGen.loading) this.worldGen.loading = {};
                        this.worldGen.loading[s] = true;
                        
                        let contextText = "";
                        if (this.worldGen.source_mode === 'manual') {
                            contextText = this.worldGen.manual_text;
                        } else {
                            contextText = this.messages.slice(-50).map(m => `${m.speaker || m.role}: ${m.content}`).join('\n');
                        }
                        
                        const tone = this.worldGen.tone || 'neutral';
                        
                        const res = await axios.post('/api/world-gen/generate', {
                            world_name: this.worldGen.world_name,
                            section: s,
                            tone: tone,
                            context: contextText,
                            source_mode: this.worldGen.source_mode
                        });

                        if (res.data.success && res.data.text) {
                            this.worldGen.fields[s] = res.data.text;
                            successCount++;
                        } else {
                            console.error(`Failed to generate ${s}: ${res.data.error}`);
                            failedSections.push(s);
                        }
                    } catch (e) {
                        console.error(`Exception generating ${s}:`, e);
                        failedSections.push(s);
                    } finally {
                        if (this.worldGen.loading) this.worldGen.loading[s] = false;
                    }
                }
                
                this.isWorldLoading = false;
                
                // Show summary notification
                if (failedSections.length === 0) {
                    this.showNotification(`All ${successCount} world sections generated successfully!`, 'success');
                } else if (successCount > 0) {
                    this.showNotification(`Generated ${successCount} sections. Failed: ${failedSections.join(', ')}`, 'warning');
                } else {
                    this.showNotification(`Failed to generate any world sections. Check your LLM connection.`, 'error');
                }
            },

            async saveWorldEvolution() {
                const allEntries = [
                    this.worldGen.fields.history,
                    this.worldGen.fields.locations,
                    this.worldGen.fields.creatures,
                    this.worldGen.fields.factions
                ].filter(t => t.trim()).join('\n');

                if (!allEntries) {
                    alert("No lore entries to save!");
                    return;
                }

                try {
                    const res = await axios.post('/api/world-gen/save', {
                        world_name: this.worldGen.world_name,
                        plist_text: allEntries
                    });

                    if (res.data.success) {
                        alert(`World Lore "${this.worldGen.world_name}" updated!`);
                        this.showWorldGen = false;
                        await this.fetchWorldInfo();
                    }
                } catch (e) {
                    console.error("World save failed", e);
                    alert("Failed to save world lore.");
                }
            },

            async editFieldAI(field) {
                if (!this.editingChar || !this.editingChar.data.name) {
                    alert("Please save the character first.");
                    return;
                }

                this.isEditingField = true;

                let contextText = "";
                if (this.editContextMode === 'manual') {
                    if (!this.editContextText.trim()) {
                        alert("Please provide context.");
                        this.isEditingField = false;
                        return;
                    }
                    contextText = this.editContextText;
                } else {
                    if (this.messages.length === 0) {
                        alert("Start a conversation first.");
                        this.isEditingField = false;
                        return;
                    }
                    contextText = this.messages.slice(-20).map(m => `${m.speaker || m.role}: ${m.content}`).join('\n');
                }

                try {
                    const res = await axios.post('/api/characters/edit-field-ai', {
                        filename: this.editingChar._filename || `${this.editingChar.data.name}.json`,
                        field: field,
                        context: contextText,
                        source_mode: this.editContextMode
                    });

                    if (res.data.success) {
                        if (field === 'body') {
                            this.editingChar.data.description = res.data.text;
                        } else {
                            this.editingChar.data[field] = res.data.text;
                        }
                        alert(`${field} updated!`);
                        // Reload characters from backend to get updated data
                        await this.fetchCharacters();
                    } else {
                        alert(`Error: ${res.data.error}`);
                    }
                } catch (e) {
                    console.error(`Failed to edit ${field}`, e);
                    alert(`Connection error updating ${field}.`);
                } finally {
                    this.isEditingField = false;
                }
            },

            // ========== SEARCH ==========
            async performSearch() {
                if (!this.searchQuery.trim()) {
                    alert('Please enter a search query.');
                    return;
                }

                this.isSearching = true;
                this.searchResults = [];
                this.searchResultsCount = 0;

                try {
                    const res = await axios.post('/api/search/messages', {
                        query: this.searchQuery,
                        chat_id: this.searchFilters.chat_id || null,
                        speaker: this.searchFilters.speaker || null,
                        start_date: this.searchFilters.start_date || null,
                        end_date: this.searchFilters.end_date || null
                    });

                    if (res.data.success) {
                        this.searchResults = res.data.results || [];
                        this.searchResultsCount = res.data.count || this.searchResults.length;
                    } else {
                        alert('Search failed: ' + (res.data.error || 'Unknown error'));
                    }
                } catch (e) {
                    console.error('Search failed:', e);
                    alert('Search failed.');
                } finally {
                    this.isSearching = false;
                }
            },

            toggleSearchFilters() {
                this.showSearchFilters = !this.showSearchFilters;
            },

            clearSearch() {
                this.searchQuery = '';
                this.searchResults = [];
                this.searchResultsCount = 0;
                this.showSearchBar = false;
            },

            clearSearchFilters() {
                this.searchFilters.chat_id = '';
                this.searchFilters.speaker = '';
                this.searchFilters.start_date = '';
                this.searchFilters.end_date = '';
            },

            highlightSearchTerms(content, query) {
                if (!content || !query) return content;

                const terms = query.split(/\s+/).filter(t =>
                    t && !['AND', 'OR', 'NOT'].includes(t.toUpperCase())
                );

                if (terms.length === 0) return content;

                // Escape all regex special characters
                const escapedTerms = terms.map(t =>
                    t.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')
                );

                const pattern = new RegExp(`(${escapedTerms.join('|')})`, 'gi');

                return content.replace(pattern,
                    '<span class="bg-yellow-500/30 text-yellow-200 font-bold px-1 rounded">$1</span>'
                );
            },

            async jumpToMessage(chatId, messageId) {
                if (this.currentChatId !== chatId) {
                    if (!confirm('Load a different chat?')) return;
                    await this.loadChat(chatId);
                }

                const msgIndex = this.messages.findIndex(m => m.id === messageId);
                if (msgIndex !== -1) {
                    setTimeout(() => {
                        const container = document.getElementById('chat-container');
                        if (container) {
                            const messageElements = container.querySelectorAll('.max-w-\$$85\\%\$$');
                            if (messageElements[msgIndex]) {
                                messageElements[msgIndex].scrollIntoView({ behavior: 'smooth', block: 'center' });
                            }
                        }
                    }, 100);
                    this.showSearchBar = false;
                }
            },

            async jumpToOriginChat(originChatId) {
                if (!originChatId) {
                    this.showNotification('No origin chat ID found', 'error');
                    return;
                }

                if (this.currentChatId !== originChatId) {
                    if (!confirm('Load the origin chat?')) return;
                    try {
                        await this.loadChat(originChatId);
                        this.showNotification('Loaded origin chat', 'success');
                    } catch (e) {
                        console.error('Failed to load origin chat:', e);
                        this.showNotification('Failed to load origin chat', 'error');
                    }
                } else {
                    this.showNotification('Already viewing origin chat', 'info');
                }
            },

            async showMessageContext(messageId) {
                try {
                    const res = await axios.get(`/api/search/messages/${messageId}/context`);
                    if (res.data.success) {
                        const context = res.data.context;
                        let contextText = '### Message Context:\n\n';

                        if (context.before && context.before.length > 0) {
                            contextText += '--- Before ---\n';
                            context.before.forEach(msg => {
                                contextText += `${msg.speaker || msg.role}: ${msg.content || '(No content)'}\n`;
                            });
                            contextText += '\n';
                        }

                        contextText += '--- Target Message ---\n';
                        if (context.target) {
                            contextText += `${context.target.speaker || context.target.role}: ${context.target.content || '(No content)'}\n\n`;
                        }

                        if (context.after && context.after.length > 0) {
                            contextText += '--- After ---\n';
                            context.after.forEach(msg => {
                                contextText += `${msg.speaker || msg.role}: ${msg.content || '(No content)'}\n`;
                            });
                        }

                        alert(contextText);
                    } else {
                        alert('Failed to load context.');
                    }
                } catch (e) {
                    console.error('Failed to load context:', e);
                    alert('Failed to load message context.');
                }
            },

            // ========== CHANGE HISTORY ==========
            async fetchChangeHistory() {
                this.isFetchingChanges = true;
                try {
                    const params = {};
                    if (this.changeHistoryFilters.entity_type) params.entity_type = this.changeHistoryFilters.entity_type;
                    if (this.changeHistoryFilters.entity_id) params.entity_id = this.changeHistoryFilters.entity_id;
                    if (this.changeHistoryFilters.limit) params.limit = this.changeHistoryFilters.limit;

                    const res = await axios.get('/api/changes', { params });
                    this.changeHistory = res.data.changes || [];
                } catch (e) {
                    console.error('Failed to fetch change history:', e);
                    alert('Failed to fetch change history.');
                } finally {
                    this.isFetchingChanges = false;
                }
            },

            async restoreChange(changeId) {
                if (!confirm('Restore this version?')) return;
                this.isRestoringChange = true;

                try {
                    const res = await axios.post('/api/changes/restore', { change_id: changeId });
                    if (res.data.success) {
                        alert(`Restored successfully!`);
                        await this.fetchCharacters();
                        await this.fetchWorldInfo();
                        await this.fetchChats();
                    } else {
                        alert(`Restore failed: ${res.data.error}`);
                    }
                } catch (e) {
                    console.error('Restore failed:', e);
                    alert('Failed to restore.');
                } finally {
                    this.isRestoringChange = false;
                }
            },

            canRestoreChange(change) {
                return change.operation === 'UPDATE' || change.operation === 'DELETE';
            },

            formatChangeTimestamp(timestamp) {
                if (!timestamp) return 'Unknown';
                const date = new Date(timestamp * 1000);
                return date.toLocaleString();
            },

            openChangeHistoryModal() {
                this.showChangeHistory = true;
                this.changeHistoryFilters = { entity_type: '', entityid: '', limit: 10 };
                this.fetchChangeHistory();
            },

            // ========== EXPORT ==========
            async exportChatForTraining() {
                if (!this.currentChatId) {
                    this.showNotification('No chat selected. Please save or load a chat first.', 'error');
                    return;
                }

                this.isExporting = true;
                try {
                    const res = await axios.post(`/api/chats/${this.currentChatId}/export-training`, {
                        format: this.exportFormat,
                        include_system: this.exportIncludeSystem,
                        include_world_info: this.exportIncludeWorldInfo,
                        include_npcs: this.exportIncludeNPCs
                    });

                    if (res.data.success) {
                        const blob = new Blob([JSON.stringify(res.data.data, null, 2)], { type: 'application/json' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `${this.currentChatId}_${this.exportFormat}_${Date.now()}.json`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                        this.showNotification(`Exported ${res.data.message_count || 0} messages successfully!`, 'success');
                    } else {
                        this.showNotification('Export failed: ' + (res.data.error || 'Unknown error'), 'error');
                    }
                } catch (e) {
                    console.error('Export failed:', e);
                    this.showNotification('Failed to export chat: ' + (e.response?.data?.error || e.message), 'error');
                } finally {
                    this.isExporting = false;
                }
            },
            openExportDialog() {
                if (!this.currentChatId) {
                    this.showNotification('Please save or load a chat first to export', 'warning');
                    return;
                }
                this.settingsTab = 'export';
                this.showChatSettings = true;
            },

            openChatSettings() {
                this.showChatSettings = true;
            },
            // ========== CACHE MANAGEMENT ==========
            async fetchCacheStats() {
                this.isFetchingCache = true;
                try {
                    const res = await axios.get('/api/world-info/cache/stats');
                    if (res.data.success) {
                        this.cacheStats = res.data.stats;
                    }
                } catch (e) {
                    console.error('Failed to fetch cache stats', e);
                } finally {
                    this.isFetchingCache = false;
                }
            },

            async clearCache() {
                if (!confirm('Clear the world info cache?')) return;
                this.isClearingCache = true;
                try {
                    const res = await axios.post('/api/world-info/cache/clear');
                    if (res.data.success) {
                        alert('Cache cleared!');
                        await this.fetchCacheStats();
                    }
                } catch (e) {
                    console.error('Failed to clear cache', e);
                } finally {
                    this.isClearingCache = false;
                }
            },

            async updateCacheConfig() {
                if (!this.cacheConfig.max_size || this.cacheConfig.max_size < 0) {
                    alert('Please enter a valid cache size.');
                    return;
                }
                this.isUpdatingCache = true;
                try {
                    const res = await axios.post('/api/world-info/cache/configure', {
                        max_size: this.cacheConfig.max_size
                    });
                    if (res.data.success) {
                        alert(`Cache size updated to ${res.data.max_size}`);
                        await this.fetchCacheStats();
                    }
                } catch (e) {
                    console.error('Failed to update cache config', e);
                } finally {
                    this.isUpdatingCache = false;
                }
            },

            async togglePerformanceMode() {
                try {
                    await axios.post('/api/performance/toggle', {
                        enabled: this.settings.performance_mode_enabled
                    });
                } catch (e) {
                    console.error('Failed to toggle performance mode', e);
                }
            },

            // ========== UTILITIES ==========
            scrollToBottom() {
                setTimeout(() => {
                    const container = document.getElementById('chat-container');
                    if (container) container.scrollTop = container.scrollHeight;
                }, 50);
            },

            formatTime(timestamp) {
                if (!timestamp) return 'Unknown time';
                const date = new Date(timestamp * 1000);
                return date.toLocaleString();
            },

            formatDate(timestamp) {
                if (!timestamp) return 'Unknown';
                const date = new Date(timestamp);
                return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
            },

            showUndoToast(entityType, entityId) {
                const existingToast = document.querySelector('.undo-toast');
                if (existingToast) existingToast.remove();

                const undoBtn = document.createElement('button');
                undoBtn.className = 'undo-toast';
                undoBtn.innerHTML = `
                    <div class="undo-toast-content">
                        <span class="undo-icon">↶</span>
                        <span class="undo-text">Undo delete (30s)</span>
                    </div>
                `;

                Object.assign(undoBtn.style, {
                    position: 'fixed',
                    bottom: '20px',
                    right: '20px',
                    backgroundColor: '#2d3748',
                    color: 'white',
                    padding: '12px 20px',
                    borderRadius: '8px',
                    cursor: 'pointer',
                    boxShadow: '0 4px 12px rgba(0,0,0,0.3)',
                    zIndex: '9999',
                    transition: 'opacity 0.3s',
                    border: '1px solid #4a5568'
                });

                undoBtn.onclick = async () => {
                    try {
                        const response = await fetch('/api/undo/last', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ entity_type: entityType, entityid: entityId })
                        });
                        const result = await response.json();

                        if (result.success) {
                            if (entityType === 'character') await this.fetchCharacters();
                            else if (entityType === 'world_info') await this.fetchWorldInfo();
                            else if (entityType === 'chat') await this.fetchChats();
                            this.showNotification(`✓ Restored: ${result.restored_name || result.entity_id}`, 'success');
                        } else {
                            this.showNotification(`✗ Failed: ${result.error}`, 'error');
                        }
                    } catch (error) {
                        console.error('Undo failed:', error);
                        this.showNotification('✗ Network error', 'error');
                    }
                    undoBtn.remove();
                    clearInterval(countdown);
                };

                document.body.appendChild(undoBtn);

                let seconds = 30;
                const textSpan = undoBtn.querySelector('.undo-text');
                const countdown = setInterval(() => {
                    seconds--;
                    if (seconds <= 0) {
                        clearInterval(countdown);
                        undoBtn.style.opacity = '0';
                        setTimeout(() => undoBtn.remove(), 300);
                    } else {
                        textSpan.textContent = `Undo delete (${seconds}s)`;
                    }
                }, 1000);
            },

            showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                notification.className = `notification notification-${type}`;
                notification.textContent = message;
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 12px 24px;
                    background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : type === 'warning' ? '#f59e0b' : '#3b82f6'};
                    color: white;
                    border-radius: 6px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                    z-index: 10000;
                    animation: slideIn 0.3s ease-out;
                `;
                document.body.appendChild(notification);

                setTimeout(() => {
                    notification.style.opacity = '0';
                    notification.style.transition = 'opacity 0.3s';
                    setTimeout(() => notification.remove(), 300);
                }, 3000);
            },

            // ============================================================================
            // SNAPSHOT FUNCTIONS (v1.9.0)
            // ============================================================================

            async checkSnapshotStatus() {
                try {
                    const response = await axios.get('/api/snapshot/status');
                    this.sdAvailable = response.data.available;
                    console.log('[SNAPSHOT] SD available:', this.sdAvailable);
                } catch (e) {
                    console.error('[SNAPSHOT] Status check failed:', e);
                    this.sdAvailable = false;
                }
            },

            async generateSnapshot() {
                if (!this.currentChatId) {
                    alert('Please start a chat first');
                    return;
                }

                if (!this.sdAvailable) {
                    alert('Stable Diffusion is not available. Please check SD settings.');
                    return;
                }

                this.isGeneratingSnapshot = true;

                try {
                    const response = await axios.post('/api/chat/snapshot', {
                        chat_id: this.currentChatId,
                        width: this.sdParams.width,
                        height: this.sdParams.height
                    });

                    if (response.data.error) {
                        throw new Error(response.data.error);
                    }

                    // Add snapshot message to chat
                    this.messages.push({
                        id: Date.now(),
                        role: 'assistant',
                        speaker: 'Visual System',
                        content: '',
                        snapshot: response.data,
                        showDetails: false,
                        is_favorite: false,
                        favorite_id: null
                    });

                    console.log('[SNAPSHOT] Generated:', response.data);

                } catch (e) {
                    console.error('[SNAPSHOT] Generation failed:', e);
                    alert('Snapshot generation failed: ' + e.message);
                } finally {
                    this.isGeneratingSnapshot = false;
                }
            },

            // ============================================================================
            // SNAPSHOT & MANUAL MODE FAVORITES
            // ============================================================================

            showFavoriteMenu(messageId) {
                this.messages.forEach(msg => {
                    if (msg.id !== messageId && msg.favoriteMenuVisible) {
                        msg.favoriteMenuVisible = false;
                    }
                });
                const msg = this.messages.find(m => m.id === messageId);
                if (msg) {
                    msg.favoriteMenuVisible = true;
                }
            },

            hideAllFavoriteMenus() {
                this.messages.forEach(msg => {
                    msg.favoriteMenuVisible = false;
                });
            },

            showManualFavoriteMenu(messageId) {
                // Hide all other favorite menus first
                this.messages.forEach(msg => {
                    if (msg.id !== messageId && msg.favoriteMenuVisible) {
                        msg.favoriteMenuVisible = false;
                    }
                });
                const msg = this.messages.find(m => m.id === messageId);
                if (msg && msg.image) {
                    msg.favoriteMenuVisible = true;
                }
            },

            async toggleManualImageFavorite(messageId, isFavorite) {
                const msg = this.messages.find(m => m.id === messageId);
                if (!msg || !msg.image) return;

                const imageUrl = msg.image;
                const imageData = msg.manualImageData;

                try {
                    if (isFavorite) {
                        // Remove from favorites
                        const favId = msg.favorite_id;
                        if (favId) {
                            const response = await axios.delete(`/api/snapshots/favorites/${favId}`);
                            if (response.data.success) {
                                msg.is_favorite = false;
                                msg.favorite_id = null;
                                console.log('[MANUAL] Removed favorite:', favId);
                            }
                        }
                    } else {
                        // Add to favorites
                        const imageFilename = imageUrl.split('/').pop();
                        const note = prompt("Add a note to this favorite (optional):") || '';

                        const response = await axios.post('/api/manual-generation/favorite', {
                            image_filename: imageFilename,
                            prompt: imageData.prompt,
                            negative_prompt: imageData.negative_prompt,
                            steps: imageData.steps,
                            cfg_scale: imageData.cfg_scale,
                            width: imageData.width,
                            height: imageData.height,
                            sampler: imageData.sampler,
                            scheduler: imageData.scheduler,
                            note: note,
                            chat_id: this.currentChatId || null  // Associate with current chat for jump-to-source
                        });

                        if (response.data.success) {
                            msg.favorite_id = response.data.favorite_id;
                            msg.is_favorite = true;
                            console.log('[MANUAL] Added favorite:', response.data.favorite_id);
                            console.log('[MANUAL] Learned tags:', response.data.tags_learned);
                        } else {
                            alert('Failed to add favorite: ' + response.data.error);
                        }
                    }
                    msg.favoriteMenuVisible = false;
                } catch (e) {
                    console.error('[MANUAL] Toggle favorite error:', e);
                    alert('Failed to toggle favorite: ' + e.message);
                }
            },

            async toggleSnapshotFavorite(messageId, isFavorite) {
                const msg = this.messages.find(m => m.id === messageId);
                if (!msg || !msg.snapshot) return;

                const snapshot = msg.snapshot;
                const chatId = this.currentChatId;

                try {
                    if (isFavorite) {
                        const favId = snapshot.favorite_id;
                        if (favId) {
                            const response = await axios.delete(`/api/snapshots/favorites/${favId}`);
                            if (response.data.success) {
                                snapshot.is_favorite = false;
                                snapshot.favorite_id = null;
                                console.log('[SNAPSHOT] Removed favorite:', favId);
                            }
                        }
                    } else {
                        const imageFilename = snapshot.image_url.split('/').pop();
                        const response = await axios.post(`/api/chat/${chatId}/snapshot/favorite`, {
                            chat_id: chatId,
                            image_filename: imageFilename,
                            prompt: snapshot.prompt,
                            negative_prompt: snapshot.negative_prompt,
                            scene_analysis: snapshot.scene_analysis,
                            character_ref: snapshot.character_ref,
                            tags: this.extractTags(snapshot.prompt),
                            steps: 20,
                            cfg_scale: 7.0,
                            width: 512,
                            height: 512
                        });

                        if (response.data.success) {
                            snapshot.favorite_id = response.data.favorite_id;
                            snapshot.is_favorite = true;
                            console.log('[SNAPSHOT] Added favorite:', response.data.favorite_id);
                            console.log('[SNAPSHOT] Learned tags:', response.data.tags_learned);
                        } else {
                            alert('Failed to add favorite: ' + response.data.error);
                        }
                    }
                    msg.favoriteMenuVisible = false;
                } catch (e) {
                    console.error('[SNAPSHOT] Toggle favorite error:', e);
                    alert('Failed to toggle favorite: ' + e.message);
                }
            },

            async regenerateSnapshot() {
                if (!this.currentChatId || this.isGeneratingSnapshot) {
                    return;
                }

                this.isGeneratingSnapshot = true;

                try {
                    const response = await axios.post(`/api/chat/${this.currentChatId}/snapshot/regenerate`);

                    if (response.data.error) {
                        alert('Regeneration failed: ' + response.data.error);
                        return;
                    }

                    const newSnapshot = {
                        timestamp: Date.now() / 1000,
                        image_url: response.data.image_url,
                        prompt: response.data.prompt,
                        negative_prompt: response.data.negative_prompt,
                        scene_analysis: response.data.scene_analysis,
                        character_ref: response.data.character_ref,
                        mode: 'variation',
                        is_favorite: false,
                        favorite_id: null
                    };

                    this.messages.push({
                        id: Date.now(),
                        role: 'assistant',
                        speaker: 'Visual System',
                        content: '',
                        snapshot: newSnapshot,
                        showDetails: false,
                        favoriteMenuVisible: false
                    });

                    console.log('[SNAPSHOT] Regenerated with variation mode:', response.data);

                } catch (e) {
                    console.error('[SNAPSHOT] Regeneration error:', e);
                    alert('Failed to regenerate snapshot: ' + e.message);
                } finally {
                    this.isGeneratingSnapshot = false;
                }
            },

            extractTags(prompt) {
                if (!prompt) return [];
                return prompt.split(',')
                    .map(tag => tag.trim())
                    .filter(tag => tag.length > 0);
            }
        };
    }


</script>

<!-- Alpine.js loads AFTER chatUI is defined -->
<script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

</body>

</html>